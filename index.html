<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>Gestor de Gastos - Proyectos</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Debugging CSS -->
    <style>
        .debug-mode .debug-info {
            display: block !important;
        }
        .debug-info {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 5px;
            z-index: 9999;
            font-size: 10px;
            max-width: 200px;
            word-wrap: break-word;
        }
        
        /* Touch-friendly buttons */
        .btn-touch {
            min-height: 48px;
            min-width: 48px;
            padding: 12px 24px;
            font-size: 16px;
        }
        
        /* Loading states */
        .btn-loading {
            position: relative;
            pointer-events: none;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: currentColor;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Responsive text */
        @media (max-width: 640px) {
            .text-responsive {
                font-size: 14px;
            }
            
            .title-responsive {
                font-size: 20px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Debug Panel -->
    <div class="debug-info" id="debugPanel">
        <strong>DEBUG:</strong><br>
        <span id="debugContent">Sistema iniciado</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-700">Cargando...</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="min-h-screen">
        <!-- Navigation Bar -->
        <nav id="navbar" class="bg-blue-600 text-white p-4 shadow-lg hidden">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="title-responsive font-bold">Gestor de Gastos</h1>
                    <p class="text-blue-200 text-sm" id="userInfo">Bienvenido</p>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm bg-blue-500 px-2 py-1 rounded" id="saldoInfo">Saldo: $0.00</span>
                    <button id="logoutBtn" class="btn-touch bg-blue-700 hover:bg-blue-800 px-3 py-2 rounded">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <main id="mainContent" class="pb-20">
            <!-- Login Screen -->
            <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
                <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                    <div class="text-center mb-8">
                        <i class="fas fa-receipt text-4xl text-blue-600 mb-4"></i>
                        <h1 class="title-responsive font-bold text-gray-800">Gestor de Gastos</h1>
                        <p class="text-gray-600 text-responsive">Administra tus proyectos</p>
                    </div>
                    
                    <form id="loginForm" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Email:</label>
                            <input type="email" id="loginEmail" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base"
                                   placeholder="tu@email.com" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Contraseña:</label>
                            <input type="password" id="loginPassword" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base"
                                   placeholder="Tu contraseña" required>
                        </div>
                        
                        <button type="submit" id="loginSubmit" 
                                class="btn-touch w-full bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                            Iniciar Sesión
                        </button>
                    </form>
                    
                    <div class="mt-6 text-center">
                        <button id="showRegisterBtn" class="text-blue-600 hover:text-blue-800 text-sm">
                            ¿No tienes cuenta? Regístrate
                        </button>
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-600 mb-2">Credenciales:</p>
                            <p class="text-xs"><strong>Admin:</strong> ramon.rivas@me.com / admin123</p>
                            <p class="text-xs"><strong>Demo Admin:</strong> admin@sistema.com / admin123</p>
                            <p class="text-xs"><strong>Usuario:</strong> maria@empresa.com / user123</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Register Screen -->
            <div id="registerScreen" class="min-h-screen flex items-center justify-center p-4 hidden">
                <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                    <div class="text-center mb-6">
                        <h2 class="title-responsive font-bold text-gray-800">Registro</h2>
                        <p class="text-gray-600 text-responsive">Solicita tu cuenta</p>
                    </div>
                    
                    <form id="registerForm" class="space-y-4">
                        <input type="text" id="regName" placeholder="Nombre completo" 
                               class="w-full px-4 py-3 border rounded-lg text-base" required>
                        <input type="email" id="regEmail" placeholder="Email" 
                               class="w-full px-4 py-3 border rounded-lg text-base" required>
                        <input type="password" id="regPassword" placeholder="Contraseña" 
                               class="w-full px-4 py-3 border rounded-lg text-base" required>
                        
                        <button type="submit" class="btn-touch w-full bg-green-600 hover:bg-green-700 text-white rounded-lg">
                            Solicitar Registro
                        </button>
                    </form>
                    
                    <button id="backToLoginBtn" class="mt-4 w-full text-blue-600 hover:text-blue-800 text-sm">
                        Volver al Login
                    </button>
                </div>
            </div>

            <!-- Botón de debugging temporal -->
            <div id="debugResetBtn" class="fixed bottom-4 left-4 z-50">
                <button onclick="window.auth?.forceDataReset()" class="bg-red-600 text-white text-xs px-3 py-2 rounded shadow-lg hover:bg-red-700">
                    🔧 Reset Data
                </button>
            </div>

            <!-- Debug Info Panel -->
            <div id="debugLoginInfo" class="fixed bottom-4 right-4 bg-black bg-opacity-80 text-white text-xs p-3 rounded max-w-xs hidden">
                <div><strong>Debug Info:</strong></div>
                <div id="debugUsersCount">Users: Loading...</div>
                <div id="debugStorageStatus">Storage: Loading...</div>
                <button onclick="this.parentElement.classList.add('hidden')" class="text-red-300 hover:text-red-100 float-right">×</button>
            </div>

            <!-- Mostrar debug info -->
            <div class="fixed top-4 right-4 z-40">
                <button onclick="window.showDebugInfo()" class="bg-gray-800 text-white text-xs px-2 py-1 rounded">
                    Debug
                </button>
            </div>
        </main>

        <!-- Script para debugging -->
        <script>
            window.showDebugInfo = function() {
                const debugPanel = document.getElementById('debugLoginInfo');
                const usersCount = document.getElementById('debugUsersCount');
                const storageStatus = document.getElementById('debugStorageStatus');
                
                try {
                    const users = JSON.parse(localStorage.getItem('table_users') || '[]');
                    const activeAdmins = users.filter(u => u.role === 'admin' && u.status === 'active');
                    
                    usersCount.textContent = `Users: ${users.length} (${activeAdmins.length} active admins)`;
                    storageStatus.textContent = `Storage: ${localStorage.length} items`;
                    
                    debugPanel.classList.remove('hidden');
                    
                    console.log('Debug Info:', {
                        totalUsers: users.length,
                        activeAdmins: activeAdmins.length,
                        users: users,
                        localStorage: Object.keys(localStorage)
                    });
                    
                } catch (error) {
                    storageStatus.textContent = `Storage Error: ${error.message}`;
                    debugPanel.classList.remove('hidden');
                }
            }
        </script>
                </div>
            </div>

            <!-- Dashboard Screen -->
            <div id="dashboardScreen" class="hidden">
                <div class="p-4">
                    <!-- Project Selection -->
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Seleccionar Proyecto</h2>
                        <select id="projectSelect" class="w-full px-4 py-3 border rounded-lg text-base mb-4">
                            <option value="">Cargando proyectos...</option>
                        </select>
                        
                        <!-- Admin Only: Create Project Button -->
                        <div id="adminControls" class="hidden">
                            <button id="createProjectBtn" class="btn-touch bg-green-600 hover:bg-green-700 text-white rounded-lg w-full mb-4">
                                <i class="fas fa-plus mr-2"></i> Crear Nuevo Proyecto
                            </button>
                        </div>
                    </div>

                    <!-- Project Actions (visible when project selected) -->
                    <div id="projectActions" class="hidden space-y-4">
                        <!-- Quick Actions -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button id="addExpenseBtn" class="btn-touch bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                                <i class="fas fa-camera mr-2"></i> Registrar Gasto
                            </button>
                            <button id="viewReportsBtn" class="btn-touch bg-purple-600 hover:bg-purple-700 text-white rounded-lg">
                                <i class="fas fa-chart-bar mr-2"></i> Ver Reportes
                            </button>
                        </div>

                        <!-- Current Balance -->
                        <div class="bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg p-6">
                            <h3 class="text-lg font-bold mb-2">Saldo Actual</h3>
                            <div class="text-3xl font-bold" id="currentBalance">$0.00</div>
                            <p class="text-sm opacity-90 mt-2">Presupuesto + Depósitos - Gastos</p>
                        </div>

                        <!-- Recent Expenses -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Gastos Recientes</h3>
                            <div id="recentExpenses" class="space-y-3">
                                <p class="text-gray-500 text-center">No hay gastos registrados</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation (Mobile) -->
        <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t hidden">
            <div class="flex justify-around py-2">
                <button class="nav-btn flex flex-col items-center p-3 text-blue-600" data-screen="dashboard">
                    <i class="fas fa-home text-xl"></i>
                    <span class="text-xs mt-1">Inicio</span>
                </button>
                <button class="nav-btn flex flex-col items-center p-3 text-gray-400" data-screen="expenses">
                    <i class="fas fa-receipt text-xl"></i>
                    <span class="text-xs mt-1">Gastos</span>
                </button>
                <button class="nav-btn flex flex-col items-center p-3 text-gray-400" data-screen="reports">
                    <i class="fas fa-chart-line text-xl"></i>
                    <span class="text-xs mt-1">Reportes</span>
                </button>
                <button class="nav-btn flex flex-col items-center p-3 text-gray-400" data-screen="settings">
                    <i class="fas fa-cog text-xl"></i>
                    <span class="text-xs mt-1">Config</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Create Project Modal -->
    <div id="createProjectModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Crear Proyecto</h2>
                <button id="closeProjectModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="createProjectForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Proyecto:</label>
                    <input type="text" id="projectName" required
                           class="w-full px-4 py-3 border rounded-lg text-base"
                           placeholder="Ej: Proyecto Alpha">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripción:</label>
                    <textarea id="projectDescription" rows="3"
                              class="w-full px-4 py-3 border rounded-lg text-base"
                              placeholder="Descripción del proyecto"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Presupuesto Inicial:</label>
                    <input type="number" id="projectBudget" step="0.01" min="0" required
                           class="w-full px-4 py-3 border rounded-lg text-base"
                           placeholder="0.00">
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelProjectBtn" 
                            class="btn-touch flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg">
                        Cancelar
                    </button>
                    <button type="submit" id="saveProjectBtn"
                            class="btn-touch flex-1 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                        Crear Proyecto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- OpenCV.js y Tesseract.js -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady();"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <!-- Scripts -->
    <script src="js/debug.js"></script>
    <script src="js/database.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/projects.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/smart-scanner.js"></script>
    <script src="js/ocr.js"></script>
    <script src="js/expenses.js"></script>
    <script src="js/reports.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        // Callback cuando OpenCV esté listo
        function onOpenCvReady() {
            console.log('OpenCV.js loaded successfully');
            try {
                if (window.smartScanner) {
                    window.smartScanner.onOpenCvReady();
                } else {
                    console.warn('SmartScanner not yet available, will retry...');
                    // Reintentar después de que todos los scripts carguen
                    setTimeout(() => {
                        if (window.smartScanner) {
                            window.smartScanner.onOpenCvReady();
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('Error initializing OpenCV:', error);
            }
        }

        // Fallback si OpenCV no carga en 10 segundos
        setTimeout(() => {
            if (typeof cv === 'undefined') {
                console.warn('OpenCV failed to load within 10 seconds - app will use fallback mode');
            }
        }, 10000);
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW registered', reg))
                .catch(err => console.log('SW registration failed', err));
        }
    </script>
</body>
</html>
