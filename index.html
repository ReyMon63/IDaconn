<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>Gestor de Gastos - Proyectos</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Debugging CSS -->
    <style>
        .debug-mode .debug-info {
            display: block !important;
        }
        .debug-info {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 5px;
            z-index: 9999;
            font-size: 10px;
            max-width: 200px;
            word-wrap: break-word;
        }
        
        /* Touch-friendly buttons */
        .btn-touch {
            min-height: 48px;
            min-width: 48px;
            padding: 12px 24px;
            font-size: 16px;
        }
        
        /* Loading states */
        .btn-loading {
            position: relative;
            pointer-events: none;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: currentColor;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Responsive text */
        @media (max-width: 640px) {
            .text-responsive {
                font-size: 14px;
            }
            
            .title-responsive {
                font-size: 20px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Debug Panel -->
    <div class="debug-info" id="debugPanel">
        <strong>DEBUG:</strong><br>
        <span id="debugContent">Sistema iniciado</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-700">Cargando...</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="min-h-screen">
        <!-- Navigation Bar -->
        <nav id="navbar" class="bg-blue-600 text-white p-4 shadow-lg hidden">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="title-responsive font-bold">Gestor de Gastos</h1>
                    <p class="text-blue-200 text-sm" id="userInfo">Bienvenido</p>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm bg-blue-500 px-2 py-1 rounded" id="saldoInfo">Saldo: $0.00</span>
                    <button id="logoutBtn" class="btn-touch bg-blue-700 hover:bg-blue-800 px-3 py-2 rounded">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <main id="mainContent" class="pb-20">
            <!-- Login Screen -->
            <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
                <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                    <div class="text-center mb-8">
                        <i class="fas fa-receipt text-4xl text-blue-600 mb-4"></i>
                        <h1 class="title-responsive font-bold text-gray-800">Gestor de Gastos</h1>
                        <p class="text-gray-600 text-responsive">Administra tus proyectos</p>
                    </div>
                    
                    <form id="loginForm" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Email:</label>
                            <input type="email" id="loginEmail" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base"
                                   placeholder="tu@email.com" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Contrase帽a:</label>
                            <input type="password" id="loginPassword" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base"
                                   placeholder="Tu contrase帽a" required>
                        </div>
                        
                        <button type="submit" id="loginSubmit" 
                                class="btn-touch w-full bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                            Iniciar Sesi贸n
                        </button>
                    </form>
                    
                    <div class="mt-6 text-center">
                        <button id="showRegisterBtn" class="text-blue-600 hover:text-blue-800 text-sm">
                            驴No tienes cuenta? Reg铆strate
                        </button>
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-600 mb-2">Credenciales:</p>
                            <p class="text-xs"><strong>Admin:</strong> ramon.rivas@me.com / admin123</p>
                            <p class="text-xs"><strong>Demo Admin:</strong> admin@sistema.com / admin123</p>
                            <p class="text-xs"><strong>Usuario:</strong> maria@empresa.com / user123</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Register Screen -->
            <div id="registerScreen" class="min-h-screen flex items-center justify-center p-4 hidden">
                <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                    <div class="text-center mb-6">
                        <h2 class="title-responsive font-bold text-gray-800">Registro</h2>
                        <p class="text-gray-600 text-responsive">Solicita tu cuenta</p>
                    </div>
                    
                    <form id="registerForm" class="space-y-4">
                        <input type="text" id="regName" placeholder="Nombre completo" 
                               class="w-full px-4 py-3 border rounded-lg text-base" required>
                        <input type="email" id="regEmail" placeholder="Email" 
                               class="w-full px-4 py-3 border rounded-lg text-base" required>
                        <input type="password" id="regPassword" placeholder="Contrase帽a" 
                               class="w-full px-4 py-3 border rounded-lg text-base" required>
                        
                        <button type="submit" class="btn-touch w-full bg-green-600 hover:bg-green-700 text-white rounded-lg">
                            Solicitar Registro
                        </button>
                    </form>
                    
                    <button id="backToLoginBtn" class="mt-4 w-full text-blue-600 hover:text-blue-800 text-sm">
                        Volver al Login
                    </button>
                </div>
            </div>

            <!-- Bot贸n de debugging temporal -->
            <div id="debugResetBtn" class="fixed bottom-4 left-4 z-50">
                <button onclick="window.auth?.forceDataReset()" class="bg-red-600 text-white text-xs px-3 py-2 rounded shadow-lg hover:bg-red-700">
                     Reset Data
                </button>
            </div>

            <!-- Debug Info Panel -->
            <div id="debugLoginInfo" class="fixed bottom-4 right-4 bg-black bg-opacity-80 text-white text-xs p-3 rounded max-w-xs hidden">
                <div><strong>Debug Info:</strong></div>
                <div id="debugUsersCount">Users: Loading...</div>
                <div id="debugStorageStatus">Storage: Loading...</div>
                <button onclick="this.parentElement.classList.add('hidden')" class="text-red-300 hover:text-red-100 float-right"></button>
            </div>

            <!-- Mostrar debug info -->
            <div class="fixed top-4 right-4 z-40">
                <button onclick="window.showDebugInfo()" class="bg-gray-800 text-white text-xs px-2 py-1 rounded">
                    Debug
                </button>
            </div>
        </main>

        <!-- Script para debugging -->
        <script>
            window.showDebugInfo = function() {
                const debugPanel = document.getElementById('debugLoginInfo');
                const usersCount = document.getElementById('debugUsersCount');
                const storageStatus = document.getElementById('debugStorageStatus');
                
                try {
                    const users = JSON.parse(localStorage.getItem('table_users') || '[]');
                    const activeAdmins = users.filter(u => u.role === 'admin' && u.status === 'active');
                    
                    usersCount.textContent = `Users: ${users.length} (${activeAdmins.length} active admins)`;
                    storageStatus.textContent = `Storage: ${localStorage.length} items`;
                    
                    debugPanel.classList.remove('hidden');
                    
                    console.log('Debug Info:', {
                        totalUsers: users.length,
                        activeAdmins: activeAdmins.length,
                        users: users,
                        localStorage: Object.keys(localStorage)
                    });
                    
                } catch (error) {
                    storageStatus.textContent = `Storage Error: ${error.message}`;
                    debugPanel.classList.remove('hidden');
                }
            }
        </script>
                </div>
            </div>

            <!-- Dashboard Screen -->
            <div id="dashboardScreen" class="hidden">
                <div class="p-4 space-y-4">
                    
                    <!-- Project Selection Card -->
                    <div class="bg-white rounded-lg shadow-lg p-4">
                        <h2 class="text-lg font-bold text-gray-800 mb-3">
                            <i class="fas fa-folder-open mr-2 text-blue-600"></i>Proyecto Activo
                        </h2>
                        <select id="headerProjectSelect" class="w-full px-4 py-3 border rounded-lg text-base bg-gray-50">
                            <option value="">Seleccionar proyecto...</option>
                        </select>
                    </div>

                    <!-- Quick Actions Card -->
                    <div id="quickActionsCard" class="hidden bg-white rounded-lg shadow-lg p-4">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-bolt mr-2 text-yellow-500"></i>Acciones R谩pidas
                        </h2>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="addExpenseBtn" class="btn-touch bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-xl p-4 text-center">
                                <i class="fas fa-receipt text-2xl mb-2 block"></i>
                                <span class="text-sm font-medium">Registrar Gasto</span>
                            </button>
                            <button id="viewReportsBtn" class="btn-touch bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white rounded-xl p-4 text-center">
                                <i class="fas fa-chart-bar text-2xl mb-2 block"></i>
                                <span class="text-sm font-medium">Ver Reportes</span>
                            </button>
                        </div>
                    </div>

                    <!-- Current Balance Card -->
                    <div id="balanceCard" class="hidden bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg shadow-lg p-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-bold">
                                <i class="fas fa-wallet mr-2"></i>Saldo Actual
                            </h3>
                            <i class="fas fa-dollar-sign text-2xl opacity-70"></i>
                        </div>
                        <div class="text-4xl font-bold mb-2" id="currentBalance">$0.00</div>
                        <p class="text-sm opacity-90">Presupuesto + Dep贸sitos - Gastos</p>
                    </div>

                    <!-- Recent Expenses Card -->
                    <div id="recentCard" class="hidden bg-white rounded-lg shadow-lg p-4">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-history mr-2 text-gray-600"></i>Gastos Recientes
                        </h3>
                        <div id="recentExpenses" class="space-y-3">
                            <p class="text-gray-500 text-center py-4">No hay gastos registrados</p>
                        </div>
                    </div>

                    <!-- Admin Controls Card -->
                    <div id="adminControls" class="hidden bg-white rounded-lg shadow-lg p-4">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-cog mr-2 text-gray-600"></i>Administraci贸n
                        </h2>
                        <button id="createProjectBtn" class="btn-touch bg-green-600 hover:bg-green-700 text-white rounded-lg w-full p-3">
                            <i class="fas fa-plus mr-2"></i> Crear Nuevo Proyecto
                        </button>
                    </div>

                </div>
            </div>
        </main>

        <!-- Bottom Navigation (Mobile) -->
        <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t hidden">
            <div class="flex justify-around py-2">
                <button class="nav-btn flex flex-col items-center p-3 text-blue-600" data-screen="dashboard">
                    <i class="fas fa-home text-xl"></i>
                    <span class="text-xs mt-1">Inicio</span>
                </button>
                <button class="nav-btn flex flex-col items-center p-3 text-gray-400" data-screen="expenses">
                    <i class="fas fa-receipt text-xl"></i>
                    <span class="text-xs mt-1">Gastos</span>
                </button>
                <button class="nav-btn flex flex-col items-center p-3 text-gray-400" data-screen="reports">
                    <i class="fas fa-chart-line text-xl"></i>
                    <span class="text-xs mt-1">Reportes</span>
                </button>
                <button class="nav-btn flex flex-col items-center p-3 text-gray-400" data-screen="settings">
                    <i class="fas fa-cog text-xl"></i>
                    <span class="text-xs mt-1">Config</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Create Project Modal -->
    <div id="createProjectModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Crear Proyecto</h2>
                <button id="closeProjectModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="createProjectForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Proyecto:</label>
                    <input type="text" id="projectName" required
                           class="w-full px-4 py-3 border rounded-lg text-base"
                           placeholder="Ej: Proyecto Alpha">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripci贸n:</label>
                    <textarea id="projectDescription" rows="3"
                              class="w-full px-4 py-3 border rounded-lg text-base"
                              placeholder="Descripci贸n del proyecto"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Presupuesto Inicial:</label>
                    <input type="number" id="projectBudget" step="0.01" min="0" required
                           class="w-full px-4 py-3 border rounded-lg text-base"
                           placeholder="0.00">
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelProjectBtn" 
                            class="btn-touch flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg">
                        Cancelar
                    </button>
                    <button type="submit" id="saveProjectBtn"
                            class="btn-touch flex-1 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                        Crear Proyecto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Selecci贸n de Tipo de Comprobante -->
    <div id="expenseTypeModal" class="modal">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Tipo de Comprobante</h2>
                <button id="closeExpenseTypeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- Factura -->
                <button id="expenseTypeFactura" class="w-full p-4 bg-green-50 hover:bg-green-100 border border-green-200 rounded-lg text-left transition-colors">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-file-invoice text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800">Factura</h3>
                            <p class="text-sm text-gray-600">Subir XML + PDF</p>
                        </div>
                    </div>
                </button>

                <!-- Ticket -->
                <button id="expenseTypeTicket" class="w-full p-4 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg text-left transition-colors">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-camera text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800">Ticket</h3>
                            <p class="text-sm text-gray-600">Foto + IA autom谩tica</p>
                        </div>
                    </div>
                </button>

                <!-- Sin Comprobante -->
                <button id="expenseTypeManual" class="w-full p-4 bg-orange-50 hover:bg-orange-100 border border-orange-200 rounded-lg text-left transition-colors">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-orange-600 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-edit text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800">Sin Comprobante</h3>
                            <p class="text-sm text-gray-600">Captura manual</p>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Factura (XML + PDF) -->
    <div id="facturaModal" class="modal">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Registrar Factura</h2>
                <button id="closeFacturaModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="facturaForm" class="space-y-4">
                <!-- Archivo XML -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Archivo XML <span class="text-red-500">*</span>
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                        <input type="file" id="xmlFile" accept=".xml" class="hidden">
                        <button type="button" onclick="document.getElementById('xmlFile').click()" 
                                class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-upload text-2xl mb-2"></i>
                            <p>Seleccionar XML</p>
                        </button>
                        <div id="xmlFileName" class="text-sm text-gray-600 mt-2 hidden"></div>
                    </div>
                </div>

                <!-- Archivo PDF -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Archivo PDF <span class="text-red-500">*</span>
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                        <input type="file" id="pdfFile" accept=".pdf" class="hidden">
                        <button type="button" onclick="document.getElementById('pdfFile').click()" 
                                class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-file-pdf text-2xl mb-2"></i>
                            <p>Seleccionar PDF</p>
                        </button>
                        <div id="pdfFileName" class="text-sm text-gray-600 mt-2 hidden"></div>
                    </div>
                </div>

                <!-- Categor铆a -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Categor铆a:</label>
                    <select id="facturaCategory" class="w-full px-4 py-3 border rounded-lg text-base" required>
                        <option value="">Seleccionar categor铆a...</option>
                        <option value="Producci贸n">Producci贸n</option>
                        <option value="Comercial">Comercial</option>
                        <option value="Administraci贸n">Administraci贸n</option>
                    </select>
                </div>

                <!-- Botones -->
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelFacturaBtn" 
                            class="btn-touch flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg">
                        Cancelar
                    </button>
                    <button type="submit" id="saveFacturaBtn"
                            class="btn-touch flex-1 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                        Guardar Factura
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Ticket (C谩mara + IA) -->
    <div id="ticketModal" class="modal">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Registrar Ticket</h2>
                <button id="closeTicketModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Captura de Foto -->
            <div id="ticketCameraSection" class="mb-6">
                <h3 class="text-lg font-medium mb-3">1. Capturar Ticket</h3>
                
                <div id="ticketCameraContainer" class="relative bg-gray-100 rounded-lg overflow-hidden mb-4" style="height: 300px;">
                    <video id="ticketVideo" class="w-full h-full object-cover hidden" autoplay playsinline></video>
                    <canvas id="ticketCanvas" class="w-full h-full object-cover hidden"></canvas>
                    
                    <!-- Placeholder -->
                    <div id="ticketPlaceholder" class="w-full h-full flex items-center justify-center text-gray-500">
                        <div class="text-center">
                            <i class="fas fa-camera text-4xl mb-2"></i>
                            <p class="text-sm">Presiona "Iniciar C谩mara"</p>
                        </div>
                    </div>
                    
                    <!-- Camera overlay -->
                    <div class="absolute inset-4 border-2 border-dashed border-blue-400 rounded-lg pointer-events-none"></div>
                </div>

                <!-- Camera Controls -->
                <div id="ticketCameraControls" class="grid grid-cols-2 gap-2 mb-4">
                    <button id="startTicketCamera" class="btn-touch bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                        <i class="fas fa-camera mr-2"></i>Usar C谩mara
                    </button>
                    <button id="uploadTicketPhoto" class="btn-touch bg-green-600 hover:bg-green-700 text-white rounded-lg">
                        <i class="fas fa-upload mr-2"></i>Subir Foto
                    </button>
                </div>
                
                <!-- File input hidden -->
                <input type="file" id="ticketFileInput" accept="image/*" class="hidden">

                <div id="ticketActiveControls" class="hidden grid grid-cols-2 gap-2 mb-4">
                    <button id="captureTicketPhoto" class="btn-touch bg-green-600 hover:bg-green-700 text-white rounded-lg">
                        <i class="fas fa-camera-retro mr-2"></i>Capturar
                    </button>
                    <button id="switchTicketCamera" class="btn-touch bg-gray-600 hover:bg-gray-700 text-white rounded-lg">
                        <i class="fas fa-sync-alt mr-2"></i>Cambiar
                    </button>
                </div>

                <div id="ticketRetakeControls" class="hidden grid grid-cols-2 gap-2 mb-4">
                    <button id="retakeTicketPhoto" class="btn-touch bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg">
                        <i class="fas fa-redo mr-2"></i>Repetir
                    </button>
                    <button id="processTicketOCR" class="btn-touch bg-purple-600 hover:bg-purple-700 text-white rounded-lg">
                        <i class="fas fa-magic mr-2"></i>Analizar con IA
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="ticketResultsSection" class="hidden">
                <h3 class="text-lg font-medium mb-3">2.  IA Detect贸:</h3>
                
                <!-- Smart Amount Suggestions -->
                <div id="ticketAmountSuggestions" class="hidden mb-4 space-y-2">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-blue-800"> IA Sugiere:</span>
                            <span id="ticketAiConfidence" class="text-xs text-blue-600">95%</span>
                        </div>
                        <button type="button" id="ticketSuggestedAmount" 
                                class="w-full text-left p-2 bg-white border border-blue-300 rounded hover:bg-blue-50 transition-colors">
                            <span class="text-lg font-bold text-blue-900">$0.00</span>
                        </button>
                    </div>
                    
                    <!-- Alternativas -->
                    <div id="ticketAlternativeAmounts" class="hidden">
                        <div class="text-xs text-gray-600 mb-1">Otras opciones detectadas:</div>
                        <div id="ticketAlternatives" class="grid grid-cols-2 gap-1"></div>
                    </div>
                    
                    <button type="button" id="showTicketAlternatives" 
                            class="text-xs text-blue-600 hover:text-blue-800 underline">
                        Ver m谩s opciones detectadas
                    </button>
                </div>

                <form id="ticketForm" class="space-y-4">
                    <!-- Categor铆a -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Categor铆a:</label>
                        <select id="ticketCategory" class="w-full px-4 py-3 border rounded-lg text-base" required>
                            <option value="">Seleccionar categor铆a...</option>
                            <option value="Producci贸n">Producci贸n</option>
                            <option value="Comercial">Comercial</option>
                            <option value="Administraci贸n">Administraci贸n</option>
                        </select>
                    </div>

                    <!-- Monto -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Monto (MXN):</label>
                        <input type="number" id="ticketAmount" step="0.01" min="0" 
                               class="w-full px-4 py-3 border rounded-lg text-base" 
                               placeholder="0.00" required>
                        <div class="text-xs text-gray-500 mt-1">
                             Editado autom谩ticamente por IA - puedes corregir
                        </div>
                    </div>

                    <!-- Descripci贸n -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descripci贸n:</label>
                        <textarea id="ticketDescription" rows="2"
                                  class="w-full px-4 py-3 border rounded-lg text-base"
                                  placeholder="Descripci贸n del gasto (opcional)"></textarea>
                    </div>

                    <!-- Botones -->
                    <div class="flex gap-3 pt-4">
                        <button type="button" id="cancelTicketBtn" 
                                class="btn-touch flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg">
                            Cancelar
                        </button>
                        <button type="submit" id="saveTicketBtn"
                                class="btn-touch flex-1 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                            Guardar Ticket
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Sin Comprobante (Manual) -->
    <div id="manualModal" class="modal">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Registro Manual</h2>
                <button id="closeManualModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="manualForm" class="space-y-4">
                <!-- Fecha -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Fecha <span class="text-red-500">*</span>
                    </label>
                    <input type="date" id="manualDate" 
                           class="w-full px-4 py-3 border rounded-lg text-base" required>
                </div>

                <!-- Monto -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Monto (MXN) <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="manualAmount" step="0.01" min="0" 
                           class="w-full px-4 py-3 border rounded-lg text-base" 
                           placeholder="0.00" required>
                </div>

                <!-- Concepto -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Concepto <span class="text-red-500">*</span>
                    </label>
                    <textarea id="manualConcept" rows="3"
                              class="w-full px-4 py-3 border rounded-lg text-base"
                              placeholder="Describe el gasto..." required></textarea>
                </div>

                <!-- Categor铆a -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Categor铆a:</label>
                    <select id="manualCategory" class="w-full px-4 py-3 border rounded-lg text-base" required>
                        <option value="">Seleccionar categor铆a...</option>
                        <option value="Producci贸n">Producci贸n</option>
                        <option value="Comercial">Comercial</option>
                        <option value="Administraci贸n">Administraci贸n</option>
                    </select>
                </div>

                <!-- Botones -->
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelManualBtn" 
                            class="btn-touch flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg">
                        Cancelar
                    </button>
                    <button type="submit" id="saveManualBtn"
                            class="btn-touch flex-1 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                        Guardar Gasto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Smart Amount Detection incluido directamente (para evitar problemas de carga en m贸vil)
        if (typeof debug === 'undefined') {
            window.debug = {
                log: (...args) => console.log('[SmartAmountDetector]', ...args),
                error: (...args) => console.error('[SmartAmountDetector]', ...args),
                warn: (...args) => console.warn('[SmartAmountDetector]', ...args)
            };
        }

        class SmartAmountDetector {
            constructor() {
                this.patterns = {
                    contextKeywords: [
                        { words: ['total', 'suma', 'importe'], weight: 10, radius: 80 },
                        { words: ['subtotal', 'neto'], weight: 8, radius: 60 },
                        { words: ['pagar', 'cobrar', 'precio'], weight: 7, radius: 50 },
                        { words: ['cambio', 'devolucion'], weight: -5, radius: 40 },
                        { words: ['iva', 'impuesto', 'tax'], weight: 3, radius: 30 },
                        { words: ['descuento', 'ahorro'], weight: 2, radius: 40 }
                    ],
                    
                    amountPatterns: [
                        /\$\s*([0-9]{1,3}(?:[,]\d{3})*(?:\.\d{2})?)/g,
                        /([0-9]{1,3}(?:[,]\d{3})*(?:\.\d{2})?)\s*pesos/gi,
                        /([0-9]{1,3}(?:[,]\d{3})*(?:\.\d{2})?)\s*MXN/gi,
                        /total\s*:?\s*\$?\s*([0-9]{1,3}(?:[,]\d{3})*(?:\.\d{2})?)/gi,
                        /suma\s*:?\s*\$?\s*([0-9]{1,3}(?:[,]\d{3})*(?:\.\d{2})?)/gi,
                        /([0-9]{1,3}(?:[,]\d{3})*\.\d{2})/g
                    ]
                };
                
                debug.log('SmartAmountDetector initialized');
            }

            analyzeAmounts(ocrText, ocrConfidence = 0.8) {
                if (!ocrText || ocrText.trim().length === 0) {
                    return { suggested: null, alternatives: [], confidence: 0, analysis: 'No hay texto para analizar' };
                }

                debug.log('Starting smart amount analysis');

                try {
                    const rawAmounts = this.extractAllAmounts(ocrText);
                    
                    if (rawAmounts.length === 0) {
                        return { suggested: null, alternatives: [], confidence: 0, analysis: 'No se encontraron montos en el texto' };
                    }

                    const analyzedAmounts = rawAmounts.map(amount => 
                        this.analyzeAmountContext(amount, ocrText)
                    );

                    const scoredAmounts = this.calculateScores(analyzedAmounts, ocrText);
                    const suggested = scoredAmounts[0];
                    const alternatives = scoredAmounts.slice(1, 5);
                    const confidence = Math.min(0.95, ocrConfidence * 0.8 + (suggested.totalScore / 30) * 0.2);
                    
                    debug.log('Smart analysis complete', {
                        suggested: suggested.value,
                        confidence: confidence,
                        totalAmounts: scoredAmounts.length
                    });
                    
                    return {
                        suggested: suggested,
                        alternatives: alternatives,
                        confidence: confidence,
                        analysis: `Monto sugerido: $${suggested.value.toFixed(2)} (Score: ${suggested.totalScore.toFixed(1)})`
                    };

                } catch (error) {
                    debug.error('Error in smart amount analysis:', error);
                    return this.basicAmountFallback(ocrText);
                }
            }

            extractAllAmounts(text) {
                const amounts = [];
                const seen = new Set();
                
                this.patterns.amountPatterns.forEach((pattern, patternIndex) => {
                    const matches = [...text.matchAll(pattern)];
                    
                    matches.forEach(match => {
                        const cleanAmount = match[1] || match[0];
                        const numericValue = parseFloat(cleanAmount.replace(/[,$]/g, ''));
                        
                        if (numericValue > 0 && numericValue < 999999 && !seen.has(numericValue)) {
                            amounts.push({
                                value: numericValue,
                                originalText: match[0],
                                cleanText: cleanAmount,
                                position: match.index,
                                patternType: patternIndex,
                                context: this.extractContext(text, match.index, 100)
                            });
                            seen.add(numericValue);
                        }
                    });
                });
                
                return amounts;
            }

            analyzeAmountContext(amount, fullText) {
                let contextScore = 0;
                let reasoningFactors = [];
                
                const context = amount.context.toLowerCase();
                
                this.patterns.contextKeywords.forEach(keyword => {
                    keyword.words.forEach(word => {
                        if (context.includes(word)) {
                            contextScore += keyword.weight;
                            reasoningFactors.push(`Contexto "${word}" (${keyword.weight > 0 ? '+' : ''}${keyword.weight})`);
                        }
                    });
                });
                
                return {
                    ...amount,
                    contextScore,
                    reasoningFactors
                };
            }

            calculateScores(amounts, fullText) {
                return amounts.map(amount => {
                    let totalScore = amount.contextScore || 0;
                    
                    const textLength = fullText.length;
                    const relativePosition = amount.position / textLength;
                    if (relativePosition > 0.7) totalScore += 3;
                    else if (relativePosition > 0.5) totalScore += 1;
                    
                    if (amount.originalText.includes('$') || amount.originalText.includes('.')) {
                        totalScore += 1;
                    }
                    
                    if (amount.value < 10) totalScore -= 2;
                    if (amount.value > 10000) totalScore -= 1;
                    
                    return {
                        ...amount,
                        totalScore
                    };
                }).sort((a, b) => b.totalScore - a.totalScore);
            }

            extractContext(text, position, radius) {
                const start = Math.max(0, position - radius);
                const end = Math.min(text.length, position + radius);
                return text.substring(start, end);
            }

            basicAmountFallback(text) {
                const amounts = this.extractAllAmounts(text);
                if (amounts.length === 0) {
                    return { suggested: null, alternatives: [], confidence: 0, analysis: 'No se encontraron montos' };
                }
                
                const sorted = amounts.sort((a, b) => b.value - a.value);
                
                return {
                    suggested: {
                        ...sorted[0],
                        totalScore: 5,
                        confidence: 0.6,
                        reasoningFactors: ['Modo b谩sico: Mayor monto encontrado']
                    },
                    alternatives: sorted.slice(1, 4),
                    confidence: 0.6,
                    analysis: 'An谩lisis b谩sico: Se sugiere el monto m谩s grande encontrado'
                };
            }
        }

        // Definir funci贸n onOpenCvReady antes de cargar OpenCV
        function onOpenCvReady() {
            console.log('OpenCV.js loaded successfully');
            try {
                if (window.smartScanner) {
                    window.smartScanner.onOpenCvReady();
                } else {
                    console.warn('SmartScanner not yet available, will retry...');
                    // Reintentar despu茅s de que todos los scripts carguen
                    setTimeout(() => {
                        if (window.smartScanner) {
                            window.smartScanner.onOpenCvReady();
                        } else {
                            console.warn('SmartScanner still not available after retry');
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('Error initializing OpenCV with SmartScanner:', error);
            }
        }

        // Fallback si OpenCV no carga en 10 segundos
        setTimeout(() => {
            if (typeof cv === 'undefined') {
                console.warn('OpenCV failed to load within 10 seconds - app will use fallback mode');
            }
        }, 10000);
    </script>

    <!-- OpenCV.js y Tesseract.js -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady();"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="js/debug.js"></script>
    <script src="js/database.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/projects.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/smart-scanner.js"></script>
    <script src="js/ocr.js"></script>
    <script src="js/smart-amount-detection.js"></script>
    <script src="js/expense-types.js"></script>
    <script src="js/expenses.js"></script>
    <script src="js/reports.js"></script>
    <script src="js/app.js"></script>

    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW registered', reg))
                .catch(err => console.log('SW registration failed', err));
        }
    </script>
</body>
</html>