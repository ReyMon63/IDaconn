<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Scanner Simple - Detecci√≥n de Esquinas</title>
    
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
        }
        
        button {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 25px;
            background: #007AFF;
            color: white;
            cursor: pointer;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        #results {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        #status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .corner-detected {
            color: #00FF00;
        }
        
        .no-corners {
            color: #FF6B35;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- Video Stream -->
        <video id="video" autoplay playsinline></video>
        
        <!-- Canvas para overlay de detecci√≥n -->
        <canvas id="overlay"></canvas>
        
        <!-- Status inicial -->
        <div id="status">
            <div>üì± Scanner de Documentos</div>
            <div style="font-size: 14px; margin-top: 10px;">
                Presiona "Iniciar" para comenzar
            </div>
        </div>
        
        <!-- Controles -->
        <div id="controls">
            <button id="startBtn" onclick="startCamera()">üìπ Iniciar</button>
            <button id="captureBtn" onclick="captureDocument()" style="display: none;">üìÑ Capturar</button>
        </div>
        
        <!-- Resultados del OCR -->
        <div id="results"></div>
    </div>

    <!-- OpenCV.js -->
    <script src="https://docs.opencv.org/4.8.0/opencv.js"></script>
    <!-- Tesseract.js -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <script>
        let video, canvas, ctx;
        let isScanning = false;
        let detectionLoop;
        let stream;

        // Inicializar cuando OpenCV est√© listo
        function onOpenCvReady() {
            console.log('‚úÖ OpenCV listo');
            document.getElementById('status').innerHTML = `
                <div>‚úÖ OpenCV Cargado</div>
                <div style="font-size: 14px; margin-top: 10px;">
                    Presiona "Iniciar" para activar c√°mara
                </div>
            `;
        }

        // Verificar si OpenCV est√° disponible
        function waitForOpenCV() {
            if (typeof cv !== 'undefined') {
                onOpenCvReady();
            } else {
                setTimeout(waitForOpenCV, 100);
            }
        }
        
        // Iniciar despu√©s de cargar la p√°gina
        window.onload = function() {
            video = document.getElementById('video');
            canvas = document.getElementById('overlay');
            ctx = canvas.getContext('2d');
            
            waitForOpenCV();
        };

        // Iniciar c√°mara
        async function startCamera() {
            try {
                console.log('üöÄ Iniciando c√°mara...');
                
                document.getElementById('status').innerHTML = 'üöÄ Activando c√°mara...';

                // Solicitar c√°mara
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    setupCanvas();
                    startDetection();
                    
                    // Cambiar UI
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('captureBtn').style.display = 'block';
                    document.getElementById('status').style.display = 'none';
                };

            } catch (error) {
                console.error('‚ùå Error c√°mara:', error);
                document.getElementById('status').innerHTML = `
                    <div class="no-corners">‚ùå Error de C√°mara</div>
                    <div style="font-size: 12px; margin-top: 10px;">
                        ${error.message}
                    </div>
                    <div style="font-size: 12px; margin-top: 10px;">
                        Aseg√∫rate de dar permisos en Safari
                    </div>
                `;
            }
        }

        // Configurar canvas overlay
        function setupCanvas() {
            const rect = video.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            canvas.style.position = 'absolute';
            canvas.style.top = '0';
            canvas.style.left = '0';
        }

        // Iniciar detecci√≥n de esquinas
        function startDetection() {
            isScanning = true;
            detectCorners();
        }

        // Detectar esquinas en tiempo real
        function detectCorners() {
            if (!isScanning || typeof cv === 'undefined') {
                setTimeout(detectCorners, 100);
                return;
            }

            try {
                // Crear canvas temporal para capturar frame
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = video.videoWidth;
                tempCanvas.height = video.videoHeight;
                tempCtx.drawImage(video, 0, 0);

                // Procesar con OpenCV
                const corners = processFrame(tempCanvas);
                
                // Dibujar overlay
                drawOverlay(corners);
                
            } catch (error) {
                console.log('Detecci√≥n:', error.message);
            }

            // Continuar loop
            setTimeout(detectCorners, 100); // 10 FPS
        }

        // Procesar frame con OpenCV
        function processFrame(canvas) {
            try {
                // Convertir a OpenCV
                let src = cv.imread(canvas);
                let gray = new cv.Mat();
                let blur = new cv.Mat();
                let edges = new cv.Mat();
                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();

                // Procesamiento de imagen
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                cv.GaussianBlur(gray, blur, new cv.Size(5, 5), 0);
                cv.Canny(blur, edges, 50, 150);

                // Encontrar contornos
                cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                // Buscar rect√°ngulo m√°s grande
                let bestCorners = null;
                let maxArea = 5000; // √Årea m√≠nima

                for (let i = 0; i < contours.size(); i++) {
                    let contour = contours.get(i);
                    let area = cv.contourArea(contour);
                    
                    if (area > maxArea) {
                        let peri = cv.arcLength(contour, true);
                        let approx = new cv.Mat();
                        cv.approxPolyDP(contour, approx, 0.02 * peri, true);
                        
                        if (approx.rows === 4) {
                            // Convertir a coordenadas
                            const corners = [];
                            for (let j = 0; j < 4; j++) {
                                corners.push({
                                    x: approx.data32S[j * 2],
                                    y: approx.data32S[j * 2 + 1]
                                });
                            }
                            
                            bestCorners = corners;
                            maxArea = area;
                        }
                        
                        approx.delete();
                    }
                }

                // Limpiar memoria
                src.delete();
                gray.delete();
                blur.delete();
                edges.delete();
                contours.delete();
                hierarchy.delete();

                return bestCorners;

            } catch (error) {
                console.log('OpenCV error:', error);
                return null;
            }
        }

        // Dibujar overlay de esquinas detectadas
        function drawOverlay(corners) {
            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (corners) {
                // Convertir coordenadas de video a canvas
                const scaleX = canvas.width / video.videoWidth;
                const scaleY = canvas.height / video.videoHeight;

                // Dibujar contorno verde
                ctx.strokeStyle = '#00FF00';
                ctx.lineWidth = 3;
                ctx.beginPath();

                corners.forEach((corner, i) => {
                    const x = corner.x * scaleX;
                    const y = corner.y * scaleY;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });

                ctx.closePath();
                ctx.stroke();

                // Dibujar esquinas
                ctx.fillStyle = '#00FF00';
                corners.forEach(corner => {
                    const x = corner.x * scaleX;
                    const y = corner.y * scaleY;
                    ctx.beginPath();
                    ctx.arc(x, y, 8, 0, 2 * Math.PI);
                    ctx.fill();
                });

                // Texto de estado
                ctx.fillStyle = '#00FF00';
                ctx.font = '16px Arial';
                ctx.fillText('üìÑ Documento detectado - Presiona CAPTURAR', 20, 40);

            } else {
                // Sin detecci√≥n - mostrar gu√≠a
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const rectW = canvas.width * 0.7;
                const rectH = canvas.height * 0.5;

                ctx.strokeStyle = 'rgba(255,255,255,0.8)';
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 5]);
                ctx.strokeRect(centerX - rectW/2, centerY - rectH/2, rectW, rectH);
                ctx.setLineDash([]);

                // Texto de b√∫squeda
                ctx.fillStyle = '#FF6B35';
                ctx.font = '16px Arial';
                ctx.fillText('üîç Buscando documento...', 20, 40);
            }
        }

        // Capturar documento detectado
        async function captureDocument() {
            try {
                console.log('üì∏ Capturando documento...');

                // Crear canvas de captura
                const captureCanvas = document.createElement('canvas');
                const captureCtx = captureCanvas.getContext('2d');
                captureCanvas.width = video.videoWidth;
                captureCanvas.height = video.videoHeight;
                captureCtx.drawImage(video, 0, 0);

                // Mostrar resultados iniciales
                document.getElementById('results').style.display = 'block';
                document.getElementById('results').innerHTML = `
                    <div><strong>üì∏ Procesando imagen...</strong></div>
                    <div>üîç Ejecutando OCR...</div>
                `;

                // Ejecutar Tesseract OCR
                if (typeof Tesseract !== 'undefined') {
                    const { data } = await Tesseract.recognize(captureCanvas, 'spa');
                    
                    // Buscar montos en el texto
                    const amounts = extractAmounts(data.text);
                    
                    // Mostrar resultados
                    document.getElementById('results').innerHTML = `
                        <div><strong>üìÑ Texto Detectado:</strong></div>
                        <div style="max-height: 80px; overflow-y: auto; background: #333; padding: 10px; margin: 10px 0; font-size: 12px;">
                            ${data.text || 'No se detect√≥ texto'}
                        </div>
                        <div><strong>üí∞ Montos Encontrados:</strong></div>
                        <div style="color: #00FF00; font-size: 16px;">
                            ${amounts.length > 0 ? amounts.map(a => `$${a}`).join(', ') : 'No se detectaron montos'}
                        </div>
                        <div><strong>üìä Confianza OCR:</strong> ${Math.round(data.confidence)}%</div>
                        <button onclick="document.getElementById('results').style.display='none'" 
                                style="margin-top: 10px; padding: 5px 15px; font-size: 12px;">
                            Cerrar
                        </button>
                    `;
                    
                } else {
                    document.getElementById('results').innerHTML = `
                        <div class="no-corners"><strong>‚ùå Tesseract no disponible</strong></div>
                        <div>OCR no se pudo ejecutar</div>
                    `;
                }

            } catch (error) {
                console.error('‚ùå Error captura:', error);
                document.getElementById('results').innerHTML = `
                    <div class="no-corners"><strong>‚ùå Error en captura</strong></div>
                    <div>${error.message}</div>
                `;
                document.getElementById('results').style.display = 'block';
            }
        }

        // Extraer montos del texto OCR
        function extractAmounts(text) {
            const patterns = [
                /\$\s*(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/g,
                /(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)\s*pesos?/gi,
                /total:?\s*\$?(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/gi,
                /(\d+\.\d{2})/g
            ];
            
            const amounts = [];
            const seen = new Set();
            
            patterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const amount = parseFloat(match[1].replace(',', ''));
                    if (amount > 0 && !seen.has(amount)) {
                        amounts.push(amount);
                        seen.add(amount);
                    }
                }
            });
            
            return amounts.sort((a, b) => b - a); // Mayor a menor
        }

        // Parar c√°mara al salir
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>