<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDACONN - Gestor de Gastos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0, 0, 0, 0.8); 
            z-index: 1000; 
            backdrop-filter: blur(3px);
        }
        .modal.show { 
            display: flex; 
            align-items: flex-start; 
            justify-content: center; 
            padding: 20px;
            overflow-y: auto;
            min-height: 100vh;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            max-height: 90vh;
            overflow-y: auto;
            max-width: 100%;
            position: relative;
            margin: auto 0;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; }
        .notification-badge { 
            animation: pulse 2s infinite; 
            z-index: 10; 
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body class="bg-gray-100 m-0 p-0">

    <!-- Header -->
    <nav id="appHeader" class="bg-blue-600 text-white p-3 hidden">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold">IDACONN - Gestor de Gastos</h1>
                <p class="text-sm opacity-90" id="userInfo">Usuario</p>
            </div>
            <div class="flex items-center gap-2">
                <button id="exportBtn" class="btn bg-green-600 hover:bg-green-700 text-white px-2 py-1 text-sm">
                    <i class="fas fa-download"></i>
                </button>
                <button id="logoutBtn" class="btn bg-blue-700 hover:bg-blue-800 text-white px-3 py-2">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Login Screen -->
    <div id="loginScreen" class="p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-auto">
            <div class="text-center mb-6">
                <img src="https://page.gensparksite.com/v1/base64_upload/b2869f30ba62ebf5b884d127f1705e49" 
                     alt="IDACONN Logo" 
                     class="mx-auto mb-4 h-16 w-auto object-contain">
                <h1 class="text-2xl font-bold text-gray-800">Iniciar Sesi√≥n</h1>
            </div>
            
            <form id="loginForm" class="space-y-3">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Email:</label>
                    <input type="email" id="loginEmail" value="ramon.rivas@me.com"
                           class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                           placeholder="usuario@email.com" required>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Contrase√±a:</label>
                    <input type="password" id="loginPassword" value="admin123"
                           class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                           placeholder="********" required>
                </div>
                <button type="submit" class="btn bg-blue-600 hover:bg-blue-700 text-white w-full">
                    Iniciar Sesi√≥n
                </button>
            </form>
            
            <div class="mt-4 text-center">
                <button id="requestAccessBtn" class="text-sm text-blue-600 hover:text-blue-800 underline">
                    ¬øNo tienes cuenta? Solicitar acceso
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="hidden">
        
        <!-- Project Selection -->
        <div class="bg-white border-b p-3">
            <h2 class="text-lg font-bold text-gray-800 mb-2">Proyecto</h2>
            <select id="projectSelect" class="w-full px-4 py-3 border rounded-lg">
                <option value="">Seleccionar proyecto...</option>
            </select>
        </div>

        <!-- Quick Actions -->
        <div id="actionsCard" class="hidden bg-white border-b p-3">
            <h2 class="text-lg font-bold text-gray-800 mb-2">Acciones</h2>
            <div class="grid grid-cols-2 gap-3">
                <button id="addExpenseBtn" class="btn bg-blue-500 hover:bg-blue-600 text-white p-3 text-center">
                    <i class="fas fa-receipt text-xl block mb-1"></i>
                    <span class="text-sm">Registrar Gasto</span>
                </button>
                <button id="viewReportsBtn" class="btn bg-purple-500 hover:bg-purple-600 text-white p-3 text-center">
                    <i class="fas fa-chart-bar text-xl block mb-1"></i>
                    <span class="text-sm">Ver Reportes</span>
                </button>
            </div>
        </div>

        <!-- Admin Actions -->
        <div id="adminActionsCard" class="hidden bg-gradient-to-r from-orange-500 to-red-500 text-white border-b p-3">
            <h2 class="text-lg font-bold mb-2">üîë Funciones de Administrador</h2>
            <div class="grid grid-cols-3 gap-2">
                <button id="manageProjectsBtn" class="btn bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-2 text-center rounded-lg">
                    <i class="fas fa-project-diagram text-lg block mb-1"></i>
                    <span class="text-xs">Proyectos</span>
                </button>
                <button id="manageRequestsBtn" class="btn bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-2 text-center rounded-lg">
                    <i class="fas fa-user-clock text-lg block mb-1"></i>
                    <span class="text-xs">Solicitudes</span>
                </button>
                <button id="manageUsersBtn" class="btn bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-2 text-center rounded-lg">
                    <i class="fas fa-users text-lg block mb-1"></i>
                    <span class="text-xs">Usuarios</span>
                </button>
            </div>
        </div>

        <!-- Gesti√≥n de Solicitudes (Solo Admin) -->
        <div id="requestsManagementCard" class="hidden bg-white border-b p-3">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-bold text-gray-800">‚è≥ Gesti√≥n de Solicitudes</h2>
                <div class="flex items-center gap-2">
                    <span id="requestsCount" class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-semibold">0 pendientes</span>
                </div>
            </div>
            
            <!-- Solicitudes Pendientes -->
            <div id="pendingRequestsContainer" class="space-y-2 max-h-80 overflow-y-auto">
                <!-- Las solicitudes pendientes aparecer√°n aqu√≠ autom√°ticamente -->
            </div>
        </div>

        <!-- Gesti√≥n de Usuarios Registrados (Solo Admin) -->
        <div id="usersManagementCard" class="hidden bg-white border-b p-3">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-bold text-gray-800">üë• Gesti√≥n de Usuarios</h2>
                <div class="flex items-center gap-2">
                    <span id="usersCount" class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold">0 usuarios</span>
                    <button id="addNewUserBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-plus mr-1"></i>Agregar
                    </button>
                </div>
            </div>
            
            <!-- Lista de Usuarios Registrados -->
            <div id="registeredUsersContainer" class="space-y-2 max-h-80 overflow-y-auto">
                <!-- Los usuarios aparecer√°n aqu√≠ autom√°ticamente -->
            </div>
        </div>

        <!-- Gesti√≥n de Proyectos (Solo Admin) -->
        <div id="projectsManagementCard" class="hidden bg-white border-b p-3">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-bold text-gray-800">üìã Gesti√≥n de Proyectos</h2>
                <div class="flex items-center gap-2">
                    <span id="projectsCount" class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">0 proyectos</span>
                    <button id="addNewProjectBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-plus mr-1"></i>Agregar
                    </button>
                </div>
            </div>
            
            <!-- Lista de Proyectos -->
            <div id="registeredProjectsContainer" class="space-y-2 max-h-80 overflow-y-auto">
                <!-- Los proyectos aparecer√°n aqu√≠ autom√°ticamente -->
            </div>
        </div>

        <!-- Balance -->
        <div id="balanceCard" class="hidden bg-gradient-to-r from-green-500 to-blue-500 text-white border-b p-3">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold">Saldo Disponible</h3>
                <i class="fas fa-wallet text-2xl opacity-70"></i>
            </div>
            <div class="text-3xl font-bold" id="currentBalance">$0.00</div>
            <p class="text-sm opacity-90 mt-1">Presupuesto - Gastos</p>
        </div>

        <!-- Recent Expenses -->
        <div id="expensesCard" class="hidden bg-white p-3">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Gastos Recientes</h3>
            <div id="recentExpenses" class="space-y-2">
                <p class="text-gray-500 text-center py-2">No hay gastos registrados</p>
            </div>
        </div>

    </div>

    <!-- Modal: Expense Type Selection -->
    <div id="expenseTypeModal" class="modal">
        <div class="modal-content p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-6">Tipo de Comprobante</h2>
            
            <div class="space-y-4">
                <button id="typeFactura" class="w-full p-4 bg-green-50 hover:bg-green-100 border border-green-200 rounded-lg text-left">
                    <div class="flex items-center">
                        <i class="fas fa-file-invoice text-2xl text-green-600 mr-4"></i>
                        <div>
                            <h3 class="font-bold">Factura</h3>
                            <p class="text-sm text-gray-600">XML + PDF</p>
                        </div>
                    </div>
                </button>

                <button id="typeTicket" class="w-full p-4 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg text-left">
                    <div class="flex items-center">
                        <i class="fas fa-receipt text-2xl text-blue-600 mr-4"></i>
                        <div>
                            <h3 class="font-bold">Ticket/Recibo</h3>
                            <p class="text-sm text-gray-600">Imagen del ticket</p>
                        </div>
                    </div>
                </button>

                <button id="typeManual" class="w-full p-4 bg-orange-50 hover:bg-orange-100 border border-orange-200 rounded-lg text-left">
                    <div class="flex items-center">
                        <i class="fas fa-edit text-2xl text-orange-600 mr-4"></i>
                        <div>
                            <h3 class="font-bold">Sin Comprobante</h3>
                            <p class="text-sm text-gray-600">Captura manual</p>
                        </div>
                    </div>
                </button>
            </div>

            <button id="closeExpenseTypeModal" class="btn bg-gray-300 hover:bg-gray-400 text-gray-700 w-full mt-6">
                Cancelar
            </button>
        </div>
    </div>

    <!-- Modal: Expense Form -->
    <div id="expenseModal" class="modal">
        <div class="modal-content p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold" id="expenseModalTitle">Registrar Gasto</h2>
                <button id="closeExpenseModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="expenseForm" class="space-y-4">
                <!-- File Upload Section -->
                <div id="fileSection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Archivo:</label>
                    <input type="file" id="fileInput" class="w-full px-3 py-2 border rounded-lg">
                    
                    <!-- Image Preview -->
                    <div id="imagePreview" class="hidden mt-3">
                        <img id="previewImg" class="w-full max-w-xs mx-auto rounded-lg border" />
                        <p class="text-xs text-gray-500 mt-1 text-center">Vista previa del ticket</p>
                    </div>
                </div>

                <!-- Factura Files Section -->
                <div id="facturaFilesSection" class="hidden space-y-4">
                    <!-- XML File (PRIMERO - para extraer datos) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            1. Archivo XML <span class="text-red-500">*</span>
                        </label>
                        <input type="file" id="xmlFileInput" accept=".xml" 
                               class="w-full px-3 py-2 border rounded-lg">
                        <p class="text-xs text-gray-500 mt-1">
                            üìÑ El XML contiene los datos que llenar√°n autom√°ticamente los campos
                        </p>
                        <div id="xmlStatus" class="hidden mt-2 p-2 bg-green-50 border border-green-200 rounded text-sm text-green-800">
                            ‚úÖ XML procesado - Campos llenados autom√°ticamente
                        </div>
                    </div>

                    <!-- PDF File (SEGUNDO) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            2. Archivo PDF <span class="text-red-500">*</span>
                        </label>
                        <input type="file" id="pdfFileInput" accept=".pdf" 
                               class="w-full px-3 py-2 border rounded-lg">
                        <p class="text-xs text-gray-500 mt-1">
                            üìë Representaci√≥n visual de la factura
                        </p>
                        <div id="pdfStatus" class="hidden mt-2 p-2 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800">
                            ‚úÖ PDF cargado correctamente
                        </div>
                    </div>
                </div>

                <!-- Date -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha:</label>
                    <input type="date" id="expenseDate" 
                           class="w-full px-4 py-3 border rounded-lg" required>
                </div>

                <!-- Amount -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Monto (MXN):</label>
                    <input type="number" id="expenseAmount" step="0.01" min="0.01" 
                           class="w-full px-4 py-3 border rounded-lg" 
                           placeholder="0.00" required>
                    <div id="balanceWarning" class="hidden text-red-500 text-sm mt-1">
                        ‚ö†Ô∏è Este monto excede el saldo disponible
                    </div>
                </div>

                <!-- Category -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Categor√≠a:</label>
                    <select id="expenseCategory" class="w-full px-4 py-3 border rounded-lg" required>
                        <option value="">Seleccionar categor√≠a...</option>
                        <option value="Producci√≥n">Producci√≥n</option>
                        <option value="Comercial">Comercial</option>
                        <option value="Administraci√≥n">Administraci√≥n</option>
                    </select>
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Concepto:</label>
                    <textarea id="expenseDescription" rows="3"
                              class="w-full px-4 py-3 border rounded-lg"
                              placeholder="Descripci√≥n del gasto" required></textarea>
                </div>

                <!-- Buttons -->
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelExpenseBtn" 
                            class="btn bg-gray-300 hover:bg-gray-400 text-gray-700 flex-1">
                        Cancelar
                    </button>
                    <button type="submit" id="saveExpenseBtn"
                            class="btn bg-green-600 hover:bg-green-700 text-white flex-1">
                        Guardar Gasto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Reports -->
    <div id="reportsModal" class="modal">
        <div class="modal-content p-6 w-full max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">üìä Reportes</h2>
                <button id="closeReportsModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Project Info -->
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-bold text-blue-800" id="reportProjectName">Proyecto</h3>
                        <p class="text-sm text-blue-600" id="reportProjectInfo">Informaci√≥n del proyecto</p>
                    </div>
                    <button id="exportReportBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white">
                        <i class="fas fa-file-export mr-2"></i>Exportar Datos
                    </button>
                </div>
            </div>

            <!-- Summary -->
            <div id="reportSummary" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-400">
                    <h3 class="font-bold text-red-800">Total Gastado</h3>
                    <p class="text-2xl font-bold text-red-600" id="totalExpenses">$0.00</p>
                    <p class="text-sm text-red-500" id="expenseCount">0 gastos</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-400">
                    <h3 class="font-bold text-green-800">Total Aportado</h3>
                    <p class="text-2xl font-bold text-green-600" id="totalContributions">$0.00</p>
                    <p class="text-sm text-green-500" id="contributionCount">0 aportaciones</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400">
                    <h3 class="font-bold text-blue-800">Balance Neto</h3>
                    <p class="text-2xl font-bold text-blue-600" id="netBalance">$0.00</p>
                    <p class="text-sm text-blue-500" id="balanceStatus">Disponible</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-400">
                    <h3 class="font-bold text-yellow-800">Promedio/Gasto</h3>
                    <p class="text-2xl font-bold text-yellow-600" id="avgExpense">$0.00</p>
                    <p class="text-sm text-yellow-500" id="totalMovements">0 movimientos</p>
                </div>
            </div>

            <!-- Charts -->
            <div id="reportCharts" class="hidden mb-6">
                <div class="bg-white p-4 rounded-lg border">
                    <h3 class="text-lg font-bold mb-4">Gastos por Categor√≠a</h3>
                    <canvas id="categoryChart" style="height: 400px;"></canvas>
                </div>
            </div>

            <!-- Expenses List -->
            <div id="reportData" class="hidden">
                <h3 class="text-lg font-bold mb-4">Detalle de Movimientos</h3>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 px-4 py-2 text-left">Tipo</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Fecha</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Concepto</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Categor√≠a</th>
                                <th class="border border-gray-300 px-4 py-2 text-right">Monto</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Usuario</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: User Management -->
    <div id="usersModal" class="modal">
        <div class="modal-content p-6 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">üë• Gesti√≥n de Usuarios</h2>
                <button id="closeUsersModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="space-y-6">
                <!-- User Requests Section -->
                <div>
                    <h3 class="text-lg font-bold mb-4">üì¨ Solicitudes Pendientes</h3>
                    <div id="pendingRequests" class="space-y-3">
                        <!-- Requests will be loaded here -->
                    </div>
                </div>

                <!-- Add User Form -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-bold mb-4">‚ûï Agregar Usuario Manualmente</h3>
                    <form id="addUserForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre:</label>
                                <input type="text" id="newUserName" 
                                       class="w-full px-4 py-3 border rounded-lg" 
                                       placeholder="Juan P√©rez" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email:</label>
                                <input type="email" id="newUserEmail" 
                                       class="w-full px-4 py-3 border rounded-lg" 
                                       placeholder="juan@empresa.com" required>
                            </div>
                        </div>

                        <button type="submit" class="btn bg-blue-600 hover:bg-blue-700 text-white w-full">
                            <i class="fas fa-user-plus mr-2"></i>Crear Usuario
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: User Request Form (for new users) -->
    <div id="userRequestModal" class="modal">
        <div class="modal-content p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">üìù Solicitar Acceso</h2>
                <button id="closeUserRequestModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="userRequestForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre completo:</label>
                    <input type="text" id="requestUserName" 
                           class="w-full px-4 py-3 border rounded-lg" 
                           placeholder="Tu nombre completo" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email corporativo:</label>
                    <input type="email" id="requestUserEmail" 
                           class="w-full px-4 py-3 border rounded-lg" 
                           placeholder="tu@empresa.com" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Justificaci√≥n:</label>
                    <textarea id="requestReason" rows="3"
                              class="w-full px-4 py-3 border rounded-lg"
                              placeholder="¬øPor qu√© necesitas acceso al sistema?" required></textarea>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelRequestBtn" 
                            class="btn bg-gray-300 hover:bg-gray-400 text-gray-700 flex-1">
                        Cancelar
                    </button>
                    <button type="submit" id="submitRequestBtn"
                            class="btn bg-blue-600 hover:bg-blue-700 text-white flex-1">
                        Enviar Solicitud
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Project Management -->
    <div id="projectsModal" class="modal">
        <div class="modal-content p-6 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">üìÅ Gesti√≥n de Proyectos</h2>
                <button id="closeProjectsModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="space-y-6">
                <!-- Current Projects -->
                <div>
                    <h3 class="text-lg font-bold mb-4">üìã Proyectos Existentes</h3>
                    <div id="currentProjects" class="space-y-3">
                        <!-- Projects will be loaded here -->
                    </div>
                </div>

                <!-- Add Project Form -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-bold mb-4">‚ûï Crear Nuevo Proyecto</h3>
                    <form id="addProjectForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Proyecto:</label>
                                <input type="text" id="newProjectName" 
                                       class="w-full px-4 py-3 border rounded-lg" 
                                       placeholder="Proyecto Delta" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Presupuesto Inicial (MXN):</label>
                                <input type="number" id="newProjectBudget" step="0.01" min="0.01"
                                       class="w-full px-4 py-3 border rounded-lg" 
                                       placeholder="25000.00" required>
                            </div>
                        </div>

                        <button type="submit" class="btn bg-green-600 hover:bg-green-700 text-white w-full">
                            <i class="fas fa-plus mr-2"></i>Crear Proyecto
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modales de Gesti√≥n de Usuarios -->
    <div id="usersModal" class="modal">
        <div class="modal-content p-6 w-full max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">üë• Gesti√≥n de Usuarios</h2>
                <button id="closeUsersModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="space-y-6">
                <!-- Current Users -->
                <div>
                    <h3 class="text-lg font-bold mb-4">üë§ Usuarios del Sistema</h3>
                    <div id="currentUsers" class="space-y-3">
                        <!-- Users will be loaded here -->
                    </div>
                </div>

                <!-- Add User Form -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-bold mb-4">‚ûï Agregar Nuevo Usuario</h3>
                    <form id="addUserForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre:</label>
                                <input type="text" id="newUserName" 
                                       class="w-full px-4 py-3 border rounded-lg" 
                                       placeholder="Juan P√©rez" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email:</label>
                                <input type="email" id="newUserEmail" 
                                       class="w-full px-4 py-3 border rounded-lg" 
                                       placeholder="juan@empresa.com" required>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Rol:</label>
                                <select id="newUserRole" class="w-full px-4 py-3 border rounded-lg" required>
                                    <option value="">Seleccionar rol...</option>
                                    <option value="admin">üëë Administrador</option>
                                    <option value="user">üë§ Usuario</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a Temporal:</label>
                                <input type="text" id="newUserPassword" 
                                       class="w-full px-4 py-3 border rounded-lg" 
                                       placeholder="admin123" required>
                            </div>
                        </div>

                        <button type="submit" class="btn bg-green-600 hover:bg-green-700 text-white w-full">
                            <i class="fas fa-user-plus mr-2"></i>Crear Usuario
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Aportaci√≥n -->
    <div id="contributionModal" class="modal">
        <div class="modal-content p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">üí∞ Registrar Aportaci√≥n</h2>
                <button id="closeContributionModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="contributionForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha:</label>
                    <input type="date" id="contributionDate" 
                           class="w-full px-4 py-3 border rounded-lg" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Monto (MXN):</label>
                    <input type="number" id="contributionAmount" step="0.01" min="0.01" 
                           class="w-full px-4 py-3 border rounded-lg" 
                           placeholder="0.00" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Concepto:</label>
                    <textarea id="contributionDescription" rows="3"
                              class="w-full px-4 py-3 border rounded-lg"
                              placeholder="Descripci√≥n de la aportaci√≥n" required></textarea>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelContributionBtn" 
                            class="btn bg-gray-300 hover:bg-gray-400 text-gray-700 flex-1">
                        Cancelar
                    </button>
                    <button type="submit" id="saveContributionBtn"
                            class="btn bg-green-600 hover:bg-green-700 text-white flex-1">
                        Guardar Aportaci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Confirmaci√≥n personalizada -->
    <div id="confirmModal" class="modal" style="z-index: 9999 !important; position: fixed !important;">
        <div class="modal-content p-6 w-full max-w-md" style="background: white !important; margin-top: 100px;">
            <div class="text-center">
                <div class="mb-4">
                    <i id="confirmIcon" class="fas fa-question-circle text-4xl text-yellow-500"></i>
                </div>
                <h3 id="confirmTitle" class="text-lg font-bold text-gray-800 mb-2">Confirmaci√≥n</h3>
                <p id="confirmMessage" class="text-gray-600 mb-6">¬øEst√°s seguro?</p>
                
                <div class="flex gap-3">
                    <button id="confirmNo" class="btn bg-green-600 hover:bg-green-700 text-white flex-1 py-3">
                        <i class="fas fa-download mr-2"></i><span id="confirmNoText">Descargar</span>
                    </button>
                    <button id="confirmYes" class="btn bg-red-600 hover:bg-red-700 text-white flex-1 py-3">
                        <i class="fas fa-calendar-times mr-2"></i><span id="confirmYesText">Cerrar Mes</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Solicitar Acceso -->
    <div id="requestAccessModal" class="modal">
        <div class="modal-content p-6 w-full max-w-md">
            <div class="text-center mb-6">
                <i class="fas fa-user-plus text-4xl text-blue-500 mb-4"></i>
                <h3 class="text-xl font-bold text-gray-800">Solicitar Acceso</h3>
                <p class="text-gray-600">Completa el formulario para solicitar acceso al sistema</p>
            </div>
            
            <form id="accessRequestForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo:</label>
                    <input type="text" id="requestName" class="w-full px-4 py-3 border rounded-lg" 
                           placeholder="Tu nombre completo" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Corporativo:</label>
                    <input type="email" id="requestEmail" class="w-full px-4 py-3 border rounded-lg" 
                           placeholder="tu.email@empresa.com" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Motivo de la Solicitud:</label>
                    <textarea id="requestMessage" rows="3" class="w-full px-4 py-3 border rounded-lg" 
                              placeholder="Describe brevemente por qu√© necesitas acceso al sistema..."></textarea>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelAccessRequestBtn" 
                            class="btn bg-gray-500 hover:bg-gray-600 text-white flex-1 py-3">
                        Cancelar
                    </button>
                    <button type="submit" 
                            class="btn bg-blue-600 hover:bg-blue-700 text-white flex-1 py-3">
                        <i class="fas fa-paper-plane mr-2"></i>Enviar Solicitud
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Editar Usuario -->
    <div id="editUserModal" class="modal">
        <div class="modal-content p-6 w-full max-w-md">
            <div class="text-center mb-6">
                <i class="fas fa-user-edit text-4xl text-blue-500 mb-4"></i>
                <h3 class="text-xl font-bold text-gray-800">Editar Usuario</h3>
                <p class="text-gray-600">Modifica los datos del usuario</p>
            </div>
            
            <form id="editUserForm" class="space-y-4">
                <input type="hidden" id="editUserId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo:</label>
                    <input type="text" id="editUserName" class="w-full px-4 py-3 border rounded-lg" 
                           placeholder="Nombre completo" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email:</label>
                    <input type="email" id="editUserEmail" class="w-full px-4 py-3 border rounded-lg" 
                           placeholder="usuario@empresa.com" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rol:</label>
                    <select id="editUserRole" class="w-full px-4 py-3 border rounded-lg" required>
                        <option value="user">üë§ Usuario</option>
                        <option value="admin">üëë Administrador</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nueva Contrase√±a (opcional):</label>
                    <input type="password" id="editUserPassword" class="w-full px-4 py-3 border rounded-lg" 
                           placeholder="Dejar vac√≠o para mantener actual">
                    <p class="text-xs text-gray-500 mt-1">Solo cambia si quieres asignar nueva contrase√±a</p>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelEditUserBtn" 
                            class="btn bg-gray-500 hover:bg-gray-600 text-white flex-1 py-3">
                        Cancelar
                    </button>
                    <button type="submit" 
                            class="btn bg-blue-600 hover:bg-blue-700 text-white flex-1 py-3">
                        <i class="fas fa-save mr-2"></i>Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Alerta Simple -->
    <div id="alertModal" class="modal">
        <div class="modal-content p-6 w-full max-w-md" style="background: white !important; margin-top: 100px;">
            <div class="text-center">
                <div class="mb-4">
                    <i id="alertIcon" class="text-4xl mb-3"></i>
                </div>
                <h3 id="alertTitle" class="text-lg font-bold text-gray-800 mb-2">Informaci√≥n</h3>
                <p id="alertMessage" class="text-gray-600 mb-6">Mensaje</p>
                
                <button id="alertOkBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 w-full">
                    Entendido
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Cambio de Contrase√±a (Primer Login) -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content p-6 w-full max-w-md" style="background: white !important; margin-top: 100px;">
            <div class="text-center">
                <div class="mb-4">
                    <i class="fas fa-key text-4xl text-orange-500 mb-3"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Cambio de Contrase√±a Obligatorio</h3>
                <p class="text-gray-600 mb-6">Es tu primer acceso. Por seguridad, debes cambiar tu contrase√±a temporal.</p>
                
                <form id="changePasswordForm" class="space-y-4">
                    <div class="text-left">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a Actual</label>
                        <input type="password" id="currentPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" readonly>
                    </div>
                    
                    <div class="text-left">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nueva Contrase√±a</label>
                        <input type="password" id="newPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" minlength="6" required>
                        <small class="text-gray-500">M√≠nimo 6 caracteres</small>
                    </div>
                    
                    <div class="text-left">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Confirmar Nueva Contrase√±a</label>
                        <input type="password" id="confirmPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" minlength="6" required>
                    </div>
                    
                    <button type="submit" class="btn bg-orange-600 hover:bg-orange-700 text-white px-8 py-3 w-full mt-6">
                        <i class="fas fa-save mr-2"></i>Cambiar Contrase√±a
                    </button>
                </form>
                
                <p class="text-xs text-gray-500 mt-3">No puedes acceder al sistema hasta cambiar tu contrase√±a.</p>
            </div>
        </div>
    </div>

<script>
// ==========================================
// üìä CLASE PRINCIPAL: DATA MANAGER
// ==========================================
class DataManager {
    constructor() {
        this.users = this.loadUsers();
        this.projects = this.loadProjects();
        this.expenses = this.loadExpenses();
        this.currentUser = null;
        this.registrationCounter = this.loadRegistrationCounter();
        this.initializeDefaultData();
    }

    // üîÑ Inicializar datos por defecto
    initializeDefaultData() {
        // Usuarios por defecto
        if (this.users.length === 0) {
            this.users = [
                { id: '1', name: 'Ram√≥n Rivas', email: 'ramon.rivas@me.com', password: 'admin123', role: 'admin' }
            ];
            this.saveUsers();
        }

        // Migrar proyectos antiguos a nueva estructura
        this.migrateProjectsData();

        // Proyectos por defecto (o si la migraci√≥n fall√≥/est√° incompleta)
        const needsRecreation = this.projects.length === 0 || 
                               this.projects.some(p => p.originalBudget === undefined && p.budget === undefined);
        
        if (needsRecreation) {
            console.log('üîß Recreando proyectos por defecto debido a datos incompletos');
            this.projects = [
                { 
                    id: '1', 
                    name: 'Proyecto Alpha', 
                    originalBudget: 50000, 
                    contributions: [], 
                    spent: 0, 
                    active: true 
                },
                { 
                    id: '2', 
                    name: 'Proyecto Beta', 
                    originalBudget: 75000, 
                    contributions: [], 
                    spent: 0, 
                    active: true 
                }
            ];
            this.saveProjects();
        }
        
        // Usuario pendiente de prueba (solo si no hay usuarios pendientes)
        const pendingUsers = this.getPendingUsers();
        if (pendingUsers.length === 0) {
            const testRequest = {
                id: Date.now().toString(),
                name: 'Mar√≠a Gonz√°lez',
                email: 'maria.gonzalez@test.com',
                message: 'Solicito acceso al sistema de gastos para el departamento de ventas.',
                status: 'pending',
                requestDate: new Date().toISOString()
            };
            this.savePendingUsers([testRequest]);
            console.log('üß™ Usuario pendiente de prueba creado para testing del badge');
        }
    }

    // üîÑ Migrar datos antiguos a nueva estructura
    migrateProjectsData() {
        let needsSave = false;
        
        this.projects.forEach(project => {
            // Migrar proyecto con estructura antigua (budget) a nueva estructura (originalBudget + contributions)
            if (project.budget !== undefined && project.originalBudget === undefined) {
                project.originalBudget = project.budget;
                project.contributions = project.contributions || [];
                delete project.budget; // Eliminar propiedad antigua
                needsSave = true;
            }
            
            // Asegurar que tenga contributions array
            if (!project.contributions) {
                project.contributions = [];
                needsSave = true;
            }
            
            // Asegurar que tenga originalBudget
            if (project.originalBudget === undefined) {
                project.originalBudget = 0;
                needsSave = true;
            }
        });
        
        if (needsSave) {
            this.saveProjects();
            console.log('‚úÖ Proyectos migrados a nueva estructura');
        }
    }

    // üéØ Generar n√∫mero de registro √∫nico
    generateRegistrationNumber(userId, projectId) {
        this.registrationCounter++;
        this.saveRegistrationCounter();
        
        const userNum = userId.toString().padStart(3, '0');
        const projectNum = projectId.toString().padStart(3, '0');
        const regNum = this.registrationCounter.toString().padStart(3, '0');
        
        return `USR${userNum}_PRJ${projectNum}_REG${regNum}`;
    }

    // üíæ GESTI√ìN DE ALMACENAMIENTO
    loadUsers() {
        const users = localStorage.getItem('idaconn_users');
        return users ? JSON.parse(users) : [];
    }

    saveUsers() {
        localStorage.setItem('idaconn_users', JSON.stringify(this.users));
    }

    loadProjects() {
        const projects = localStorage.getItem('idaconn_projects');
        return projects ? JSON.parse(projects) : [];
    }

    saveProjects() {
        localStorage.setItem('idaconn_projects', JSON.stringify(this.projects));
    }

    loadExpenses() {
        const expenses = localStorage.getItem('idaconn_expenses');
        return expenses ? JSON.parse(expenses) : [];
    }

    saveExpenses() {
        localStorage.setItem('idaconn_expenses', JSON.stringify(this.expenses));
    }

    loadRegistrationCounter() {
        const counter = localStorage.getItem('idaconn_reg_counter');
        return counter ? parseInt(counter) : 0;
    }

    saveRegistrationCounter() {
        localStorage.setItem('idaconn_reg_counter', this.registrationCounter.toString());
    }

    // üîê AUTENTICACI√ìN
    login(email, password) {
        const user = this.users.find(u => u.email === email && u.password === password);
        if (user) {
            this.currentUser = user;
            localStorage.setItem('idaconn_current_user', JSON.stringify(user));
            return user;
        }
        return null;
    }

    logout() {
        this.currentUser = null;
        localStorage.removeItem('idaconn_current_user');
    }

    getCurrentUser() {
        if (this.currentUser) return this.currentUser;
        
        const saved = localStorage.getItem('idaconn_current_user');
        if (saved) {
            this.currentUser = JSON.parse(saved);
            return this.currentUser;
        }
        return null;
    }

    // üë• GESTI√ìN DE USUARIOS
    addUser(userData) {
        const newUser = {
            id: (this.users.length + 1).toString(),
            ...userData
        };
        this.users.push(newUser);
        this.saveUsers();
        return newUser;
    }

    deleteUser(userId) {
        this.users = this.users.filter(u => u.id !== userId);
        this.saveUsers();
    }

    // üë• GESTI√ìN DE USUARIOS PENDIENTES
    getPendingUsers() {
        const pendingUsers = localStorage.getItem('idaconn_pending_users');
        return pendingUsers ? JSON.parse(pendingUsers) : [];
    }

    savePendingUsers(users) {
        localStorage.setItem('idaconn_pending_users', JSON.stringify(users));
    }

    addPendingUser(userData) {
        const pendingUsers = this.getPendingUsers();
        const newRequest = {
            id: Date.now().toString(),
            ...userData,
            status: 'pending',
            requestDate: new Date().toISOString()
        };
        pendingUsers.push(newRequest);
        this.savePendingUsers(pendingUsers);
        return newRequest;
    }

    removePendingUser(requestId) {
        const pendingUsers = this.getPendingUsers();
        const filtered = pendingUsers.filter(u => u.id !== requestId);
        this.savePendingUsers(filtered);
    }

    // üìÅ GESTI√ìN DE PROYECTOS
    addProject(projectData) {
        // Validar datos de entrada
        if (!projectData.name || !projectData.budget) {
            throw new Error('Nombre y presupuesto son requeridos');
        }
        
        const budget = parseFloat(projectData.budget);
        if (isNaN(budget) || budget <= 0) {
            throw new Error('El presupuesto debe ser un n√∫mero mayor a 0');
        }
        
        const newProject = {
            id: (this.projects.length + 1).toString(),
            name: projectData.name.trim(),
            originalBudget: budget,
            contributions: [],
            spent: 0,
            active: true
        };
        
        this.projects.push(newProject);
        this.saveProjects();
        console.log('‚úÖ Proyecto creado:', newProject);
        return newProject;
    }

    deleteProject(projectId) {
        this.projects = this.projects.filter(p => p.id !== projectId);
        this.saveProjects();
    }

    // üí∞ GESTI√ìN DE APORTACIONES
    addContribution(projectId, contributionData) {
        const project = this.projects.find(p => p.id === projectId);
        if (!project) throw new Error('Proyecto no encontrado');

        const newContribution = {
            id: (project.contributions.length + 1).toString(),
            date: contributionData.date,
            amount: parseFloat(contributionData.amount),
            description: contributionData.description,
            timestamp: new Date().toISOString(),
            userId: this.currentUser.id,
            userName: this.currentUser.name
        };

        project.contributions.push(newContribution);
        this.saveProjects();
        return newContribution;
    }

    // üìä C√ÅLCULOS DE PRESUPUESTO
    getTotalBudget(projectId) {
        const project = this.projects.find(p => p.id === projectId);
        if (!project) return 0;
        
        // Manejar proyectos que no est√°n completamente migrados
        const originalBudget = project.originalBudget || project.budget || 0;
        const contributions = project.contributions || [];
        const totalContributions = contributions.reduce((sum, contrib) => sum + contrib.amount, 0);
        
        return originalBudget + totalContributions;
    }

    getAvailableBudget(projectId) {
        const project = this.projects.find(p => p.id === projectId);
        if (!project) return 0;
        
        return this.getTotalBudget(projectId) - (project.spent || 0);
    }

    // üí∞ GESTI√ìN DE GASTOS
    addExpense(expenseData) {
        const project = this.projects.find(p => p.id === expenseData.projectId);
        if (!project) throw new Error('Proyecto no encontrado');

        // Generar nombre √∫nico del archivo basado en el tipo
        let fileName = '';
        if (expenseData.type === 'factura' && expenseData.xmlData) {
            // Para facturas, usar el RFC del emisor + folio
            const rfc = expenseData.xmlData.emisor?.rfc || 'UNKNOWN';
            const folio = expenseData.xmlData.folio || 'NOFOLIO';
            fileName = `FACTURA_${rfc}_${folio}`;
        } else if (expenseData.type === 'ticket') {
            // Para tickets, usar timestamp
            fileName = `TICKET_${Date.now()}`;
        } else {
            // Para manual, usar descripci√≥n simplificada
            const desc = expenseData.description.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
            fileName = `MANUAL_${desc}_${Date.now()}`;
        }

        const newExpense = {
            id: (this.expenses.length + 1).toString(),
            registrationNumber: this.generateRegistrationNumber(this.currentUser.id, expenseData.projectId),
            fileName: fileName,
            userId: this.currentUser.id,
            userName: this.currentUser.name,
            date: expenseData.date,
            timestamp: new Date().toISOString(),
            ...expenseData
        };

        // Actualizar presupuesto del proyecto
        project.spent += parseFloat(expenseData.amount);
        
        this.expenses.push(newExpense);
        this.saveExpenses();
        this.saveProjects();
        
        return newExpense;
    }

    getProjectExpenses(projectId) {
        return this.expenses.filter(e => e.projectId === projectId);
    }

    getTotalExpensesByProject(projectId) {
        const expenses = this.getProjectExpenses(projectId);
        return expenses.reduce((total, expense) => total + parseFloat(expense.amount || 0), 0);
    }

    // üìä EXPORTACI√ìN DE DATOS
    async exportData(projectId) {
        const project = this.projects.find(p => p.id === projectId);
        if (!project) throw new Error('Proyecto no encontrado');

        const expenses = this.getProjectExpenses(projectId);
        if (expenses.length === 0) {
            throw new Error('No hay gastos para exportar en este proyecto');
        }

        // Generar CSV
        const csvContent = this.generateCSV(expenses, project);
        
        // Descargar CSV
        this.downloadCSV(csvContent, `Gastos_${project.name}_${new Date().toISOString().split('T')[0]}.csv`);
        
        // Descargar archivos individuales
        await this.downloadFiles(expenses);
        
        return {
            totalExpenses: expenses.length,
            totalAmount: expenses.reduce((sum, exp) => sum + parseFloat(exp.amount), 0),
            csvGenerated: true,
            filesDownloaded: expenses.filter(e => e.fileData || e.xmlFileData || e.pdfFileData).length
        };
    }

    generateCSV(expenses, project) {
        const headers = [
            'N√∫mero de Registro',
            'Nombre del Archivo',
            'Usuario',
            'Fecha',
            'Monto (MXN)',
            'Categor√≠a',
            'Tipo',
            'Concepto',
            'Proyecto',
            'Timestamp'
        ];

        const rows = expenses.map(expense => [
            expense.registrationNumber,
            expense.fileName,
            expense.userName,
            expense.date,
            expense.amount,
            expense.category,
            expense.type,
            `"${expense.description.replace(/"/g, '""')}"`, // Escape comillas
            project.name,
            expense.timestamp
        ]);

        // Agregar fila de totales
        const totalAmount = expenses.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
        rows.push([
            '',
            '',
            '',
            'TOTAL:',
            totalAmount.toFixed(2),
            '',
            '',
            '',
            '',
            ''
        ]);

        const csvContent = [headers, ...rows]
            .map(row => row.join(','))
            .join('\n');

        return csvContent;
    }

    downloadCSV(content, fileName) {
        const BOM = '\uFEFF'; // Byte Order Mark para UTF-8
        const blob = new Blob([BOM + content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    async downloadFiles(expenses) {
        for (const expense of expenses) {
            await new Promise(resolve => setTimeout(resolve, 100)); // Peque√±a pausa entre descargas
            
            if (expense.type === 'factura') {
                // Descargar XML
                if (expense.xmlFileData) {
                    this.downloadFile(expense.xmlFileData, `${expense.fileName}.xml`, 'application/xml');
                }
                // Descargar PDF
                if (expense.pdfFileData) {
                    this.downloadFile(expense.pdfFileData, `${expense.fileName}.pdf`, 'application/pdf');
                }
            } else if (expense.type === 'ticket' && expense.fileData) {
                // Descargar imagen del ticket
                const extension = this.getImageExtension(expense.fileData);
                this.downloadFile(expense.fileData, `${expense.fileName}.${extension}`, `image/${extension}`);
            }
        }
    }

    downloadFile(base64Data, fileName, mimeType) {
        try {
            const byteCharacters = atob(base64Data.split(',')[1] || base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: mimeType });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error('Error downloading file:', fileName, error);
        }
    }

    getImageExtension(base64Data) {
        if (base64Data.startsWith('data:image/png')) return 'png';
        if (base64Data.startsWith('data:image/jpeg')) return 'jpg';
        if (base64Data.startsWith('data:image/jpg')) return 'jpg';
        if (base64Data.startsWith('data:image/gif')) return 'gif';
        return 'jpg'; // default
    }

    // üîÑ REINICIO DE MES
    resetMonth() {
        console.log('üî• INICIANDO RESETMONTH');
        
        // Archivar gastos del mes actual
        const currentMonth = new Date().toISOString().substring(0, 7);
        const archivedKey = `idaconn_expenses_${currentMonth}`;
        console.log('üì¶ Archivando gastos:', this.expenses.length);
        localStorage.setItem(archivedKey, JSON.stringify(this.expenses));
        
        // BORRAR DATOS COMPLETAMENTE
        this.expenses = [];
        this.registrationCounter = 0;
        
        // Reiniciar spent de TODOS los proyectos Y limpiar aportaciones
        console.log('üí∞ Reiniciando', this.projects.length, 'proyectos');
        this.projects.forEach(project => {
            console.log(`Proyecto ${project.name}: spent ${project.spent} -> 0`);
            project.spent = 0;
            
            // Limpiar aportaciones del proyecto
            const contributionsCount = project.contributions ? project.contributions.length : 0;
            console.log(`Proyecto ${project.name}: limpiando ${contributionsCount} aportaciones`);
            project.contributions = [];
        });
        
        // FORZAR GUARDADO
        localStorage.setItem('idaconn_expenses', JSON.stringify([]));
        localStorage.setItem('idaconn_reg_counter', '0');
        localStorage.setItem('idaconn_projects', JSON.stringify(this.projects));
        
        // Verificar que el reset fue exitoso
        console.log('üîç Verificaci√≥n post-reset:');
        console.log('üìä Gastos despu√©s del reset:', this.expenses.length);
        console.log('üî¢ Contador despu√©s del reset:', this.registrationCounter);
        console.log('üí∞ Proyectos despu√©s del reset:', this.projects.map(p => ({
            name: p.name, 
            spent: p.spent, 
            contributions: p.contributions ? p.contributions.length : 0
        })));
        
        console.log('‚úÖ RESETMONTH COMPLETADO');
    }

    // üõ†Ô∏è UTILIDADES DE DEBUGGING
    resetAllData() {
        localStorage.removeItem('idaconn_projects');
        localStorage.removeItem('idaconn_expenses');
        localStorage.removeItem('idaconn_reg_counter');
        console.log('üóëÔ∏è Todos los datos del sistema han sido eliminados');
        window.location.reload();
    }

    debugProjectsData() {
        console.log('üìä Proyectos actuales:', this.projects);
        console.log('üíæ Proyectos en localStorage:', localStorage.getItem('idaconn_projects'));
    }

    // üë• GESTI√ìN DE USUARIOS
    getPendingUsers() {
        const requests = localStorage.getItem('idaconn_pending_users');
        return requests ? JSON.parse(requests) : [];
    }

    savePendingUsers(requests) {
        localStorage.setItem('idaconn_pending_users', JSON.stringify(requests));
    }

    addUserRequest(userData) {
        const requests = this.getPendingUsers();
        const newRequest = {
            id: Date.now().toString(),
            name: userData.name,
            email: userData.email,
            message: userData.message || '',
            requestDate: new Date().toISOString(),
            status: 'pending'
        };
        requests.push(newRequest);
        this.savePendingUsers(requests);
        return newRequest;
    }

    approveUserRequest(requestId, tempPassword) {
        const requests = this.getPendingUsers();
        const request = requests.find(r => r.id === requestId);
        if (!request) return null;

        // Cambiar estado a aprobado
        request.status = 'approved';
        request.approvedDate = new Date().toISOString();
        request.tempPassword = tempPassword;

        // Agregar a usuarios reales
        const newUser = {
            id: Date.now().toString(), // ID √∫nico para el usuario
            name: request.name,
            email: request.email,
            role: 'user',
            password: tempPassword,
            createdDate: new Date().toISOString(),
            isFirstLogin: true, // Flag para forzar cambio de contrase√±a
            tempPassword: true  // Indica que es contrase√±a temporal
        };

        // ‚úÖ AGREGAR EL USUARIO AL ARRAY DE USUARIOS
        this.users.push(newUser);
        this.saveUsers();
        
        console.log('‚úÖ Usuario agregado a la lista:', newUser);
        console.log('‚úÖ Total de usuarios ahora:', this.users.length);

        this.savePendingUsers(requests);
        return { request, newUser };
    }

    rejectUserRequest(requestId, reason = '') {
        const requests = this.getPendingUsers();
        const request = requests.find(r => r.id === requestId);
        if (!request) return null;

        request.status = 'rejected';
        request.rejectedDate = new Date().toISOString();
        request.rejectionReason = reason;

        this.savePendingUsers(requests);
        return request;
    }

    // üîë Actualizar contrase√±a de usuario
    updateUserPassword(userId, newPassword) {
        const user = this.users.find(u => u.id === userId);
        if (!user) return null;

        // Actualizar contrase√±a y quitar flags de primer login
        user.password = newPassword;
        user.isFirstLogin = false;
        user.tempPassword = false;
        user.passwordChangedDate = new Date().toISOString();

        // Guardar cambios
        this.saveUsers();
        
        // Actualizar usuario en localStorage si es el actual
        if (this.currentUser && this.currentUser.id === userId) {
            this.currentUser = user;
            localStorage.setItem('idaconn_current_user', JSON.stringify(user));
        }

        console.log('üîë Contrase√±a actualizada para usuario:', user.name);
        return user;
    }

    // üîß GESTI√ìN COMPLETA DE USUARIOS
    createUser(userData) {
        const newUser = {
            id: Date.now().toString(),
            name: userData.name,
            email: userData.email,
            password: userData.password,
            role: userData.role || 'user',
            createdDate: new Date().toISOString()
        };
        
        this.users.push(newUser);
        this.saveUsers();
        return newUser;
    }

    updateUser(userId, userData) {
        const userIndex = this.users.findIndex(u => u.id === userId);
        if (userIndex === -1) return null;

        const updatedUser = {
            ...this.users[userIndex],
            ...userData,
            updatedDate: new Date().toISOString()
        };
        
        this.users[userIndex] = updatedUser;
        this.saveUsers();
        return updatedUser;
    }

    deleteUser(userId) {
        const userIndex = this.users.findIndex(u => u.id === userId);
        if (userIndex === -1) return false;

        // No permitir eliminar el √∫ltimo admin
        const user = this.users[userIndex];
        if (user.role === 'admin') {
            const adminCount = this.users.filter(u => u.role === 'admin').length;
            if (adminCount <= 1) {
                return { error: 'No se puede eliminar el √∫ltimo administrador' };
            }
        }

        this.users.splice(userIndex, 1);
        this.saveUsers();
        return true;
    }

    getUserById(userId) {
        return this.users.find(u => u.id === userId);
    }
}

// ==========================================
// üìß CONFIGURACI√ìN EMAILJS
// ==========================================

// CONFIGURACI√ìN EMAILJS - CONFIGURADO Y LISTO
const EMAIL_CONFIG = {
    PUBLIC_KEY: 'gHJwWuHVFVhlE8hbm',  // Public Key activo
    SERVICE_ID: 'service_ksu843l',     // Service ID Gmail configurado
    TEMPLATES: {
        APPROVAL: 'template_i0fb2nq',   // Template de aprobaci√≥n ‚úÖ FUNCIONA
        REJECTION: 'template_l1l2r38',  // Template de rechazo ‚ùå NO LLENA CAMPOS
        NEW_REQUEST: null               // Se usa notificaci√≥n interna en la app
    }
};

// Funci√≥n auxiliar para enviar emails
async function sendEmail(templateId, templateParams) {
    console.log('üîç DEBUG: sendEmail llamada con:', { templateId, templateParams });
    console.log('üîç DEBUG: EMAIL_CONFIG actual:', EMAIL_CONFIG);
    console.log('üîç DEBUG: EmailJS disponible:', typeof emailjs !== 'undefined');
    
    // Verificar si EmailJS est√° configurado
    if (!EMAIL_CONFIG.PUBLIC_KEY || EMAIL_CONFIG.PUBLIC_KEY === 'TU_PUBLIC_KEY_AQUI') {
        console.warn('‚ö†Ô∏è EmailJS no configurado, usando modo simulaci√≥n');
        return { success: false, mode: 'simulation' };
    }

    if (typeof emailjs === 'undefined') {
        console.error('‚ùå EmailJS library no est√° cargada');
        return { success: false, mode: 'error', error: 'EmailJS library not loaded' };
    }

    try {
        // Inicializar EmailJS si no est√° inicializado
        if (!emailjs._initialized) {
            console.log('üîß Inicializando EmailJS con PUBLIC_KEY:', EMAIL_CONFIG.PUBLIC_KEY);
            emailjs.init(EMAIL_CONFIG.PUBLIC_KEY);
            emailjs._initialized = true;
        }

        console.log('üìß Enviando email real con EmailJS...');
        console.log('üìß Service ID:', EMAIL_CONFIG.SERVICE_ID);
        console.log('üìß Template ID:', templateId);
        console.log('üìß Par√°metros:', templateParams);
        
        const response = await emailjs.send(
            EMAIL_CONFIG.SERVICE_ID,
            templateId,
            templateParams
        );
        
        console.log('‚úÖ Email enviado exitosamente:', response);
        return { success: true, mode: 'real', response };
        
    } catch (error) {
        console.error('‚ùå Error enviando email:', error);
        console.error('‚ùå Error detalles:', error.message);
        console.error('‚ùå Error stack:', error.stack);
        return { success: false, mode: 'error', error };
    }
}

// ==========================================
// üéØ CLASE PRINCIPAL: EXPENSE APP
// ==========================================
class ExpenseApp {
    constructor() {
        this.dataManager = new DataManager();
        this.currentExpenseType = null;
        this.selectedProjectId = null;
        this.ocrInProgress = false;
        this.initializeApp();
    }

    // üöÄ Inicializar aplicaci√≥n
    initializeApp() {
        this.setupEventListeners();
        this.checkAutoLogin();
        
        // Inicializar badge de notificaciones para admin
        const currentUser = this.dataManager.getCurrentUser();
        if (currentUser && currentUser.role === 'admin') {
            setTimeout(() => this.updatePendingRequestsBadge(), 500);
        }
    }

    // üì± Configurar event listeners
    setupEventListeners() {
        // Login
        document.getElementById('loginForm').addEventListener('submit', (e) => this.handleLogin(e));
        document.getElementById('requestAccessBtn').addEventListener('click', () => this.showRequestAccessModal());

        // Dashboard
        document.getElementById('logoutBtn').addEventListener('click', () => this.handleLogout());
        document.getElementById('exportBtn').addEventListener('click', () => this.handleExport());
        document.getElementById('projectSelect').addEventListener('change', (e) => this.handleProjectChange(e));
        
        // Quick Actions
        document.getElementById('addExpenseBtn').addEventListener('click', () => this.showExpenseTypeModal());
        document.getElementById('viewReportsBtn').addEventListener('click', () => this.showReportsModal());

        // Admin Actions
        document.getElementById('manageProjectsBtn').addEventListener('click', () => this.toggleProjectsSection());
        document.getElementById('manageRequestsBtn').addEventListener('click', () => this.toggleRequestsSection());
        document.getElementById('manageUsersBtn').addEventListener('click', () => this.toggleUsersSection());

        // Expense Type Selection
        document.getElementById('typeFactura').addEventListener('click', () => this.selectExpenseType('factura'));
        document.getElementById('typeTicket').addEventListener('click', () => this.selectExpenseType('ticket'));
        document.getElementById('typeManual').addEventListener('click', () => this.selectExpenseType('manual'));
        document.getElementById('closeExpenseTypeModal').addEventListener('click', () => this.hideExpenseTypeModal());

        // Expense Form
        document.getElementById('expenseForm').addEventListener('submit', (e) => this.handleExpenseSubmit(e));
        document.getElementById('cancelExpenseBtn').addEventListener('click', () => this.hideExpenseModal());
        document.getElementById('closeExpenseModal').addEventListener('click', () => this.hideExpenseModal());

        // File handling
        document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileChange(e));
        document.getElementById('xmlFileInput').addEventListener('change', (e) => this.handleXMLFileChange(e));
        document.getElementById('pdfFileInput').addEventListener('change', (e) => this.handlePDFFileChange(e));

        // Amount validation
        document.getElementById('expenseAmount').addEventListener('input', () => this.validateAmount());

        // Reports Modal
        document.getElementById('closeReportsModal').addEventListener('click', () => this.hideReportsModal());
        document.getElementById('exportReportBtn').addEventListener('click', () => this.exportReportData());

        // Projects Modal
        document.getElementById('closeProjectsModal').addEventListener('click', () => this.hideProjectsModal());
        document.getElementById('addProjectForm').addEventListener('submit', (e) => this.handleAddProject(e));

        // Contribution Modal
        document.getElementById('closeContributionModal').addEventListener('click', () => this.hideContributionModal());
        document.getElementById('cancelContributionBtn').addEventListener('click', () => this.hideContributionModal());
        document.getElementById('contributionForm').addEventListener('submit', (e) => this.handleContributionSubmit(e));

        // Users Modal
        document.getElementById('closeUsersModal').addEventListener('click', () => this.hideUsersModal());
        document.getElementById('addUserForm').addEventListener('submit', (e) => this.handleAddUser(e));

        // Confirmation Modal
        document.getElementById('confirmNo').addEventListener('click', () => this.cancelAction());
        document.getElementById('confirmYes').addEventListener('click', () => this.confirmAction());

        // Request Access Modal
        document.getElementById('cancelAccessRequestBtn').addEventListener('click', () => this.hideRequestAccessModal());
        document.getElementById('accessRequestForm').addEventListener('submit', (e) => this.handleAccessRequest(e));

        // Edit User Modal
        document.getElementById('cancelEditUserBtn').addEventListener('click', () => this.hideEditUserModal());
        document.getElementById('editUserForm').addEventListener('submit', (e) => this.handleEditUser(e));

        // Alert Modal
        document.getElementById('alertOkBtn').addEventListener('click', () => this.hideAlertModal());
        
        // Change Password Modal
        document.getElementById('changePasswordForm').addEventListener('submit', (e) => this.handleChangePassword(e));
        
        // New Project Button (inline)
        document.getElementById('addNewProjectBtn').addEventListener('click', () => this.showProjectsModal());
    }

    // üîê Verificar auto-login
    checkAutoLogin() {
        const user = this.dataManager.getCurrentUser();
        if (user) {
            this.showDashboard(user);
        } else {
            this.showLogin();
        }
    }

    // üìù LOGIN & AUTHENTICATION
    handleLogin(e) {
        e.preventDefault();
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        const user = this.dataManager.login(email, password);
        
        if (user) {
            // Verificar si es primer login y necesita cambiar contrase√±a
            if (user.isFirstLogin || user.tempPassword) {
                console.log('üë§ Primer login detectado, solicitando cambio de contrase√±a');
                this.showChangePasswordModal(user);
            } else {
                this.showDashboard(user);
            }
        } else {
            this.showAlert(
                'Error de Acceso',
                'Credenciales incorrectas. Por favor verifica tu email y contrase√±a.',
                'fas fa-exclamation-circle text-red-500'
            );
        }
    }

    handleLogout() {
        this.showCustomConfirm(
            'üö™ Cerrar Sesi√≥n',
            '¬øEst√°s seguro de que quieres cerrar sesi√≥n?\n\nSe perder√°n todos los datos no guardados.',
            () => {
                console.log('üö™ Ejecutando logout');
                this.hideConfirmModal(); // Cerrar modal PRIMERO
                this.dataManager.logout();
                this.showLogin();
            },
            'S√≠, Cerrar Sesi√≥n',
            'Cancelar',
            null
        );
    }

    // üñ•Ô∏è PANTALLAS
    showLogin() {
        console.log('üîë Mostrando pantalla de login');
        
        // Cerrar cualquier modal abierto
        document.querySelectorAll('.modal.show').forEach(modal => {
            modal.classList.remove('show');
        });
        
        // Ocultar header y mostrar solo login
        document.getElementById('appHeader').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('dashboardScreen').classList.add('hidden');
        document.getElementById('loginEmail').focus();
        
        console.log('‚úÖ Login mostrado, dashboard y header ocultos');
    }

    showDashboard(user) {
        console.log('üìä Mostrando dashboard para:', user.name);
        
        // Mostrar header y dashboard, ocultar login
        document.getElementById('appHeader').classList.remove('hidden');
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('dashboardScreen').classList.remove('hidden');
        
        // Update user info
        document.getElementById('userInfo').textContent = `${user.name} (${user.role === 'admin' ? 'üëë Admin' : 'üë§ Usuario'})`;
        
        // Show/hide admin functions
        const adminCard = document.getElementById('adminActionsCard');
        const projectsCard = document.getElementById('projectsManagementCard');
        const requestsCard = document.getElementById('requestsManagementCard');
        const usersCard = document.getElementById('usersManagementCard');
        
        if (user.role === 'admin') {
            adminCard.classList.remove('hidden');
            // Las secciones se mostrar√°n solo al hacer clic en las tarjetas
            projectsCard.classList.add('hidden');
            requestsCard.classList.add('hidden');
            usersCard.classList.add('hidden');
            
            // Configurar event listeners de admin SOLO una vez
            this.setupAdminEventListeners();
        } else {
            adminCard.classList.add('hidden');
            projectsCard.classList.add('hidden');
            requestsCard.classList.add('hidden');
            usersCard.classList.add('hidden');
        }
        
        console.log('‚úÖ Dashboard y header mostrados, login oculto');

        // Load projects and initialize dashboard
        this.loadProjects();
        
        // Si es admin, actualizar badge de solicitudes pendientes
        if (user.role === 'admin') {
            setTimeout(() => this.updatePendingRequestsBadge(), 100);
        }
    }

    setupAdminEventListeners() {
        // Solo configurar si no se han configurado ya
        if (this.adminListenersConfigured) return;
        
        console.log('üîß Configurando event listeners de administraci√≥n...');
        
        // Bot√≥n Proyectos
        const projectsBtn = document.getElementById('manageProjectsBtn');
        if (projectsBtn) {
            projectsBtn.addEventListener('click', () => {
                this.showAdminSection('projects');
            });
        }
        
        // Bot√≥n Solicitudes  
        const requestsBtn = document.getElementById('manageRequestsBtn');
        if (requestsBtn) {
            requestsBtn.addEventListener('click', () => {
                this.showAdminSection('requests');
            });
        }
        
        // Bot√≥n Usuarios
        const usersBtn = document.getElementById('manageUsersBtn');
        if (usersBtn) {
            usersBtn.addEventListener('click', () => {
                this.showAdminSection('users');
            });
        }
        
        // Bot√≥n agregar nuevo usuario
        const addNewUserBtn = document.getElementById('addNewUserBtn');
        if (addNewUserBtn) {
            addNewUserBtn.addEventListener('click', () => {
                this.showUsersModal();
            });
        }

        // Bot√≥n agregar nuevo proyecto
        const addNewProjectBtn = document.getElementById('addNewProjectBtn');
        if (addNewProjectBtn) {
            addNewProjectBtn.addEventListener('click', () => {
                this.addNewProject();
            });
        }
        
        this.adminListenersConfigured = true;
        console.log('‚úÖ Event listeners de administraci√≥n configurados');
    }

    showAdminSection(sectionName) {
        console.log('üîÑ Mostrando secci√≥n de administraci√≥n:', sectionName);
        
        // Ocultar todas las secciones
        document.getElementById('projectsManagementCard').classList.add('hidden');
        document.getElementById('requestsManagementCard').classList.add('hidden');
        document.getElementById('usersManagementCard').classList.add('hidden');
        
        // Remover efectos activos de todos los botones
        this.removeActiveEffect([
            document.getElementById('manageProjectsBtn'),
            document.getElementById('manageRequestsBtn'),
            document.getElementById('manageUsersBtn')
        ]);
        
        // Mostrar la secci√≥n seleccionada
        if (sectionName === 'projects') {
            document.getElementById('projectsManagementCard').classList.remove('hidden');
            this.addActiveEffect(document.getElementById('manageProjectsBtn'));
            this.loadProjectsSection();
        } else if (sectionName === 'requests') {
            document.getElementById('requestsManagementCard').classList.remove('hidden');
            this.addActiveEffect(document.getElementById('manageRequestsBtn'));
            this.loadPendingRequestsSection();
        } else if (sectionName === 'users') {
            document.getElementById('usersManagementCard').classList.remove('hidden');
            this.addActiveEffect(document.getElementById('manageUsersBtn'));
            this.loadRegisteredUsers();
        }
    }

    addNewProject() {
        console.log('üèóÔ∏è Agregando nuevo proyecto');
        
        const name = prompt('¬øCu√°l es el nombre del nuevo proyecto?');
        if (!name || name.trim() === '') return;
        
        const budget = prompt('¬øCu√°l es el presupuesto original del proyecto?');
        if (!budget || isNaN(budget) || parseFloat(budget) <= 0) {
            this.showCustomConfirm(
                'Error',
                'El presupuesto debe ser un n√∫mero mayor a 0.',
                () => {}
            );
            return;
        }
        
        try {
            const newProject = this.dataManager.addProject({
                name: name.trim(),
                budget: parseFloat(budget)
            });
            
            this.loadProjectsSection(); // Recargar la secci√≥n
            
            this.showCustomConfirm(
                'Proyecto Creado',
                `El proyecto "${newProject.name}" ha sido creado con un presupuesto de $${parseFloat(budget).toLocaleString()}.`,
                () => {}
            );
            
        } catch (error) {
            this.showCustomConfirm(
                'Error',
                error.message || 'No se pudo crear el proyecto.',
                () => {}
            );
        }
    }

    // üìÅ GESTI√ìN DE PROYECTOS
    loadProjects() {
        const projectSelect = document.getElementById('projectSelect');
        projectSelect.innerHTML = '<option value="">Seleccionar proyecto...</option>';
        
        this.dataManager.projects.forEach(project => {
            if (project.active) {
                const totalBudget = this.dataManager.getTotalBudget(project.id);
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.name} (Presupuesto: $${totalBudget.toLocaleString()})`;
                projectSelect.appendChild(option);
            }
        });
    }

    handleProjectChange(e) {
        this.selectedProjectId = e.target.value;
        
        if (this.selectedProjectId) {
            document.getElementById('actionsCard').classList.remove('hidden');
            document.getElementById('balanceCard').classList.remove('hidden');
            document.getElementById('expensesCard').classList.remove('hidden');
            
            this.updateBalance();
            this.loadRecentExpenses();
        } else {
            document.getElementById('actionsCard').classList.add('hidden');
            document.getElementById('balanceCard').classList.add('hidden');
            document.getElementById('expensesCard').classList.add('hidden');
        }
    }

    updateBalance() {
        const project = this.dataManager.projects.find(p => p.id === this.selectedProjectId);
        if (project) {
            const available = this.dataManager.getAvailableBudget(this.selectedProjectId);
            document.getElementById('currentBalance').textContent = `$${available.toLocaleString('es-MX', { minimumFractionDigits: 2 })}`;
        }
    }

    loadRecentExpenses() {
        const expenses = this.dataManager.getProjectExpenses(this.selectedProjectId);
        const project = this.dataManager.projects.find(p => p.id === this.selectedProjectId);
        const contributions = project ? project.contributions : [];
        const recentContainer = document.getElementById('recentExpenses');
        
        // Combinar gastos y aportaciones
        const allTransactions = [];
        
        // Agregar gastos (negativos)
        expenses.forEach(expense => {
            allTransactions.push({
                ...expense,
                type: 'expense',
                displayAmount: `-$${parseFloat(expense.amount).toLocaleString('es-MX', { minimumFractionDigits: 2 })}`,
                amountClass: 'text-red-600',
                icon: 'fas fa-minus-circle'
            });
        });
        
        // Agregar aportaciones (positivas)
        contributions.forEach(contribution => {
            allTransactions.push({
                ...contribution,
                type: 'contribution',
                displayAmount: `+$${parseFloat(contribution.amount).toLocaleString('es-MX', { minimumFractionDigits: 2 })}`,
                amountClass: 'text-green-600',
                icon: 'fas fa-plus-circle',
                category: 'Aportaci√≥n'
            });
        });
        
        if (allTransactions.length === 0) {
            recentContainer.innerHTML = '<p class="text-gray-500 text-center py-2">No hay movimientos registrados</p>';
            return;
        }

        // Ordenar por timestamp y tomar los √∫ltimos 5
        const recent = allTransactions
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
            .slice(0, 5);
            
        recentContainer.innerHTML = recent.map(transaction => `
            <div class="bg-gray-50 p-3 rounded-lg border">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-2">
                            <i class="${transaction.icon} text-sm ${transaction.amountClass}"></i>
                            <span class="font-medium ${transaction.amountClass}">${transaction.displayAmount}</span>
                        </div>
                        <div class="text-sm text-gray-600 mt-1">${transaction.description}</div>
                        <div class="text-xs text-gray-500">${transaction.category} ‚Ä¢ ${transaction.date}</div>
                    </div>
                    <div class="text-xs text-blue-600 font-mono">
                        ${transaction.registrationNumber || 'APORTACI√ìN'}
                    </div>
                </div>
            </div>
        `).join('');
    }

    // üí∞ GESTI√ìN DE GASTOS
    showExpenseTypeModal() {
        if (!this.selectedProjectId) {
            this.showAlert(
                'Proyecto Requerido',
                'Por favor selecciona un proyecto antes de registrar un gasto.',
                'fas fa-exclamation-triangle text-yellow-500'
            );
            return;
        }
        
        document.getElementById('expenseTypeModal').classList.add('show');
    }

    hideExpenseTypeModal() {
        document.getElementById('expenseTypeModal').classList.remove('show');
    }

    selectExpenseType(type) {
        this.currentExpenseType = type;
        this.hideExpenseTypeModal();
        this.showExpenseModal();
    }

    showExpenseModal() {
        // Reset form
        document.getElementById('expenseForm').reset();
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        
        // Configure modal based on type
        const modal = document.getElementById('expenseModal');
        const title = document.getElementById('expenseModalTitle');
        const fileSection = document.getElementById('fileSection');
        const facturaSection = document.getElementById('facturaFilesSection');
        
        // Reset visibility
        fileSection.classList.add('hidden');
        facturaSection.classList.add('hidden');
        document.getElementById('imagePreview').classList.add('hidden');
        document.getElementById('xmlStatus').classList.add('hidden');
        document.getElementById('pdfStatus').classList.add('hidden');

        switch(this.currentExpenseType) {
            case 'factura':
                title.textContent = 'üìÑ Registrar Factura (XML + PDF)';
                facturaSection.classList.remove('hidden');
                break;
            case 'ticket':
                title.textContent = 'üé´ Registrar Ticket/Recibo';
                fileSection.classList.remove('hidden');
                document.getElementById('fileInput').accept = 'image/*';
                break;
            case 'manual':
                title.textContent = '‚úèÔ∏è Registro Manual';
                break;
        }
        
        modal.classList.add('show');
    }

    hideExpenseModal() {
        document.getElementById('expenseModal').classList.remove('show');
        this.currentExpenseType = null;
        this.ocrInProgress = false;
    }

    // üìÑ MANEJO DE ARCHIVOS XML
    async handleXMLFileChange(e) {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const xmlText = await this.readFileAsText(file);
            const xmlData = this.parseXMLInvoice(xmlText);
            
            if (xmlData) {
                // Fill form with XML data
                document.getElementById('expenseAmount').value = xmlData.total || '';
                document.getElementById('expenseDescription').value = xmlData.concepto || '';
                document.getElementById('expenseDate').value = xmlData.fecha || document.getElementById('expenseDate').value;
                
                // Show success status
                document.getElementById('xmlStatus').classList.remove('hidden');
                
                // Store XML data and file content
                this.currentXMLData = xmlData;
                this.currentXMLFileData = await this.fileToBase64(file);
            }
        } catch (error) {
            console.error('Error processing XML:', error);
            this.showAlert(
                'Error XML',
                'No se pudo procesar el archivo XML. Verifica que sea un archivo CFDI v√°lido.',
                'fas fa-file-alt text-red-500'
            );
        }
    }

    parseXMLInvoice(xmlText) {
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            
            // Check for parsing errors
            if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                throw new Error('XML parsing error');
            }

            // Get comprobante (main element)
            const comprobante = xmlDoc.getElementsByTagName('cfdi:Comprobante')[0] || 
                              xmlDoc.getElementsByTagName('Comprobante')[0];
            
            if (!comprobante) {
                throw new Error('Not a valid CFDI');
            }

            // Extract basic data
            const xmlData = {
                version: comprobante.getAttribute('Version'),
                fecha: comprobante.getAttribute('Fecha')?.split('T')[0],
                folio: comprobante.getAttribute('Folio'),
                serie: comprobante.getAttribute('Serie'),
                total: comprobante.getAttribute('Total'),
                subtotal: comprobante.getAttribute('SubTotal'),
                moneda: comprobante.getAttribute('Moneda') || 'MXN'
            };

            // Extract emisor (issuer)
            const emisor = xmlDoc.getElementsByTagName('cfdi:Emisor')[0] || 
                          xmlDoc.getElementsByTagName('Emisor')[0];
            if (emisor) {
                xmlData.emisor = {
                    rfc: emisor.getAttribute('Rfc'),
                    nombre: emisor.getAttribute('Nombre')
                };
            }

            // Extract first concept for description
            const conceptos = xmlDoc.getElementsByTagName('cfdi:Concepto') ||
                            xmlDoc.getElementsByTagName('Concepto');
            if (conceptos.length > 0) {
                const concepto = conceptos[0];
                xmlData.concepto = concepto.getAttribute('Descripcion') || 
                                 concepto.getAttribute('descripcion');
            }

            return xmlData;
        } catch (error) {
            console.error('XML parsing error:', error);
            return null;
        }
    }

    // üìÑ MANEJO DE ARCHIVOS PDF
    async handlePDFFileChange(e) {
        const file = e.target.files[0];
        if (!file) return;

        try {
            this.currentPDFFileData = await this.fileToBase64(file);
            document.getElementById('pdfStatus').classList.remove('hidden');
        } catch (error) {
            console.error('Error processing PDF:', error);
            this.showCustomConfirm(
                'Error PDF',
                'No se pudo procesar el archivo PDF.',
                () => {}
            );
        }
    }

    // üñºÔ∏è MANEJO DE IM√ÅGENES Y OCR
    async handleFileChange(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Show image preview
        const preview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImg.src = e.target.result;
            preview.classList.remove('hidden');
            
            // Store file data
            this.currentFileData = e.target.result;
            
            // Start OCR processing
            this.processImageWithOCR(e.target.result);
        };
        reader.readAsDataURL(file);
    }

    async processImageWithOCR(imageData) {
        if (this.ocrInProgress) return;
        
        this.ocrInProgress = true;
        const saveBtn = document.getElementById('saveExpenseBtn');
        const originalText = saveBtn.innerHTML;
        
        try {
            // Show OCR progress
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Procesando OCR...';
            saveBtn.disabled = true;

            // Process with Tesseract
            const { data: { text } } = await Tesseract.recognize(imageData, 'spa', {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        const progress = Math.round(m.progress * 100);
                        saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>OCR ${progress}%`;
                    }
                }
            });

            // Extract amount from OCR text
            const detectedAmount = this.extractAmountFromText(text);
            
            if (detectedAmount) {
                document.getElementById('expenseAmount').value = detectedAmount;
                
                // Show success message
                saveBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Monto detectado: $' + detectedAmount;
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }, 2000);
            } else {
                throw new Error('No se pudo detectar el monto');
            }

        } catch (error) {
            console.error('OCR Error:', error);
            saveBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>OCR fall√≥ - Ingresar manualmente';
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }, 3000);
        } finally {
            this.ocrInProgress = false;
        }
    }

    extractAmountFromText(text) {
        // Mexican receipt patterns
        const patterns = [
            /TOTAL[:\s]*\$?\s*([0-9]{1,3}(?:,?[0-9]{3})*\.?[0-9]{0,2})/i,
            /IMPORTE[:\s]*\$?\s*([0-9]{1,3}(?:,?[0-9]{3})*\.?[0-9]{0,2})/i,
            /\$\s*([0-9]{1,3}(?:,?[0-9]{3})*\.?[0-9]{0,2})/,
            /([0-9]{1,3}(?:,?[0-9]{3})*\.[0-9]{2})/,
            /PAGAR[:\s]*\$?\s*([0-9]{1,3}(?:,?[0-9]{3})*\.?[0-9]{0,2})/i
        ];

        for (const pattern of patterns) {
            const match = text.match(pattern);
            if (match) {
                let amount = match[1].replace(/,/g, '');
                const numAmount = parseFloat(amount);
                
                // Validate reasonable amount range
                if (numAmount > 0 && numAmount < 1000000) {
                    return numAmount.toFixed(2);
                }
            }
        }

        return null;
    }

    // üí∞ VALIDACI√ìN DE MONTOS
    validateAmount() {
        const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
        const warning = document.getElementById('balanceWarning');
        
        if (!this.selectedProjectId) return;
        
        const available = this.dataManager.getAvailableBudget(this.selectedProjectId);
        
        if (amount > available) {
            warning.classList.remove('hidden');
        } else {
            warning.classList.add('hidden');
        }
    }

    // üíæ GUARDAR GASTO
    async handleExpenseSubmit(e) {
        e.preventDefault();
        
        if (this.ocrInProgress) {
            this.showCustomConfirm(
                'OCR en Proceso',
                'Espera a que termine el procesamiento OCR antes de guardar.',
                () => {}
            );
            return;
        }

        try {
            const formData = new FormData(e.target);
            
            const expenseData = {
                projectId: this.selectedProjectId,
                type: this.currentExpenseType,
                date: formData.get('date') || document.getElementById('expenseDate').value,
                amount: formData.get('amount') || document.getElementById('expenseAmount').value,
                category: formData.get('category') || document.getElementById('expenseCategory').value,
                description: formData.get('description') || document.getElementById('expenseDescription').value
            };

            // Validate required fields
            if (!expenseData.date || !expenseData.amount || !expenseData.category || !expenseData.description) {
                throw new Error('Por favor completa todos los campos requeridos');
            }

            // Add file data based on type
            if (this.currentExpenseType === 'factura') {
                if (!this.currentXMLFileData) {
                    throw new Error('Se requiere el archivo XML para facturas');
                }
                if (!this.currentPDFFileData) {
                    throw new Error('Se requiere el archivo PDF para facturas');
                }
                
                expenseData.xmlFileData = this.currentXMLFileData;
                expenseData.pdfFileData = this.currentPDFFileData;
                expenseData.xmlData = this.currentXMLData;
            } else if (this.currentExpenseType === 'ticket') {
                if (!this.currentFileData) {
                    throw new Error('Se requiere la imagen del ticket');
                }
                expenseData.fileData = this.currentFileData;
            }

            // Save expense
            const savedExpense = this.dataManager.addExpense(expenseData);
            
            // Show success and update UI
            this.hideExpenseModal();
            this.updateBalance();
            this.loadRecentExpenses();
            
            this.showCustomConfirm(
                '‚úÖ Gasto Registrado',
                '¬øDeseas registrar otro gasto?',
                () => {
                    // S√ç - Registrar otro gasto
                    this.showExpenseTypeModal();
                },
                'S√ç, registrar otro',
                'NO, cerrar sesi√≥n',
                () => {
                    // NO - Cerrar sesi√≥n directamente
                    this.dataManager.logout();
                    this.showLogin();
                }
            );
            
        } catch (error) {
            console.error('Error saving expense:', error);
            this.showCustomConfirm(
                'Error',
                error.message || 'No se pudo guardar el gasto',
                () => {}
            );
        }
    }

    // üìä EXPORTACI√ìN DE DATOS
    async handleExport() {

        if (!this.selectedProjectId) {
            this.showCustomConfirm(
                'Proyecto Requerido',
                'Selecciona un proyecto para exportar sus datos.',
                () => {}
            );
            return;
        }

        const project = this.dataManager.projects.find(p => p.id === this.selectedProjectId);
        const currentMonth = new Date().toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
        
        // Mostrar opciones SIN hacer nada autom√°ticamente
        this.showCustomConfirm(
            'üìä Exportaci√≥n de Datos',
            `Selecciona la acci√≥n que deseas realizar:\n\nüìÅ DESCARGAR: Solo exporta los datos del proyecto "${project.name}" a CSV\n\nüìÖ CERRAR MES: Exporta datos + Archiva gastos de ${currentMonth} + Reinicia contadores\n\n‚ö†Ô∏è El cierre mensual afecta TODOS los proyectos y NO se puede deshacer.`,
            () => {
                // CERRAR MES

                this.checkAndPerformMonthlyClose();
            },
            'Cerrar Mes',
            'Descargar',
            () => {
                // SOLO DESCARGAR
                this.justDownloadCSV();
            }
        );
    }

    // üìã MODALES ADMINISTRATIVOS


    loadProjectsInModal() {
        const container = document.getElementById('currentProjects');
        
        if (this.dataManager.projects.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay proyectos registrados</p>';
            return;
        }

        container.innerHTML = this.dataManager.projects.map(project => {
            const expenses = this.dataManager.getProjectExpenses(project.id);
            const totalBudget = this.dataManager.getTotalBudget(project.id);
            const available = this.dataManager.getAvailableBudget(project.id);
            const percentage = totalBudget > 0 ? (project.spent / totalBudget) * 100 : 0;
            const totalContributions = (project.contributions || []).reduce((sum, contrib) => sum + contrib.amount, 0);
            
            return `
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-lg">${project.name}</h4>
                            <p class="text-sm text-gray-600">${expenses.length} gastos ‚Ä¢ ${project.contributions.length} aportaciones</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="app.showContributionModal('${project.id}')" 
                                    class="text-green-500 hover:text-green-700 p-1" 
                                    title="Agregar aportaci√≥n">
                                <i class="fas fa-plus-circle"></i>
                            </button>
                            <button onclick="app.deleteProject('${project.id}')" 
                                    class="text-red-500 hover:text-red-700 p-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Presupuesto usado</span>
                            <span>${percentage.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="space-y-2">
                            <div>
                                <label class="block text-gray-600">Presupuesto Original:</label>
                                <div class="font-medium text-blue-600">$${project.originalBudget.toLocaleString()}</div>
                            </div>
                            <div>
                                <label class="block text-gray-600">Aportaciones:</label>
                                <div class="font-medium text-green-600">+$${totalContributions.toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <label class="block text-gray-600">Total Presupuesto:</label>
                                <div class="font-bold text-lg">$${totalBudget.toLocaleString()}</div>
                            </div>
                            <div>
                                <label class="block text-gray-600">Disponible:</label>
                                <div class="font-medium ${available >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    $${available.toLocaleString()}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="block text-gray-600 text-sm">Gastado:</label>
                        <div class="font-medium text-red-600">-$${project.spent.toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    async handleAddProject(e) {
        e.preventDefault();
        
        try {
            const projectData = {
                name: document.getElementById('newProjectName').value,
                budget: parseFloat(document.getElementById('newProjectBudget').value)
            };

            this.dataManager.addProject(projectData);
            this.loadProjects(); // Reload project selector
            this.loadProjectsInModal(); // Reload modal
            this.loadProjectsSection(); // Reload inline section
            
            // Reset form
            e.target.reset();
            
            this.showCustomConfirm(
                'Proyecto Creado',
                `El proyecto "${projectData.name}" ha sido creado exitosamente.`,
                () => {}
            );

        } catch (error) {
            console.error('Error creating project:', error);
            this.showCustomConfirm(
                'Error',
                error.message || 'No se pudo crear el proyecto',
                () => {}
            );
        }
    }

    deleteProject(projectId) {
        const project = this.dataManager.projects.find(p => p.id === projectId);
        if (!project) return;

        this.showCustomConfirm(
            'Eliminar Proyecto',
            `¬øEst√°s seguro de eliminar el proyecto "${project.name}"? Esta acci√≥n no se puede deshacer.`,
            () => {
                this.dataManager.deleteProject(projectId);
                this.loadProjects();
                this.loadProjectsInModal();
                
                if (this.selectedProjectId === projectId) {
                    this.selectedProjectId = null;
                    document.getElementById('projectSelect').value = '';
                    this.handleProjectChange({ target: { value: '' } });
                }
            }
        );
    }

    // üí∞ GESTI√ìN DE APORTACIONES
    showContributionModal(projectId) {
        this.selectedProjectForContribution = projectId;
        document.getElementById('contributionDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('contributionForm').reset();
        document.getElementById('contributionDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('contributionModal').classList.add('show');
    }

    hideContributionModal() {
        document.getElementById('contributionModal').classList.remove('show');
        this.selectedProjectForContribution = null;
    }

    async handleContributionSubmit(e) {
        e.preventDefault();
        
        try {
            const contributionData = {
                date: document.getElementById('contributionDate').value,
                amount: document.getElementById('contributionAmount').value,
                description: document.getElementById('contributionDescription').value
            };

            // Validate required fields
            if (!contributionData.date || !contributionData.amount || !contributionData.description) {
                throw new Error('Por favor completa todos los campos requeridos');
            }

            // Save contribution
            const savedContribution = this.dataManager.addContribution(this.selectedProjectForContribution, contributionData);
            
            // Update UI
            this.hideContributionModal();
            this.loadProjects(); // Reload project selector
            this.loadProjectsInModal(); // Reload modal
            this.loadProjectsSection(); // Reload inline section
            if (this.selectedProjectId === this.selectedProjectForContribution) {
                this.updateBalance();
                this.loadRecentExpenses();
            }
            
            this.showCustomConfirm(
                '‚úÖ Aportaci√≥n Registrada',
                `Aportaci√≥n de $${parseFloat(contributionData.amount).toLocaleString('es-MX', { minimumFractionDigits: 2 })} registrada exitosamente.`,
                () => {}
            );
            
        } catch (error) {
            console.error('Error saving contribution:', error);
            this.showCustomConfirm(
                'Error',
                error.message || 'No se pudo guardar la aportaci√≥n',
                () => {}
            );
        }
    }

    // üë• GESTI√ìN DE USUARIOS
    showUsersModal() {
        this.loadUsersInModal();
        this.loadPendingUsers(); // Cargar tambi√©n solicitudes pendientes
        document.getElementById('usersModal').classList.add('show');
        
        // Limpiar badge al abrir el modal
        this.updatePendingRequestsBadge();
    }

    hideUsersModal() {
        document.getElementById('usersModal').classList.remove('show');
    }

    loadUsersInModal() {
        console.log('üë• DEBUG: loadUsersInModal() iniciando');
        
        const container = document.getElementById('currentUsers');
        console.log('üë• DEBUG: Container encontrado:', !!container);
        
        const users = this.dataManager.users;
        console.log('üë• DEBUG: Usuarios en dataManager:', users);
        console.log('üë• DEBUG: Cantidad de usuarios:', users.length);
        
        const adminCount = users.filter(u => u.role === 'admin').length;
        console.log('üë• DEBUG: Cantidad de admins:', adminCount);
        
        if (!container) {
            console.error('‚ùå ERROR: No se encontr√≥ el contenedor #currentUsers');
            return;
        }
        
        if (users.length === 0) {
            console.log('üë• DEBUG: No hay usuarios, mostrando mensaje vac√≠o');
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-users text-3xl mb-3"></i>
                    <p>No hay usuarios registrados</p>
                </div>
            `;
            return;
        }

        console.log('üë• DEBUG: Generando HTML para usuarios...');
        
        const html = users.map(user => `
            <div class="bg-white p-4 rounded-lg border shadow-sm">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="font-bold text-gray-800">${user.name}</h4>
                            <span class="inline-block px-2 py-1 text-xs rounded-full ${user.role === 'admin' ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800'}">
                                ${user.role === 'admin' ? 'üëë Admin' : 'üë§ Usuario'}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mb-1">üìß ${user.email}</p>
                        <p class="text-xs text-gray-500">
                            ${user.createdDate ? 'üìÖ Creado: ' + new Date(user.createdDate).toLocaleDateString('es-ES') : 'Usuario del sistema'}
                        </p>
                    </div>
                    <div class="flex gap-2 ml-4">
                        <button onclick="app.editUser('${user.id}')" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm"
                                title="Editar usuario">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="app.confirmDeleteUser('${user.id}')" 
                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm ${user.role === 'admin' && adminCount <= 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${user.role === 'admin' && adminCount <= 1 ? 'disabled' : ''}
                                title="${user.role === 'admin' && adminCount <= 1 ? 'No se puede eliminar el √∫ltimo admin' : 'Eliminar usuario'}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
        console.log('üë• DEBUG: HTML generado:', html.substring(0, 200) + '...');
        container.innerHTML = html;
        console.log('üë• DEBUG: HTML asignado al container');
    }

    // üë• NUEVA FUNCI√ìN: Cargar usuarios registrados directamente en la interfaz
    loadRegisteredUsers() {
        console.log('üë• Cargando usuarios registrados en secci√≥n dedicada');
        
        const container = document.getElementById('registeredUsersContainer');
        const counter = document.getElementById('usersCount');
        
        if (!container) {
            console.error('‚ùå No se encontr√≥ #registeredUsersContainer');
            return;
        }
        
        const users = this.dataManager.users;
        const adminCount = users.filter(u => u.role === 'admin').length;
        
        // Actualizar contador
        if (counter) {
            counter.textContent = `${users.length} usuario${users.length !== 1 ? 's' : ''}`;
            counter.className = 'bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold';
        }
        
        if (users.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-users text-3xl mb-3"></i>
                    <p class="font-medium">No hay usuarios registrados</p>
                    <p class="text-sm">Agrega usuarios con el bot√≥n verde</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = users.map(user => `
            <div class="bg-gradient-to-r from-gray-50 to-blue-50 p-4 rounded-lg border shadow-sm hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="font-bold text-gray-800">${user.name}</h4>
                            <span class="inline-block px-3 py-1 text-xs rounded-full font-semibold ${user.role === 'admin' ? 'bg-orange-100 text-orange-700 border border-orange-200' : 'bg-blue-100 text-blue-700 border border-blue-200'}">
                                ${user.role === 'admin' ? 'üëë Administrador' : 'üë§ Usuario'}
                            </span>
                            ${user.isFirstLogin ? '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 text-xs rounded-full font-semibold">üîë Primer Login</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-700 mb-1">üìß ${user.email}</p>
                        <div class="flex items-center gap-4 text-xs text-gray-500">
                            ${user.createdDate ? `<span>üìÖ ${new Date(user.createdDate).toLocaleDateString('es-ES')}</span>` : '<span>üë§ Usuario del sistema</span>'}
                            ${user.passwordChangedDate ? `<span>üîë ${new Date(user.passwordChangedDate).toLocaleDateString('es-ES')}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="app.editUser('${user.id}')" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm"
                                title="Editar usuario">
                            <i class="fas fa-edit mr-1"></i>Editar
                        </button>
                        <button onclick="app.confirmDeleteUser('${user.id}')" 
                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm ${user.role === 'admin' && adminCount <= 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${user.role === 'admin' && adminCount <= 1 ? 'disabled' : ''}
                                title="${user.role === 'admin' && adminCount <= 1 ? 'No se puede eliminar el √∫ltimo admin' : 'Eliminar usuario'}">
                            <i class="fas fa-trash mr-1"></i>Borrar
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
        console.log(`üë• ${users.length} usuarios cargados en secci√≥n dedicada`);
    }





    // üé® EFECTOS 3D PARA TARJETAS ACTIVAS
    addActiveEffect(button) {
        if (!button) return;
        
        // Agregar efectos 3D y animaciones
        button.classList.add('transform', 'scale-105', 'shadow-2xl', 'ring-4', 'ring-white', 'ring-opacity-50');
        button.style.transform = 'translateY(-2px) scale(1.05)';
        button.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
        button.style.background = 'linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 100%)';
        button.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        
        console.log('üé® Efecto 3D activado para:', button.id);
    }

    removeActiveEffect(buttons) {
        buttons.forEach(button => {
            if (!button) return;
            
            // Remover efectos 3D
            button.classList.remove('transform', 'scale-105', 'shadow-2xl', 'ring-4', 'ring-white', 'ring-opacity-50');
            button.style.transform = '';
            button.style.boxShadow = '';
            button.style.background = '';
            
            console.log('üé® Efecto 3D removido de:', button.id);
        });
    }

    toggleProjectsSection() {
        const projectsCard = document.getElementById('projectsManagementCard');
        const requestsCard = document.getElementById('requestsManagementCard');
        const usersCard = document.getElementById('usersManagementCard');
        const projectsBtn = document.getElementById('manageProjectsBtn');
        const requestsBtn = document.getElementById('manageRequestsBtn');
        const usersBtn = document.getElementById('manageUsersBtn');
        
        // Ocultar otras secciones
        requestsCard.classList.add('hidden');
        usersCard.classList.add('hidden');
        this.removeActiveEffect([requestsBtn, usersBtn]);
        
        if (projectsCard.classList.contains('hidden')) {
            projectsCard.classList.remove('hidden');
            this.addActiveEffect(projectsBtn);
            this.loadProjectsSection();
        } else {
            projectsCard.classList.add('hidden');
            this.removeActiveEffect([projectsBtn]);
        }
    }

    // üìã CARGAR PROYECTOS CON LAYOUT FINANCIERO COMPLETO
    loadProjectsSection() {
        console.log('üìã Cargando proyectos en secci√≥n dedicada');
        
        const container = document.getElementById('registeredProjectsContainer');
        const counter = document.getElementById('projectsCount');
        
        if (!container) {
            console.error('‚ùå No se encontr√≥ #registeredProjectsContainer');
            return;
        }
        
        const projects = this.dataManager.projects;
        
        // Actualizar contador
        if (counter) {
            counter.textContent = `${projects.length} proyecto${projects.length !== 1 ? 's' : ''}`;
            counter.className = 'bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold';
        }
        
        if (projects.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-project-diagram text-3xl mb-3"></i>
                    <p class="font-medium">No hay proyectos registrados</p>
                    <p class="text-sm">Agrega proyectos con el bot√≥n verde</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = projects.map(project => {
            const totalExpenses = this.dataManager.getTotalExpensesByProject(project.id);
            const totalBudget = this.dataManager.getTotalBudget(project.id);
            const originalBudget = project.originalBudget || 0;
            const contributions = project.contributions || [];
            const totalContributions = contributions.reduce((sum, c) => sum + parseFloat(c.amount || 0), 0);
            const available = totalBudget - totalExpenses;
            const usedPercentage = totalBudget > 0 ? Math.round((totalExpenses / totalBudget) * 100) : 0;
            
            const expenseCount = this.dataManager.getProjectExpenses(project.id).length;
            const contributionCount = contributions.length;
            
            const progressClass = usedPercentage > 90 ? 'bg-red-500' : usedPercentage > 70 ? 'bg-orange-500' : 'bg-green-500';
            
            return `
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin: 10px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <!-- Encabezado: T√≠tulo y botones -->
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-xl font-bold text-black">${project.name}</h3>
                            <p class="text-gray-500 text-sm">${expenseCount} gastos ‚Ä¢ ${contributionCount} aportaciones</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="addContribution('${project.id}')" 
                                    class="w-8 h-8 bg-green-500 hover:bg-green-600 text-white rounded-full flex items-center justify-center transition-colors"
                                    title="Agregar aportaci√≥n">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                            <button onclick="deleteProject('${project.id}')" 
                                    class="w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center transition-colors"
                                    title="Eliminar proyecto">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Barra de progreso -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-black">Presupuesto usado</span>
                            <span class="text-black font-bold">${usedPercentage.toFixed(1)}%</span>
                        </div>
                        <div class="w-full h-2 bg-gray-200 rounded-full">
                            <div class="h-2 rounded-full ${progressClass}" 
                                 style="width: ${Math.min(usedPercentage, 100)}%"></div>
                        </div>
                    </div>
                    
                    <!-- Layout vertical como en la imagen -->
                    <div class="space-y-3">
                        <!-- Presupuesto Original -->
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">Presupuesto Original:</span>
                            <span class="text-blue-600 font-bold text-lg">$${originalBudget.toLocaleString()}</span>
                        </div>
                        
                        <!-- Total Presupuesto -->
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">Total Presupuesto:</span>
                            <span class="text-black font-bold text-xl">$${totalBudget.toLocaleString()}</span>
                        </div>
                        
                        <!-- Aportaciones -->
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">Aportaciones:</span>
                            <span class="text-green-600 font-bold text-lg">+$${totalContributions.toLocaleString()}</span>
                        </div>
                        
                        <!-- Disponible -->
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">Disponible:</span>
                            <span class="text-green-600 font-bold text-lg">$${available.toLocaleString()}</span>
                        </div>
                        
                        <!-- Gastado -->
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">Gastado:</span>
                            <span class="text-red-600 font-bold text-lg">-$${totalExpenses.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        console.log(`üìã ${projects.length} proyectos cargados en secci√≥n dedicada`);
    }

    // üìã CARGAR SOLICITUDES PENDIENTES
    loadPendingRequestsSection() {
        console.log('üìã Cargando solicitudes pendientes en secci√≥n dedicada');
        
        const container = document.getElementById('pendingRequestsContainer');
        const counter = document.getElementById('requestsCount');
        
        if (!container) {
            console.error('‚ùå No se encontr√≥ #pendingRequestsContainer');
            return;
        }
        
        const pendingUsers = this.dataManager.getPendingUsers();
        
        // Actualizar contador
        if (counter) {
            counter.textContent = `${pendingUsers.length} pendiente${pendingUsers.length !== 1 ? 's' : ''}`;
            counter.className = pendingUsers.length > 0 
                ? 'bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-semibold'
                : 'bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs font-semibold';
        }
        
        if (pendingUsers.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-inbox text-3xl mb-3"></i>
                    <p class="font-medium">No hay solicitudes pendientes</p>
                    <p class="text-sm">Las nuevas solicitudes aparecer√°n aqu√≠</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = pendingUsers.map(request => `
            <div class="bg-gradient-to-r from-orange-50 to-yellow-50 border-2 border-orange-200 rounded-lg p-4 shadow-sm">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="font-bold text-gray-800">${request.name}</h4>
                            <span class="bg-orange-100 text-orange-700 px-2 py-1 text-xs rounded-full font-semibold">
                                ‚è≥ Pendiente
                            </span>
                        </div>
                        <p class="text-sm text-gray-700 mb-1">üìß ${request.email}</p>
                        <p class="text-sm text-gray-600 mb-2">üí¨ ${request.message || 'Sin mensaje'}</p>
                        <p class="text-xs text-gray-500">
                            üìÖ Solicitado: ${new Date(request.requestDate).toLocaleDateString('es-ES')}
                        </p>
                    </div>
                    <div class="flex gap-2 ml-4">
                        <button onclick="approveUser('${request.id}')" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                                title="Aprobar solicitud">
                            <i class="fas fa-check mr-1"></i>Aprobar
                        </button>
                        <button onclick="rejectUser('${request.id}')" 
                                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                                title="Rechazar solicitud">
                            <i class="fas fa-times mr-1"></i>Rechazar
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
        console.log(`üìã ${pendingUsers.length} solicitudes pendientes cargadas`);
    }

    // üìã CARGAR SOLICITUDES EN SU SECCI√ìN DEDICADA
    loadPendingRequestsSection() {
        console.log('üìã Cargando solicitudes pendientes en secci√≥n dedicada');
        
        const container = document.getElementById('pendingRequestsContainer');
        const counter = document.getElementById('requestsCount');
        
        if (!container) {
            console.error('‚ùå No se encontr√≥ #pendingRequestsContainer');
            return;
        }
        
        const pendingUsers = this.dataManager.getPendingUsers().filter(u => u.status === 'pending');
        
        // Actualizar contador
        if (counter) {
            counter.textContent = `${pendingUsers.length} pendiente${pendingUsers.length !== 1 ? 's' : ''}`;
            counter.className = pendingUsers.length > 0 
                ? 'bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-semibold animate-pulse'
                : 'bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs font-semibold';
        }
        
        if (pendingUsers.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-inbox text-3xl mb-3"></i>
                    <p class="font-medium">No hay solicitudes pendientes</p>
                    <p class="text-sm">Las nuevas solicitudes aparecer√°n aqu√≠</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = pendingUsers.map(request => `
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-lg border-l-4 border-orange-400 shadow-sm">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="font-bold text-gray-800">${request.name}</h4>
                            <span class="bg-orange-100 text-orange-700 px-2 py-1 text-xs rounded-full font-semibold">
                                üìÖ ${new Date(request.requestDate).toLocaleDateString('es-ES')}
                            </span>
                        </div>
                        <p class="text-sm text-gray-700 mb-2">üìß ${request.email}</p>
                        ${request.message ? `<div class="bg-white bg-opacity-70 p-2 rounded text-sm text-gray-700 italic border-l-2 border-orange-300">
                            "${request.message}"
                        </div>` : ''}
                    </div>
                    <div class="flex gap-2 ml-4">
                        <button onclick="app.approveUserRequest('${request.id}')" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm"
                                title="Aprobar solicitud">
                            <i class="fas fa-check mr-1"></i>Aprobar
                        </button>
                        <button class="reject-user-btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm" 
                                data-request-id="${request.id}"
                                title="Rechazar solicitud">
                            <i class="fas fa-times mr-1"></i>Rechazar
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Agregar event listeners para botones de rechazo
        const rejectButtons = container.querySelectorAll('.reject-user-btn');
        rejectButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const requestId = e.target.closest('.reject-user-btn').getAttribute('data-request-id');
                this.promptAndRejectUser(requestId);
            });
        });
        
        console.log(`üìã ${pendingUsers.length} solicitudes cargadas en secci√≥n dedicada`);
    }

    loadPendingUsers() {
        const container = document.getElementById('pendingRequests');
        const pendingUsers = this.dataManager.getPendingUsers().filter(u => u.status === 'pending');
        
        if (pendingUsers.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-inbox text-3xl mb-3"></i>
                    <p>No hay solicitudes pendientes</p>
                </div>
            `;
            return;
        }

        container.innerHTML = pendingUsers.map(request => `
            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-800">${request.name}</h4>
                        <p class="text-sm text-gray-600">${request.email}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            Solicitado: ${new Date(request.requestDate).toLocaleDateString('es-ES')}
                        </p>
                        ${request.message ? `<p class="text-sm text-gray-700 mt-2 italic">"${request.message}"</p>` : ''}
                    </div>
                    <div class="flex gap-2 ml-4">
                        <button onclick="app.approveUserRequest('${request.id}')" 
                                class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-check mr-1"></i>Aprobar
                        </button>
                        <button class="reject-user-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" 
                                data-request-id="${request.id}">
                            <i class="fas fa-times mr-1"></i>Rechazar
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Actualizar contador de notificaciones
        localStorage.setItem('idaconn_pending_notifications', pendingUsers.length.toString());
        this.updatePendingRequestsBadge();
        
        // Agregar event listeners para botones de rechazo
        const rejectButtons = document.querySelectorAll('.reject-user-btn');
        rejectButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const requestId = e.target.closest('.reject-user-btn').getAttribute('data-request-id');
                console.log('üö´ DEBUG: Bot√≥n rechazar clickeado para ID:', requestId);
                this.promptAndRejectUser(requestId);
            });
        });
    }

    async handleAddUser(e) {
        e.preventDefault();
        
        try {
            const userData = {
                name: document.getElementById('newUserName').value,
                email: document.getElementById('newUserEmail').value,
                password: document.getElementById('newUserPassword').value,
                role: document.getElementById('newUserRole').value
            };

            // Check if email already exists
            if (this.dataManager.users.find(u => u.email === userData.email)) {
                throw new Error('Ya existe un usuario con ese email');
            }

            this.dataManager.addUser(userData);
            this.loadUsersInModal();
            
            // Reset form
            e.target.reset();
            
            this.showCustomConfirm(
                'Usuario Creado',
                `Usuario "${userData.name}" creado exitosamente.`,
                () => {}
            );

        } catch (error) {
            console.error('Error creating user:', error);
            this.showCustomConfirm(
                'Error',
                error.message || 'No se pudo crear el usuario',
                () => {}
            );
        }
    }

    deleteUser(userId) {
        const user = this.dataManager.users.find(u => u.id === userId);
        if (!user) return;

        // Prevent deleting the last admin
        if (user.role === 'admin' && this.dataManager.users.filter(u => u.role === 'admin').length === 1) {
            this.showCustomConfirm(
                'No Permitido',
                'No puedes eliminar el √∫nico administrador del sistema.',
                () => {}
            );
            return;
        }

        this.showCustomConfirm(
            'Eliminar Usuario',
            `¬øEst√°s seguro de eliminar al usuario "${user.name}"?`,
            () => {
                this.dataManager.deleteUser(userId);
                this.loadUsersInModal();
            }
        );
    }

    // üìä REPORTES
    showReportsModal() {
        if (!this.selectedProjectId) {
            this.showCustomConfirm(
                'Proyecto Requerido',
                'Selecciona un proyecto para ver sus reportes.',
                () => {}
            );
            return;
        }
        
        // Mostrar modal
        document.getElementById('reportsModal').classList.add('show');
        
        // Generar reporte autom√°ticamente
        this.generateAutoReport();
    }

    hideReportsModal() {
        document.getElementById('reportsModal').classList.remove('show');
    }

    generateAutoReport() {
        // Obtener informaci√≥n del proyecto seleccionado
        const project = this.dataManager.projects.find(p => p.id === this.selectedProjectId);
        const totalBudget = this.dataManager.getTotalBudget(this.selectedProjectId);
        const available = this.dataManager.getAvailableBudget(this.selectedProjectId);
        
        // Actualizar informaci√≥n del proyecto en el modal
        document.getElementById('reportProjectName').textContent = `üìÅ ${project.name}`;
        document.getElementById('reportProjectInfo').textContent = `Presupuesto: $${totalBudget.toLocaleString()} | Disponible: $${available.toLocaleString()}`;
        
        // Obtener datos del proyecto seleccionado
        const reportData = this.getReportData(this.selectedProjectId);
        
        // Mostrar estad√≠sticas
        this.displayReportSummary(reportData);
        
        // Generar gr√°ficos
        this.generateCharts(reportData);
        
        // Mostrar tabla de detalle
        this.displayReportTable(reportData);
        
        // Mostrar todas las secciones
        document.getElementById('reportSummary').classList.remove('hidden');
        document.getElementById('reportCharts').classList.remove('hidden');
        document.getElementById('reportData').classList.remove('hidden');
    }

    getReportData(projectId = '') {
        let expenses = [];
        let contributions = [];
        let projectName = 'Todos los proyectos';
        
        if (projectId) {
            // Datos de un proyecto espec√≠fico
            expenses = this.dataManager.getProjectExpenses(projectId);
            const project = this.dataManager.projects.find(p => p.id === projectId);
            contributions = project ? project.contributions : [];
            projectName = project ? project.name : 'Proyecto no encontrado';
        } else {
            // Datos de todos los proyectos
            expenses = this.dataManager.expenses;
            this.dataManager.projects.forEach(project => {
                if (project.contributions) {
                    contributions = contributions.concat(project.contributions);
                }
            });
        }
        
        return { expenses, contributions, projectId, projectName };
    }

    displayReportSummary(reportData) {
        const { expenses, contributions } = reportData;
        
        // C√°lculos
        const totalExpenses = expenses.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
        const totalContributions = contributions.reduce((sum, cont) => sum + parseFloat(cont.amount), 0);
        const netBalance = totalContributions - totalExpenses;
        const avgExpense = expenses.length > 0 ? totalExpenses / expenses.length : 0;
        const totalMovements = expenses.length + contributions.length;
        
        // Actualizar elementos
        document.getElementById('totalExpenses').textContent = `$${totalExpenses.toLocaleString('es-MX', { minimumFractionDigits: 2 })}`;
        document.getElementById('expenseCount').textContent = `${expenses.length} gastos`;
        
        document.getElementById('totalContributions').textContent = `$${totalContributions.toLocaleString('es-MX', { minimumFractionDigits: 2 })}`;
        document.getElementById('contributionCount').textContent = `${contributions.length} aportaciones`;
        
        document.getElementById('netBalance').textContent = `$${netBalance.toLocaleString('es-MX', { minimumFractionDigits: 2 })}`;
        document.getElementById('balanceStatus').textContent = netBalance >= 0 ? 'Super√°vit' : 'D√©ficit';
        
        document.getElementById('avgExpense').textContent = `$${avgExpense.toLocaleString('es-MX', { minimumFractionDigits: 2 })}`;
        document.getElementById('totalMovements').textContent = `${totalMovements} movimientos`;
    }

    generateCharts(reportData) {
        const { expenses, contributions } = reportData;
        
        // Limpiar gr√°ficos existentes
        this.destroyExistingCharts();
        
        // Gr√°fico de gastos por categor√≠a
        this.createCategoryChart(expenses);
    }

    destroyExistingCharts() {
        try {
            if (this.categoryChart && typeof this.categoryChart.destroy === 'function') {
                this.categoryChart.destroy();
                this.categoryChart = null;
            }
        } catch (error) {
            console.warn('Error destroying charts:', error);
        }
    }

    createCategoryChart(expenses) {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        
        // Validar que hay gastos
        if (!expenses || expenses.length === 0) {
            this.categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Sin gastos'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#E5E7EB'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    }
                }
            });
            return;
        }
        
        // Agrupar por categor√≠a con validaci√≥n
        const categoryData = {};
        expenses.forEach(expense => {
            if (expense.amount && !isNaN(parseFloat(expense.amount))) {
                const category = expense.category || 'Sin categor√≠a';
                const amount = parseFloat(expense.amount);
                if (amount > 0) {
                    categoryData[category] = (categoryData[category] || 0) + amount;
                }
            }
        });
        
        const labels = Object.keys(categoryData);
        const data = Object.values(categoryData);
        
        // Si no hay datos v√°lidos
        if (labels.length === 0 || data.every(val => val === 0)) {
            this.createCategoryChart([]); // Recursi√≥n para mostrar gr√°fico vac√≠o
            return;
        }
        
        const colors = ['#EF4444', '#F97316', '#EAB308', '#22C55E', '#3B82F6', '#8B5CF6', '#EC4899', '#6B7280'];
        
        this.categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const value = context.parsed;
                                const total = data.reduce((sum, val) => sum + val, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${context.label}: $${value.toLocaleString('es-MX', { minimumFractionDigits: 2 })} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    displayReportTable(reportData) {
        const { expenses, contributions } = reportData;
        const tbody = document.getElementById('reportTableBody');
        
        // Combinar y ordenar todos los movimientos
        const allMovements = [];
        
        expenses.forEach(expense => {
            allMovements.push({
                ...expense,
                type: 'gasto',
                displayAmount: `-$${parseFloat(expense.amount).toLocaleString('es-MX', { minimumFractionDigits: 2 })}`,
                amountClass: 'text-red-600'
            });
        });
        
        contributions.forEach(contribution => {
            allMovements.push({
                ...contribution,
                type: 'aportaci√≥n',
                category: 'Aportaci√≥n',
                displayAmount: `+$${parseFloat(contribution.amount).toLocaleString('es-MX', { minimumFractionDigits: 2 })}`,
                amountClass: 'text-green-600'
            });
        });
        
        // Ordenar por fecha descendente
        allMovements.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        tbody.innerHTML = allMovements.map(movement => `
            <tr class="hover:bg-gray-50">
                <td class="border border-gray-300 px-4 py-2">
                    <span class="inline-block px-2 py-1 text-xs rounded ${movement.type === 'gasto' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                        ${movement.type.toUpperCase()}
                    </span>
                </td>
                <td class="border border-gray-300 px-4 py-2">${movement.date}</td>
                <td class="border border-gray-300 px-4 py-2">${movement.description}</td>
                <td class="border border-gray-300 px-4 py-2">${movement.category}</td>
                <td class="border border-gray-300 px-4 py-2 text-right font-medium ${movement.amountClass}">
                    ${movement.displayAmount}
                </td>
                <td class="border border-gray-300 px-4 py-2">${movement.userName}</td>
            </tr>
        `).join('');
    }

    exportReportData() {

        const project = this.dataManager.projects.find(p => p.id === this.selectedProjectId);
        const currentMonth = new Date().toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
        
        // SOLO mostrar el modal, SIN hacer nada m√°s
        this.showCustomConfirm(
            'üìä Exportaci√≥n de Datos',
            `Selecciona la acci√≥n que deseas realizar:\n\nüìÅ DESCARGAR: Solo exporta los datos del proyecto "${project.name}" a CSV\n\nüìÖ CERRAR MES: Exporta datos + Archiva gastos de ${currentMonth} + Reinicia contadores\n\n‚ö†Ô∏è El cierre mensual afecta TODOS los proyectos y NO se puede deshacer.`,
            () => {
                // CERRAR MES

                this.checkAndPerformMonthlyClose();
            },
            'Cerrar Mes',
            'Descargar',
            () => {
                // DESCARGAR
                this.justDownloadCSV();
            }
        );
    }
    
    justDownloadCSV() {
        console.log('üíæ Ejecutando descarga simple de CSV');
        const project = this.dataManager.projects.find(p => p.id === this.selectedProjectId);
        if (!project) {
            console.error('‚ùå No se encontr√≥ proyecto para descargar');
            this.hideConfirmModal();
            return;
        }
        
        const reportData = this.getReportData(this.selectedProjectId);
        const csvContent = this.generateReportCSV(reportData);
        const fileName = `IDACONN_${project.name.replace(/\s/g, '_')}_${new Date().toISOString().substring(0, 10)}.csv`;
        
        console.log('üìÅ Descargando archivo:', fileName);
        
        // Verificar si la funci√≥n existe antes de llamarla
        if (typeof this.downloadCSV === 'function') {
            this.downloadCSV(csvContent, fileName);
        } else {
            console.error('‚ùå downloadCSV no es una funci√≥n en justDownloadCSV');
            // Crear descarga manual
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            console.log('‚úÖ Descarga manual completada en justDownloadCSV');
        }
        
        // Cerrar el modal despu√©s de iniciar la descarga
        this.hideConfirmModal();
    }

    generateReportCSV(reportData) {
        const { expenses, contributions } = reportData;
        
        // Combinar movimientos
        const allMovements = [];
        
        expenses.forEach(expense => {
            allMovements.push({
                tipo: 'GASTO',
                fecha: expense.date,
                concepto: expense.description,
                categoria: expense.category,
                monto: `-${expense.amount}`,
                usuario: expense.userName,
                registro: expense.registrationNumber || ''
            });
        });
        
        contributions.forEach(contribution => {
            allMovements.push({
                tipo: 'APORTACION',
                fecha: contribution.date,
                concepto: contribution.description,
                categoria: 'Aportaci√≥n',
                monto: `+${contribution.amount}`,
                usuario: contribution.userName,
                registro: 'APORTACION'
            });
        });
        
        // Ordenar por fecha
        allMovements.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        
        const headers = ['Tipo', 'Fecha', 'Concepto', 'Categor√≠a', 'Monto (MXN)', 'Usuario', 'Registro'];
        const rows = allMovements.map(movement => [
            movement.tipo,
            movement.fecha,
            `"${movement.concepto.replace(/"/g, '""')}"`,
            movement.categoria,
            movement.monto,
            movement.usuario,
            movement.registro
        ]);
        
        const csvContent = [headers, ...rows]
            .map(row => row.join(','))
            .join('\n');
        
        // Descargar CSV
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        
        const { projectName } = reportData;
        const today = new Date().toISOString().split('T')[0];
        const cleanName = projectName.replace(/[^a-zA-Z0-9]/g, '_');
        link.download = `Reporte_${cleanName}_${today}.csv`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // üìÖ CIERRE MENSUAL
    checkAndPerformMonthlyClose() {
        console.log('üîç ENTRANDO A checkAndPerformMonthlyClose()');
        
        // Calcular d√≠as restantes del mes
        const today = new Date();
        const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        const daysRemaining = Math.ceil((lastDayOfMonth - today) / (1000 * 60 * 60 * 24));
        
        console.log('üìÖ Verificando cierre mensual:', {
            today: today.toLocaleDateString('es-ES'),
            lastDay: lastDayOfMonth.toLocaleDateString('es-ES'),
            daysRemaining: daysRemaining
        });
        
        if (daysRemaining > 7) {
            // Hay m√°s de 7 d√≠as restante - mostrar advertencia
            console.log('‚ö†Ô∏è Mostrando alerta de cierre prematuro. D√≠as restantes:', daysRemaining);
            this.showCustomConfirm(
                '‚ö†Ô∏è Cierre Prematuro',
                `¬øSeguro que quieres cerrar el mes ${daysRemaining} d√≠as antes?\n\nFaltan ${daysRemaining} d√≠as para fin de mes.\nEsta acci√≥n reiniciar√° TODOS los datos y NO se puede deshacer.`,
                () => {
                    // S√ç - Proceder con cierre prematuro
                    console.log('‚úÖ Usuario confirm√≥ cierre prematuro');

                    this.performMonthlyClose();
                },
                'S√≠, cerrar ahora',
                'No, cancelar',
                null
            );
        } else {
            // Es √∫ltima semana del mes (0-7 d√≠as) - proceder directamente
            console.log('üìÖ Estamos en la √∫ltima semana del mes, procediendo directamente');

            this.performMonthlyClose();
        }
    }

    performMonthlyClose() {
        console.log('üî• ENTRANDO A performMonthlyClose()');
        console.log('üî• Iniciando cierre mensual completo');
        
        try {
            // 1. Verificar que hay proyecto seleccionado
            console.log('üîç Debug proyecto seleccionado:', this.selectedProjectId);
            console.log('üîç Debug proyectos disponibles:', this.dataManager.projects);
            
            if (!this.selectedProjectId) {
                throw new Error('No hay proyecto seleccionado para exportar');
            }
            
            const project = this.dataManager.projects.find(p => p.id === this.selectedProjectId);
            console.log('üîç Debug proyecto encontrado:', project);
            
            if (!project) {
                // Si no encuentra el proyecto, usar el primer proyecto disponible
                console.log('‚ö†Ô∏è Proyecto no encontrado, usando primer proyecto disponible');
                const firstProject = this.dataManager.projects[0];
                if (firstProject) {
                    this.selectedProjectId = firstProject.id;
                    console.log('‚úÖ Proyecto seleccionado autom√°ticamente:', firstProject.name);
                } else {
                    throw new Error('No hay proyectos disponibles en el sistema');
                }
            }
            
            // 2. Obtener proyecto final (puede haber cambiado en la validaci√≥n)
            const finalProject = this.dataManager.projects.find(p => p.id === this.selectedProjectId);
            
            // 3. Exportar datos ANTES del cierre (con descarga autom√°tica)
            console.log('üìä Exportando datos del proyecto:', finalProject.name);
            const reportData = this.getReportData(this.selectedProjectId);
            const csvContent = this.generateReportCSV(reportData);
            console.log('üíæ Descargando CSV:', finalProject.name);
            console.log('üîç Verificando downloadCSV:', typeof this.downloadCSV);
            console.log('üîç This object:', this);
            
            // Verificar si la funci√≥n existe antes de llamarla
            if (typeof this.downloadCSV === 'function') {
                this.downloadCSV(csvContent, `IDACONN_${finalProject.name.replace(/\s/g, '_')}_${new Date().toISOString().substring(0, 7)}.csv`);
            } else {
                console.error('‚ùå downloadCSV no es una funci√≥n');
                // Crear descarga manual
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `IDACONN_${finalProject.name.replace(/\s/g, '_')}_${new Date().toISOString().substring(0, 7)}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                console.log('‚úÖ Descarga manual completada');
            }
            
            // 3. Cerrar el modal de confirmaci√≥n primero
            this.hideConfirmModal();
            
            // 4. Esperar un momento para que se complete la descarga
            setTimeout(() => {
                // 5. Realizar cierre mensual COMPLETO
                console.log('üîÑ Ejecutando reset mensual');
                this.dataManager.resetMonth();
                
                // 6. Recargar vista actual
                this.loadExpenses();
                this.loadProjects();
                
                // 7. Cerrar modales
                this.hideReportsModal();
                
                // 8. Mostrar confirmaci√≥n final
                alert('‚úÖ Cierre Mensual Completado\\n\\nüìÅ Datos exportados y descargados\\nüóÉÔ∏è Gastos archivados por mes\\nüîÑ Contadores reiniciados a 0\\nüí∞ Saldos gastados reiniciados\\n\\nLa p√°gina se recargar√° ahora.');
                
                // 9. Recargar p√°gina
                window.location.reload();
                
            }, 2000); // Esperar 2 segundos para la descarga
            
        } catch (error) {
            console.error('‚ùå Error during monthly close:', error);
            this.showCustomConfirm(
                '‚ùå Error en Cierre',
                'Hubo un problema durante el cierre mensual:\n\n' + error.message + '\n\nPor favor int√©ntalo de nuevo.',
                () => {},
                'Cerrar',
                '',
                null
            );
        }
    }

    // üîß UTILIDADES
    async readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsText(file);
        });
    }

    async fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // üí¨ DI√ÅLOGOS PERSONALIZADOS
    showCustomConfirm(title, message, onConfirm, confirmText = 'Cerrar Mes', cancelText = 'Descargar', onCancel = null) {

        
        // Cerrar cualquier modal abierto primero
        document.querySelectorAll('.modal.show').forEach(modal => {
            modal.classList.remove('show');
        });
        
        // Configurar contenido del modal
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').innerHTML = message.replace(/\n/g, '<br>');
        document.getElementById('confirmYesText').textContent = confirmText;
        document.getElementById('confirmNoText').textContent = cancelText;
        
        this.pendingConfirmAction = onConfirm;
        this.pendingCancelAction = onCancel;
        
        // Mostrar modal con delay para asegurar que se renderiza
        setTimeout(() => {
            const modal = document.getElementById('confirmModal');
            modal.classList.add('show');

        }, 100);
    }

    hideConfirmModal() {
        document.getElementById('confirmModal').classList.remove('show');
        this.pendingConfirmAction = null;
        this.pendingCancelAction = null;
    }

    confirmAction() {
        console.log('‚úÖ Ejecutando confirmAction');
        if (this.pendingConfirmAction) {
            console.log('‚úÖ Ejecutando acci√≥n de confirmar');
            this.pendingConfirmAction();
        }
        // El modal se cierra desde cada funci√≥n espec√≠fica seg√∫n su necesidad
    }

    cancelAction() {
        console.log('üîÑ Ejecutando cancelAction');
        if (this.pendingCancelAction) {
            console.log('‚úÖ Ejecutando acci√≥n de cancelar');
            this.pendingCancelAction();
        } else {
            console.log('‚ÑπÔ∏è No hay acci√≥n de cancelar definida');
        }
        // Cancelar siempre cierra el modal
        this.hideConfirmModal();
    }

    // üë• GESTI√ìN DE SOLICITUDES DE ACCESO
    showRequestAccessModal() {
        document.getElementById('requestAccessModal').classList.add('show');
        document.getElementById('requestName').focus();
    }

    hideRequestAccessModal() {
        document.getElementById('requestAccessModal').classList.remove('show');
        document.getElementById('accessRequestForm').reset();
    }

    async handleAccessRequest(e) {
        e.preventDefault();
        
        const name = document.getElementById('requestName').value.trim();
        const email = document.getElementById('requestEmail').value.trim();
        const message = document.getElementById('requestMessage').value.trim();

        if (!name || !email) {
            this.showAlert(
                'Campos Requeridos',
                'Por favor completa el nombre y email.',
                'fas fa-exclamation-triangle text-yellow-500'
            );
            return;
        }

        // Guardar solicitud en localStorage
        const request = this.dataManager.addUserRequest({ name, email, message });
        
        // Enviar notificaci√≥n al administrador
        await this.notifyAdminNewRequest(request);
        
        this.hideRequestAccessModal();
        this.showAlert(
            '‚úÖ Solicitud Enviada',
            `Gracias ${name}, tu solicitud ha sido enviada al administrador.\n\nRecibir√°s una respuesta en ${email} dentro de las pr√≥ximas 24-48 horas.`,
            'fas fa-check-circle text-green-500'
        );
    }

    async notifyAdminNewRequest(request) {
        // Notificaci√≥n interna - marcar que hay solicitudes pendientes
        this.markPendingRequestsAvailable();
        console.log('üîî Nueva solicitud registrada:', request.name, '(' + request.email + ')');
    }

    markPendingRequestsAvailable() {
        // Marcar en localStorage que hay solicitudes pendientes
        const pendingCount = this.dataManager.getPendingUsers().filter(u => u.status === 'pending').length;
        localStorage.setItem('idaconn_pending_notifications', pendingCount.toString());
        
        // Actualizar badge si el usuario actual es admin
        this.updatePendingRequestsBadge();
    }

    updatePendingRequestsBadge() {
        console.log('üîî DEBUG: updatePendingRequestsBadge() iniciando');
        
        const currentUser = this.dataManager.getCurrentUser();
        console.log('üîî DEBUG: Usuario actual:', currentUser);
        
        if (!currentUser || currentUser.role !== 'admin') {
            console.log('üîî DEBUG: Usuario no es admin, saliendo');
            return;
        }

        // Obtener conteo actual de usuarios pendientes directamente de los datos
        const pendingUsers = this.dataManager.getPendingUsers().filter(u => u.status === 'pending');
        const pendingCount = pendingUsers.length;
        
        console.log('üîî DEBUG: Usuarios pendientes encontrados:', pendingUsers);
        console.log('üîî DEBUG: Conteo de pendientes:', pendingCount);
        
        const manageRequestsBtn = document.getElementById('manageRequestsBtn');
        
        if (!manageRequestsBtn) {
            console.log('üîî DEBUG: No se encontr√≥ el bot√≥n manageRequestsBtn');
            return;
        }

        // Remover badge existente
        const existingBadge = manageRequestsBtn.querySelector('.notification-badge');
        if (existingBadge) {
            console.log('üîî DEBUG: Removiendo badge existente');
            existingBadge.remove();
        }

        if (pendingCount > 0) {
            console.log('üîî DEBUG: Creando nuevo badge GRANDE con conteo:', pendingCount);
            
            // Crear nuevo badge M√ÅS GRANDE Y NOTORIO
            const badge = document.createElement('span');
            badge.className = 'notification-badge absolute -top-3 -right-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-full min-w-8 h-8 flex items-center justify-center font-black animate-pulse border-4 border-white shadow-2xl';
            badge.textContent = pendingCount;
            badge.style.fontSize = '14px';
            badge.style.zIndex = '30';
            badge.style.boxShadow = '0 8px 20px rgba(239, 68, 68, 0.6), 0 0 0 6px rgba(239, 68, 68, 0.2), inset 0 2px 4px rgba(255, 255, 255, 0.3)';
            badge.style.animation = 'pulse 1.5s infinite, bounce 2s infinite alternate';
            
            // Agregar keyframes de animaci√≥n personalizada
            if (!document.getElementById('badgeAnimationStyles')) {
                const style = document.createElement('style');
                style.id = 'badgeAnimationStyles';
                style.textContent = `
                    @keyframes badgePulse {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.15); }
                    }
                    @keyframes badgeGlow {
                        0%, 100% { box-shadow: 0 8px 20px rgba(239, 68, 68, 0.6), 0 0 0 6px rgba(239, 68, 68, 0.2); }
                        50% { box-shadow: 0 12px 30px rgba(239, 68, 68, 0.8), 0 0 0 8px rgba(239, 68, 68, 0.4); }
                    }
                `;
                document.head.appendChild(style);
                badge.style.animation = 'badgePulse 1.2s infinite, badgeGlow 2s infinite';
            }
            
            // A√±adir posici√≥n relativa al bot√≥n padre
            manageRequestsBtn.style.position = 'relative';
            manageRequestsBtn.appendChild(badge);
            
            console.log('üîî DEBUG: Badge GRANDE a√±adido al DOM');
        } else {
            console.log('üîî DEBUG: No hay usuarios pendientes, no se muestra badge');
        }
    }

    // Funciones para el panel administrativo (para implementar despu√©s)
    async approveUserRequest(requestId) {
        const tempPassword = 'temp' + Math.random().toString(36).substr(2, 6);
        const result = this.dataManager.approveUserRequest(requestId, tempPassword);
        
        if (result) {
            await this.sendApprovalEmail(result.request, tempPassword);
            
            // Actualizar todas las interfaces
            this.loadPendingUsers(); // Para el modal (si est√° abierto)
            this.loadRegisteredUsers(); // Para la secci√≥n de usuarios
            this.loadPendingRequestsSection(); // Para la secci√≥n de solicitudes
            this.updatePendingRequestsBadge(); // Actualizar contador
        }
    }

    promptAndRejectUser(requestId) {
        console.log('üö´ DEBUG: promptAndRejectUser iniciando para ID:', requestId);
        
        // Remover cualquier di√°logo existente
        const existingDialog = document.querySelector('.rejection-dialog');
        if (existingDialog) {
            existingDialog.remove();
        }
        
        // Crear un di√°logo personalizado para obtener el motivo del rechazo
        const dialog = document.createElement('div');
        dialog.className = 'rejection-dialog fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center';
        dialog.style.zIndex = '9999';
        dialog.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl transform">
                <div class="flex items-center mb-4">
                    <i class="fas fa-exclamation-triangle text-orange-500 text-xl mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-900">Motivo de Rechazo</h3>
                </div>
                <p class="text-gray-600 mb-4">Por favor, especifica el motivo por el cual rechazas esta solicitud:</p>
                <textarea 
                    id="rejectionReasonText"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" 
                    rows="4" 
                    placeholder="Ejemplo: Informaci√≥n incompleta, usuario no autorizado, etc."
                    maxlength="500"
                ></textarea>
                <div class="text-right text-sm text-gray-500 mb-4">
                    <span id="charCounter">0</span>/500 caracteres
                </div>
                <div class="flex justify-end space-x-3">
                    <button 
                        id="cancelRejectBtn"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded font-medium transition-colors"
                    >
                        Cancelar
                    </button>
                    <button 
                        id="confirmRejectBtn"
                        class="bg-gray-400 text-white px-4 py-2 rounded font-medium cursor-not-allowed"
                        disabled
                    >
                        <i class="fas fa-times mr-2"></i>Rechazar
                    </button>
                </div>
            </div>
        `;

        console.log('üö´ DEBUG: A√±adiendo di√°logo al DOM');
        document.body.appendChild(dialog);
        
        // Forzar el display del di√°logo
        dialog.style.display = 'flex';
        
        console.log('üö´ DEBUG: Di√°logo a√±adido y visible');

        // Obtener elementos
        const textarea = document.getElementById('rejectionReasonText');
        const charCounter = document.getElementById('charCounter');
        const confirmBtn = document.getElementById('confirmRejectBtn');
        const cancelBtn = document.getElementById('cancelRejectBtn');

        console.log('üö´ DEBUG: Elementos obtenidos:', {textarea, charCounter, confirmBtn, cancelBtn});

        // Event listener para el textarea
        textarea.addEventListener('input', function() {
            const length = this.value.length;
            const trimmedLength = this.value.trim().length;
            
            charCounter.textContent = length;
            
            console.log('üö´ DEBUG: Caracteres ingresados:', length, 'v√°lidos:', trimmedLength);
            
            if (trimmedLength >= 10) {
                confirmBtn.disabled = false;
                confirmBtn.className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-medium transition-colors';
                console.log('üö´ DEBUG: Bot√≥n HABILITADO');
            } else {
                confirmBtn.disabled = true;
                confirmBtn.className = 'bg-gray-400 text-white px-4 py-2 rounded font-medium cursor-not-allowed';
                console.log('üö´ DEBUG: Bot√≥n DESHABILITADO');
            }
        });

        // Event listener para confirmar
        confirmBtn.addEventListener('click', () => {
            const reason = textarea.value.trim();
            console.log('üö´ DEBUG: Confirmar clickeado con raz√≥n:', reason);
            
            if (reason.length >= 10) {
                dialog.remove();
                this.rejectUserRequest(requestId, reason);
            } else {
                alert('Por favor ingresa al menos 10 caracteres para el motivo del rechazo.');
            }
        });

        // Event listener para cancelar
        cancelBtn.addEventListener('click', () => {
            console.log('üö´ DEBUG: Cancelar clickeado');
            dialog.remove();
        });

        // Enfocar textarea
        setTimeout(() => {
            textarea.focus();
            console.log('üö´ DEBUG: Focus aplicado al textarea');
        }, 200);
    }

    async rejectUserRequest(requestId, reason = '') {
        const result = this.dataManager.rejectUserRequest(requestId, reason);
        
        if (result) {
            await this.sendRejectionEmail(result, reason);
            
            // Actualizar todas las interfaces
            this.loadPendingUsers(); // Para el modal (si est√° abierto)
            this.loadPendingRequestsSection(); // Para la secci√≥n de solicitudes
            this.updatePendingRequestsBadge(); // Actualizar contador
        }
    }

    async sendApprovalEmail(request, tempPassword) {
        console.log('‚úÖ ==================== SENDING APPROVAL EMAIL ====================');
        
        // USAR LAS NUEVAS VARIABLES DEFINIDAS EN EMAILJS
        const templateParams = {
            to_email: request.email,                    // EmailJS interno para destinatario
            name: 'IDACONN',                           // {{name}} = IDACONN
            usermail: request.email,                   // {{usermail}} = Correo del Solicitante
            Destinatario: request.name,                // {{Destinatario}} = Nombre del Solicitante
            clave: tempPassword,                       // {{clave}} = Contrase√±a temporal
            weblink: window.location.origin,           // {{weblink}} = URL de acceso
            contacto: 'ramon.rivas@me.com'             // {{contacto}} = correo de contacto
        };

        console.log('‚úÖ ==================== NUEVAS VARIABLES EMAILJS ====================');
        console.log('‚úÖ to_email (destinatario):', templateParams.to_email);
        console.log('‚úÖ name (IDACONN):', templateParams.name);
        console.log('‚úÖ usermail (correo solicitante):', templateParams.usermail);
        console.log('‚úÖ Destinatario (nombre):', templateParams.Destinatario);
        console.log('‚úÖ clave (contrase√±a temporal):', templateParams.clave);
        console.log('‚úÖ weblink (URL de acceso):', templateParams.weblink);
        console.log('‚úÖ contacto (admin email):', templateParams.contacto);
        console.log('‚úÖ Template ID:', EMAIL_CONFIG.TEMPLATES.APPROVAL);
        console.log('‚úÖ ================================================================');
        
        const result = await sendEmail(EMAIL_CONFIG.TEMPLATES.APPROVAL, templateParams);
        
        console.log('üîç DEBUG: Resultado de sendEmail:', result);
        
        if (result.success && result.mode === 'real') {
            this.showAlert(
                '‚úÖ Email de Aprobaci√≥n Enviado',
                `Se han enviado las credenciales a ${request.name} (${request.email})\n\nContrase√±a: ${tempPassword}\nURL: ${window.location.origin}\n\nUsando variables: {{clave}} y {{weblink}}`,
                'fas fa-envelope text-green-500'
            );
        } else if (result.mode === 'simulation') {
            this.showAlert(
                'üìß Email Simulado',
                `SIMULACI√ìN: Se enviar√≠an credenciales a ${request.name}\n\nEmail: ${request.email}\nContrase√±a: ${tempPassword}\nURL: ${window.location.origin}\n\n‚ö†Ô∏è Configura EmailJS para enviar emails reales.`,
                'fas fa-envelope text-orange-500'
            );
        } else {
            this.showAlert(
                '‚ùå Error de Email',
                `No se pudo enviar el email a ${request.email}. Error: ${result.error?.message || 'Desconocido'}`,
                'fas fa-exclamation-circle text-red-500'
            );
        }
    }

    async sendRejectionEmail(request, reason) {
        console.log('üö´ ==================== SENDING REJECTION EMAIL ====================');
        
        // Usar el motivo del objeto request si existe, sino usar el par√°metro reason
        const finalReason = request.rejectionReason || reason || 'Motivo no especificado por el administrador';
        
        // USAR LAS NUEVAS VARIABLES DEFINIDAS EN EMAILJS
        const templateParams = {
            to_email: request.email,                    // EmailJS interno para destinatario
            name: 'IDACONN',                           // {{name}} = IDACONN
            usermail: request.email,                   // {{usermail}} = Correo del Solicitante
            Destinatario: request.name,                // {{Destinatario}} = Nombre del Solicitante
            motivo: finalReason,                       // {{motivo}} = Causa del rechazo
            contacto: 'ramon.rivas@me.com'             // {{contacto}} = correo de contacto
        };

        console.log('üö´ ==================== NUEVAS VARIABLES EMAILJS ====================');
        console.log('üö´ to_email (destinatario):', templateParams.to_email);
        console.log('üö´ name (IDACONN):', templateParams.name);
        console.log('üö´ usermail (correo solicitante):', templateParams.usermail);
        console.log('üö´ Destinatario (nombre):', templateParams.Destinatario);
        console.log('üö´ motivo (raz√≥n rechazo):', templateParams.motivo);
        console.log('üö´ contacto (admin email):', templateParams.contacto);
        console.log('üö´ Template ID:', EMAIL_CONFIG.TEMPLATES.REJECTION);
        console.log('üö´ ================================================================');
        
        const result = await sendEmail(EMAIL_CONFIG.TEMPLATES.REJECTION, templateParams);
        console.log('üö´ RESULTADO del email:', result);
        
        if (result.success && result.mode === 'real') {
            this.showAlert(
                '‚úÖ Email de Rechazo Enviado',
                `Se ha notificado el rechazo a ${request.name} (${request.email})\n\nMotivo: ${finalReason}\n\nUsando nuevas variables de EmailJS`,
                'fas fa-envelope text-green-500'
            );
        } else if (result.mode === 'simulation') {
            this.showAlert(
                'üìß Email Simulado',
                `SIMULACI√ìN: Se notificar√≠a rechazo a ${request.name}\n\nEmail: ${request.email}\nMotivo: ${finalReason}\n\n‚ö†Ô∏è Configura EmailJS para enviar emails reales.`,
                'fas fa-envelope text-orange-500'
            );
        } else {
            this.showAlert(
                '‚ùå Error de Email',
                `No se pudo enviar el email de rechazo a ${request.email}. Error: ${result.error?.message || 'Desconocido'}`,
                'fas fa-exclamation-circle text-red-500'
            );
        }
    }

    // üîß GESTI√ìN AVANZADA DE USUARIOS
    editUser(userId) {
        const user = this.dataManager.getUserById(userId);
        if (!user) {
            this.showAlert(
                'Error',
                'Usuario no encontrado',
                'fas fa-exclamation-circle text-red-500'
            );
            return;
        }

        // Cargar datos del usuario en el modal
        document.getElementById('editUserId').value = user.id;
        document.getElementById('editUserName').value = user.name;
        document.getElementById('editUserEmail').value = user.email;
        document.getElementById('editUserRole').value = user.role;
        document.getElementById('editUserPassword').value = ''; // Siempre vac√≠o por seguridad

        // Mostrar modal
        document.getElementById('editUserModal').classList.add('show');
        document.getElementById('editUserName').focus();
    }

    hideEditUserModal() {
        document.getElementById('editUserModal').classList.remove('show');
        document.getElementById('editUserForm').reset();
    }

    handleEditUser(e) {
        e.preventDefault();

        const userId = document.getElementById('editUserId').value;
        const name = document.getElementById('editUserName').value.trim();
        const email = document.getElementById('editUserEmail').value.trim();
        const role = document.getElementById('editUserRole').value;
        const newPassword = document.getElementById('editUserPassword').value.trim();

        if (!name || !email || !role) {
            this.showAlert(
                'Campos Requeridos',
                'Por favor completa nombre, email y rol.',
                'fas fa-exclamation-triangle text-yellow-500'
            );
            return;
        }

        // Verificar si el email ya existe (excluyendo el usuario actual)
        const existingUser = this.dataManager.users.find(u => u.email === email && u.id !== userId);
        if (existingUser) {
            this.showAlert(
                'Email Duplicado',
                'Ya existe un usuario con ese email.',
                'fas fa-exclamation-triangle text-yellow-500'
            );
            return;
        }

        // Preparar datos para actualizar
        const updateData = { name, email, role };
        if (newPassword) {
            updateData.password = newPassword;
        }

        // Actualizar usuario
        const updatedUser = this.dataManager.updateUser(userId, updateData);
        
        if (updatedUser) {
            this.hideEditUserModal();
            
            // Actualizar todas las interfaces
            this.loadUsersInModal(); // Para el modal (si est√° abierto)
            this.loadRegisteredUsers(); // Para la secci√≥n de usuarios
            this.loadProjectsSection(); // Por si hay cambios que afecten proyectos
            
            this.showAlert(
                '‚úÖ Usuario Actualizado',
                `Los datos de ${updatedUser.name} han sido actualizados correctamente.`,
                'fas fa-check-circle text-green-500'
            );
        }
    }

    confirmDeleteUser(userId) {
        const user = this.dataManager.getUserById(userId);
        if (!user) return;

        // Verificar si es el √∫ltimo admin
        if (user.role === 'admin') {
            const adminCount = this.dataManager.users.filter(u => u.role === 'admin').length;
            if (adminCount <= 1) {
                this.showAlert(
                    '‚ö†Ô∏è No se puede eliminar',
                    'No puedes eliminar el √∫ltimo administrador del sistema.',
                    'fas fa-shield-alt text-orange-500'
                );
                return;
            }
        }

        this.showCustomConfirm(
            'üóëÔ∏è Confirmar Eliminaci√≥n',
            `¬øEst√°s seguro de que quieres eliminar al usuario "${user.name}"?\n\nEsta acci√≥n NO se puede deshacer.\n\nTodos los gastos asociados a este usuario se mantendr√°n en el sistema.`,
            () => {
                this.deleteUserConfirmed(userId);
            },
            'S√≠, eliminar',
            'Cancelar',
            null
        );
    }

    deleteUserConfirmed(userId) {
        const user = this.dataManager.getUserById(userId);
        const result = this.dataManager.deleteUser(userId);
        
        if (result === true) {
            // Actualizar todas las interfaces
            this.loadUsersInModal(); // Para el modal (si est√° abierto)
            this.loadRegisteredUsers(); // Para la secci√≥n de usuarios
            this.loadProjectsSection(); // Por si hay cambios que afecten proyectos
            
            this.showAlert(
                '‚úÖ Usuario Eliminado',
                `El usuario "${user.name}" ha sido eliminado del sistema.`,
                'fas fa-check-circle text-green-500'
            );
        } else if (result.error) {
            this.showAlert(
                '‚ùå Error',
                result.error,
                'fas fa-exclamation-circle text-red-500'
            );
        }
    }

    // üì¢ MODAL DE ALERTA SIMPLE
    showAlert(title, message, icon = 'fas fa-info-circle text-blue-500') {
        document.getElementById('alertTitle').textContent = title;
        document.getElementById('alertMessage').innerHTML = message.replace(/\n/g, '<br>');
        document.getElementById('alertIcon').className = icon;
        
        // Cerrar cualquier modal abierto primero
        document.querySelectorAll('.modal.show').forEach(modal => {
            modal.classList.remove('show');
        });
        
        document.getElementById('alertModal').classList.add('show');
    }

    hideAlertModal() {
        document.getElementById('alertModal').classList.remove('show');
    }

    // üîë GESTI√ìN DE CAMBIO DE CONTRASE√ëA EN PRIMER LOGIN
    showChangePasswordModal(user) {
        console.log('üîë Mostrando modal de cambio de contrase√±a para:', user.name);
        
        // Mostrar la contrase√±a temporal (solo lectura)
        document.getElementById('currentPassword').value = user.password;
        
        // Limpiar campos
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        
        // Mostrar modal
        document.getElementById('changePasswordModal').classList.add('show');
        
        // Enfocar en nueva contrase√±a
        setTimeout(() => {
            document.getElementById('newPassword').focus();
        }, 100);
    }

    handleChangePassword(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        // Validaciones
        if (!newPassword || newPassword.length < 6) {
            this.showAlert(
                'Contrase√±a Inv√°lida',
                'La nueva contrase√±a debe tener al menos 6 caracteres.',
                'fas fa-exclamation-triangle text-orange-500'
            );
            return;
        }
        
        if (newPassword !== confirmPassword) {
            this.showAlert(
                'Contrase√±as No Coinciden',
                'La nueva contrase√±a y su confirmaci√≥n deben ser iguales.',
                'fas fa-exclamation-triangle text-orange-500'
            );
            return;
        }
        
        if (newPassword === currentPassword) {
            this.showAlert(
                'Contrase√±a Id√©ntica',
                'La nueva contrase√±a debe ser diferente a la temporal.',
                'fas fa-exclamation-triangle text-orange-500'
            );
            return;
        }
        
        // Actualizar contrase√±a en el usuario
        const result = this.dataManager.updateUserPassword(this.dataManager.currentUser.id, newPassword);
        
        if (result) {
            // Cerrar modal
            document.getElementById('changePasswordModal').classList.remove('show');
            
            // Actualizar usuario actual
            this.dataManager.currentUser = result;
            
            // Mostrar confirmaci√≥n y continuar al dashboard
            this.showAlert(
                '‚úÖ Contrase√±a Cambiada',
                'Tu contrase√±a ha sido actualizada exitosamente. Ahora puedes acceder al sistema.',
                'fas fa-check-circle text-green-500'
            );
            
            // Ir al dashboard despu√©s de cerrar la alerta
            setTimeout(() => {
                this.showDashboard(result);
            }, 2000);
        } else {
            this.showAlert(
                'Error',
                'No se pudo actualizar la contrase√±a. Intenta de nuevo.',
                'fas fa-exclamation-circle text-red-500'
            );
        }
    }
}

// üöÄ INICIALIZAR APLICACI√ìN
let app;
document.addEventListener('DOMContentLoaded', function() {
    // Debug EmailJS al cargar
    console.log('üîç EmailJS disponible al cargar:', typeof emailjs !== 'undefined');
    if (typeof emailjs !== 'undefined') {
        console.log('‚úÖ EmailJS library cargada correctamente');
    } else {
        console.error('‚ùå EmailJS library NO est√° disponible');
    }
    
    app = new ExpenseApp();
    
    // üîß Configurar event listeners b√°sicos SOLAMENTE
    setupBasicEventListeners();
    
    // Funci√≥n de prueba global para EmailJS
    window.testEmailJS = async function() {
        console.log('üß™ Iniciando prueba de EmailJS...');
        
        const testParams = {
            to_email: 'ramon.rivas@me.com',           // EmailJS interno
            name: 'IDACONN',                          // {{name}}
            usermail: 'usuario@test.com',             // {{usermail}}
            Destinatario: 'Usuario de Prueba',        // {{Destinatario}}
            clave: 'test123',                         // {{clave}}
            weblink: window.location.origin,          // {{weblink}}
            contacto: 'ramon.rivas@me.com'            // {{contacto}}
        };
        
        console.log('üß™ Enviando email de prueba a ramon.rivas@me.com...');
        
        try {
            const result = await sendEmail(EMAIL_CONFIG.TEMPLATES.APPROVAL, testParams);
            console.log('üß™ Resultado de la prueba:', result);
            
            if (result.success && result.mode === 'real') {
                console.log('‚úÖ ¬°EMAIL DE PRUEBA ENVIADO! Revisa tu bandeja de entrada.');
            } else if (result.mode === 'simulation') {
                console.log('‚ö†Ô∏è Est√° en modo simulaci√≥n, revisa la configuraci√≥n de EmailJS');
            } else {
                console.log('‚ùå Error en la prueba:', result.error);
            }
        } catch (error) {
            console.error('‚ùå Error en testEmailJS:', error);
        }
    };

    // Funci√≥n de prueba espec√≠fica para email de rechazo
    window.testRejectionEmail = async function() {
        console.log('üß™üö´ ============= INICIANDO PRUEBA DE EMAIL RECHAZO =============');
        
        const testParams = {
            to_email: 'ramon.rivas@me.com',            // EmailJS interno
            name: 'IDACONN',                           // {{name}}
            usermail: 'solicitante@test.com',         // {{usermail}}
            Destinatario: 'Juan Carlos Prueba',       // {{Destinatario}}
            motivo: 'MOTIVO DE PRUEBA: Documentaci√≥n incompleta y falta de autorizaci√≥n necesaria', // {{motivo}}
            contacto: 'ramon.rivas@me.com'            // {{contacto}}
        };
        
        console.log('üß™üö´ EMAIL_CONFIG completo:', EMAIL_CONFIG);
        console.log('üß™üö´ Template ID a usar:', EMAIL_CONFIG.TEMPLATES.REJECTION);
        console.log('üß™üö´ Service ID:', EMAIL_CONFIG.SERVICE_ID);
        console.log('üß™üö´ Public Key:', EMAIL_CONFIG.PUBLIC_KEY);
        console.log('üß™üö´ NUEVAS VARIABLES que se enviar√°n:');
        console.log(`üß™üö´   name ({{name}}): "${testParams.name}"`);
        console.log(`üß™üö´   usermail ({{usermail}}): "${testParams.usermail}"`);
        console.log(`üß™üö´   Destinatario ({{Destinatario}}): "${testParams.Destinatario}"`);
        console.log(`üß™üö´   motivo ({{motivo}}): "${testParams.motivo}"`);
        console.log(`üß™üö´   contacto ({{contacto}}): "${testParams.contacto}"`);
        console.log(`üß™üö´   to_email (interno): "${testParams.to_email}"`);
        
        console.log('üß™üö´ EmailJS disponible:', typeof emailjs !== 'undefined');
        
        try {
            console.log('üß™üö´ Enviando email de prueba...');
            const result = await sendEmail(EMAIL_CONFIG.TEMPLATES.REJECTION, testParams);
            
            console.log('üß™üö´ ============= RESULTADO DE LA PRUEBA =============');
            console.log('üß™üö´ Resultado completo:', result);
            
            if (result.success && result.mode === 'real') {
                console.log('‚úÖ‚úÖ ¬°EMAIL DE RECHAZO ENVIADO EXITOSAMENTE!');
                console.log('üìß Revisa la bandeja de entrada de ramon.rivas@me.com');
                console.log('üìß Deber√≠a contener las NUEVAS VARIABLES:');
                console.log(`üìß   - {{name}}: ${testParams.name}`);
                console.log(`üìß   - {{Destinatario}}: ${testParams.Destinatario}`);
                console.log(`üìß   - {{usermail}}: ${testParams.usermail}`);
                console.log(`üìß   - {{motivo}}: ${testParams.motivo}`);
                console.log(`üìß   - {{contacto}}: ${testParams.contacto}`);
            } else if (result.mode === 'simulation') {
                console.log('‚ö†Ô∏è Est√° en modo simulaci√≥n - EmailJS no configurado correctamente');
            } else {
                console.log('‚ùå Error en el env√≠o:', result.error);
            }
        } catch (error) {
            console.error('‚ùå‚ùå Error cr√≠tico en testRejectionEmail:', error);
        }
        
        console.log('üß™üö´ ========================================================');
    };

    // Funci√≥n para comparar templates de aprobaci√≥n vs rechazo
    window.compareTemplates = async function() {
        console.log('üîç ============= COMPARANDO TEMPLATES =============');
        
        // Test del template de APROBACI√ìN con nuevas variables
        const approvalParams = {
            to_email: 'ramon.rivas@me.com',           // EmailJS interno
            name: 'IDACONN',                          // {{name}}
            usermail: 'test.aprobacion@test.com',     // {{usermail}}
            Destinatario: 'Test Aprobaci√≥n',          // {{Destinatario}}
            clave: 'test123',                         // {{clave}}
            weblink: window.location.origin,          // {{weblink}}
            contacto: 'ramon.rivas@me.com'            // {{contacto}}
        };
        
        console.log('‚úÖ Enviando template de APROBACI√ìN...');
        console.log('‚úÖ Template ID:', EMAIL_CONFIG.TEMPLATES.APPROVAL);
        console.log('‚úÖ Params:', approvalParams);
        
        try {
            const approvalResult = await sendEmail(EMAIL_CONFIG.TEMPLATES.APPROVAL, approvalParams);
            console.log('‚úÖ Resultado aprobaci√≥n:', approvalResult);
        } catch (error) {
            console.error('‚ùå Error aprobaci√≥n:', error);
        }
        
        // Esperar un momento
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Test del template de RECHAZO con nuevas variables
        const rejectionParams = {
            to_email: 'ramon.rivas@me.com',           // EmailJS interno
            name: 'IDACONN',                          // {{name}}
            usermail: 'test.rechazo@test.com',        // {{usermail}}
            Destinatario: 'Test Rechazo',             // {{Destinatario}}
            motivo: 'Motivo de prueba para comparaci√≥n', // {{motivo}}
            contacto: 'ramon.rivas@me.com'            // {{contacto}}
        };
        
        console.log('üö´ Enviando template de RECHAZO...');
        console.log('üö´ Template ID:', EMAIL_CONFIG.TEMPLATES.REJECTION);
        console.log('üö´ Params:', rejectionParams);
        
        try {
            const rejectionResult = await sendEmail(EMAIL_CONFIG.TEMPLATES.REJECTION, rejectionParams);
            console.log('üö´ Resultado rechazo:', rejectionResult);
        } catch (error) {
            console.error('‚ùå Error rechazo:', error);
        }
        
        console.log('üîç ========================================');
        console.log('üìß Deber√≠as recibir 2 emails en unos segundos');
        console.log('üìß Compara si el de APROBACI√ìN tiene datos y el de RECHAZO no');
        console.log('üîç ========================================');
    };

    // Funci√≥n para debuggear rechazo real simulando el flujo completo
    window.debugRealRejection = async function() {
        console.log('üîçüö´ ============= SIMULANDO RECHAZO REAL =============');
        
        // Simular el objeto request tal como viene del DataManager
        const mockRequest = {
            id: 'test_' + Date.now(),
            name: 'Mar√≠a Gonz√°lez Prueba',
            email: 'ramon.rivas@me.com',  // Usamos el email real para recibir
            message: 'Solicito acceso al sistema',
            status: 'pending',
            requestDate: new Date().toISOString()
        };
        
        const mockReason = 'PRUEBA COMPLETA: Documentaci√≥n insuficiente y datos incorrectos proporcionados por el solicitante';
        
        console.log('üîçüö´ Mock request object:', mockRequest);
        console.log('üîçüö´ Mock reason:', mockReason);
        
        // Llamar directamente a sendRejectionEmail como lo har√≠a la app
        try {
            await app.sendRejectionEmail(mockRequest, mockReason);
            console.log('‚úÖ Proceso de rechazo completado - revisa logs arriba para ver si los campos se enviaron');
        } catch (error) {
            console.error('‚ùå Error en el proceso de rechazo:', error);
        }
        
        console.log('üîçüö´ =================================================');
    };

    // Funci√≥n para probar el flujo completo de aprobaci√≥n
    window.testApprovalFlow = function() {
        console.log('üß™‚úÖ ============= PROBANDO FLUJO DE APROBACI√ìN =============');
        
        // 1. Crear una solicitud de prueba
        const mockRequest = {
            name: 'Carlos Testeo',
            email: 'carlos@test.com',
            message: 'Solicito acceso para testing'
        };
        
        console.log('1Ô∏è‚É£ Creando solicitud de usuario:', mockRequest);
        const request = app.dataManager.addUserRequest(mockRequest);
        
        console.log('2Ô∏è‚É£ Solicitud creada:', request);
        
        // 2. Aprobar la solicitud
        const tempPassword = 'temp123456';
        console.log('3Ô∏è‚É£ Aprobando usuario con contrase√±a temporal:', tempPassword);
        
        const approvalResult = app.dataManager.approveUserRequest(request.id, tempPassword);
        console.log('4Ô∏è‚É£ Resultado de aprobaci√≥n:', approvalResult);
        
        // 3. Verificar que el usuario est√© en la lista
        const usersList = app.dataManager.users;
        console.log('5Ô∏è‚É£ Lista completa de usuarios:', usersList);
        
        const newUser = usersList.find(u => u.email === mockRequest.email);
        console.log('6Ô∏è‚É£ Usuario encontrado en la lista:', newUser);
        
        // 4. Probar login
        if (newUser) {
            console.log('7Ô∏è‚É£ Probando login con credenciales enviadas...');
            const loginResult = app.dataManager.login(mockRequest.email, tempPassword);
            console.log('8Ô∏è‚É£ Resultado de login:', loginResult);
            
            if (loginResult) {
                console.log('‚úÖ ¬°√âXITO! El usuario puede hacer login con las credenciales del email');
                console.log('üîë isFirstLogin:', loginResult.isFirstLogin);
                console.log('üîë tempPassword:', loginResult.tempPassword);
            } else {
                console.log('‚ùå ERROR: No se puede hacer login con las credenciales');
            }
        } else {
            console.log('‚ùå ERROR: Usuario no encontrado en la lista despu√©s de aprobaci√≥n');
        }
        
        console.log('üß™‚úÖ ========================================================');
    };

    // Funci√≥n para debuggear la lista de usuarios
    window.debugUsersList = function() {
        console.log('üë•üîç ============= DEBUGGING LISTA DE USUARIOS =============');
        
        // 1. Verificar usuarios en DataManager
        const users = app.dataManager.users;
        console.log('1Ô∏è‚É£ Usuarios en app.dataManager.users:', users);
        console.log('1Ô∏è‚É£ Cantidad:', users.length);
        
        // 2. Verificar localStorage
        const storedUsers = localStorage.getItem('idaconn_users');
        console.log('2Ô∏è‚É£ Usuarios en localStorage:', storedUsers);
        
        if (storedUsers) {
            const parsedUsers = JSON.parse(storedUsers);
            console.log('2Ô∏è‚É£ Usuarios parseados:', parsedUsers);
        }
        
        // 3. Verificar container HTML
        const container = document.getElementById('currentUsers');
        console.log('3Ô∏è‚É£ Container #currentUsers encontrado:', !!container);
        
        if (container) {
            console.log('3Ô∏è‚É£ Contenido actual del container:', container.innerHTML);
        }
        
        // 4. Forzar carga de usuarios
        console.log('4Ô∏è‚É£ Ejecutando loadUsersInModal()...');
        app.loadUsersInModal();
        
        // 5. Verificar contenido despu√©s de la carga
        if (container) {
            console.log('5Ô∏è‚É£ Contenido despu√©s de loadUsersInModal():', container.innerHTML.substring(0, 300) + '...');
        }
        
        // 6. Crear usuario de prueba si no hay ninguno
        if (users.length <= 1) { // Solo admin
            console.log('6Ô∏è‚É£ Creando usuario de prueba...');
            
            const testUser = {
                id: Date.now().toString(),
                name: 'Usuario de Prueba',
                email: 'test@usuario.com',
                role: 'user',
                password: 'test123',
                createdDate: new Date().toISOString(),
                isFirstLogin: false,
                tempPassword: false
            };
            
            app.dataManager.users.push(testUser);
            app.dataManager.saveUsers();
            
            console.log('6Ô∏è‚É£ Usuario de prueba creado:', testUser);
            
            // Recargar lista
            console.log('7Ô∏è‚É£ Recargando lista despu√©s de crear usuario...');
            app.loadUsersInModal();
            
            if (container) {
                console.log('7Ô∏è‚É£ Contenido final:', container.innerHTML.substring(0, 300) + '...');
            }
        }
        
        console.log('üë•üîç ========================================================');
    };
    
    console.log('üß™ Funciones de prueba disponibles:');
    console.log('  - testEmailJS() ‚Üí Prueba email de aprobaci√≥n');
    console.log('  - testRejectionEmail() ‚Üí Prueba email de rechazo');
    console.log('  - debugRealRejection() ‚Üí Simula rechazo real con usuario de prueba');
    console.log('  - compareTemplates() ‚Üí Compara templates aprobaci√≥n vs rechazo');
    console.log('  - testApprovalFlow() ‚Üí Prueba flujo completo de aprobaci√≥n de usuario');
    console.log('  - debugUsersList() ‚Üí Verifica y muestra lista de usuarios');
    
    // üîß FUNCIONES PARA ADMINISTRACI√ìN DE 3 SECCIONES
    function setupBasicEventListeners() {
        console.log('üîß Configurando event listeners b√°sicos...');
        
        // ============ SOLO LOGIN FORM ============
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                const user = app.dataManager.login(email, password);
                if (user) {
                    app.showDashboard(user);
                } else {
                    app.showAlert(
                        'Error de Login',
                        'Email o contrase√±a incorrectos',
                        'fas fa-exclamation-circle text-red-500'
                    );
                }
            });
            console.log('‚úÖ Login form configurado');
        }
        
        // ============ PROJECT SELECT ============
        const projectSelect = document.getElementById('projectSelect');
        if (projectSelect) {
            projectSelect.addEventListener('change', (e) => {
                app.handleProjectChange(e);
            });
            console.log('‚úÖ Project select configurado');
        }
        
        console.log('‚úÖ Event listeners b√°sicos configurados correctamente');
    }
    
    // üåç FUNCIONES GLOBALES PARA LOS BOTONES DE PROYECTOS
    window.editProject = function(projectId) {
        console.log('‚úèÔ∏è Editando proyecto:', projectId);
        app.showCustomConfirm(
            'Funci√≥n en Desarrollo',
            'La edici√≥n de proyectos estar√° disponible pronto.',
            () => {}
        );
    };
    
    window.deleteProject = function(projectId) {
        console.log('üóëÔ∏è Eliminando proyecto:', projectId);
        const project = app.dataManager.projects.find(p => p.id === projectId);
        if (!project) return;
        
        app.showCustomConfirm(
            'Eliminar Proyecto',
            `¬øEst√°s seguro de eliminar el proyecto "${project.name}"? Esta acci√≥n no se puede deshacer.`,
            () => {
                app.dataManager.deleteProject(projectId);
                app.loadProjectsSection(); // Recargar la secci√≥n
            }
        );
    };
    
    window.addContribution = function(projectId) {
        console.log('üí∞ Agregando aportaci√≥n al proyecto:', projectId);
        const project = app.dataManager.projects.find(p => p.id === projectId);
        if (!project) return;
        
        // Por ahora mostrar modal simple, luego se puede hacer m√°s complejo
        const amount = prompt(`¬øCu√°nto deseas aportar al proyecto "${project.name}"?`);
        if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
            const contributionData = {
                amount: parseFloat(amount),
                description: 'Aportaci√≥n manual',
                date: new Date().toISOString().split('T')[0]
            };
            
            app.dataManager.addContribution(projectId, contributionData);
            app.loadProjectsSection(); // Recargar la secci√≥n
            
            app.showCustomConfirm(
                'Aportaci√≥n Agregada',
                `Se agregaron $${parseFloat(amount).toLocaleString()} al proyecto "${project.name}".`,
                () => {}
            );
        }
    };
    
    window.approveUser = function(requestId) {
        console.log('‚úÖ Aprobando usuario:', requestId);
        const pendingUsers = app.dataManager.getPendingUsers();
        const request = pendingUsers.find(r => r.id === requestId);
        
        if (!request) return;
        
        // Crear usuario aprobado
        const newUser = {
            id: Date.now().toString(),
            name: request.name,
            email: request.email,
            role: 'user',
            password: 'temp123', // Contrase√±a temporal
            isFirstLogin: true,
            tempPassword: true,
            createdDate: new Date().toISOString()
        };
        
        // Agregar a usuarios registrados
        app.dataManager.users.push(newUser);
        app.dataManager.saveUsers();
        
        // Remover de pendientes
        app.dataManager.removePendingUser(requestId);
        
        // Recargar secci√≥n
        app.loadPendingRequestsSection();
        
        app.showCustomConfirm(
            'Usuario Aprobado',
            `${request.name} ha sido agregado como usuario. Contrase√±a temporal: temp123`,
            () => {}
        );
    };
    
    window.rejectUser = function(requestId) {
        console.log('‚ùå Rechazando usuario:', requestId);
        const pendingUsers = app.dataManager.getPendingUsers();
        const request = pendingUsers.find(r => r.id === requestId);
        
        if (!request) return;
        
        app.showCustomConfirm(
            'Rechazar Solicitud',
            `¬øEst√°s seguro de rechazar la solicitud de ${request.name}?`,
            () => {
                app.dataManager.removePendingUser(requestId);
                app.loadPendingRequestsSection();
                
                app.showCustomConfirm(
                    'Solicitud Rechazada',
                    `La solicitud de ${request.name} ha sido rechazada.`,
                    () => {}
                );
            }
        );
    };
    


});
</script>

</body>
</html>