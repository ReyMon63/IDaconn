<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Demo C√°mara + IA H√≠brida</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .camera-container {
            position: relative;
            background: #f3f4f6;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .camera-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            border: 2px dashed #3b82f6;
            border-radius: 0.5rem;
            pointer-events: none;
        }
        
        .btn-camera {
            padding: 12px 24px;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        
        .processing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
        
        <!-- Header -->
        <div class="bg-blue-600 text-white p-4 text-center">
            <h1 class="text-xl font-bold">üì∑ + ü§ñ Demo Real</h1>
            <p class="text-sm opacity-90">C√°mara + OCR + IA H√≠brida</p>
        </div>

        <!-- C√°mara Section -->
        <div class="p-4">
            <div id="cameraSection">
                <h2 class="text-lg font-semibold mb-3">1. Capturar Ticket</h2>
                
                <!-- Camera Container -->
                <div class="camera-container mb-4" style="height: 250px;">
                    <video id="video" class="w-full h-full object-cover hidden" autoplay playsinline></video>
                    <canvas id="canvas" class="w-full h-full object-cover hidden"></canvas>
                    
                    <!-- Placeholder -->
                    <div id="placeholder" class="w-full h-full flex items-center justify-center text-gray-500">
                        <div class="text-center">
                            <i class="fas fa-camera text-4xl mb-2"></i>
                            <p class="text-sm">Presiona "Iniciar C√°mara"</p>
                        </div>
                    </div>
                    
                    <!-- Camera overlay -->
                    <div class="camera-overlay"></div>
                    
                    <!-- Processing overlay -->
                    <div id="processingOverlay" class="processing-overlay hidden">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"></div>
                            <p id="processingText">Procesando...</p>
                        </div>
                    </div>
                </div>

                <!-- Camera Controls -->
                <div id="cameraControls" class="grid grid-cols-1 gap-2 mb-4">
                    <button id="startCamera" onclick="startCameraDirectly()" class="btn-camera bg-blue-600 hover:bg-blue-700 text-white">
                        <i class="fas fa-camera mr-2"></i>Iniciar C√°mara
                    </button>
                </div>

                <div id="activeControls" class="hidden grid grid-cols-2 gap-2 mb-4">
                    <button id="capturePhoto" onclick="capturePhoto()" class="btn-camera bg-green-600 hover:bg-green-700 text-white">
                        <i class="fas fa-camera-retro mr-2"></i>Capturar
                    </button>
                    <button id="switchCamera" onclick="switchCamera()" class="btn-camera bg-gray-600 hover:bg-gray-700 text-white">
                        <i class="fas fa-sync-alt mr-2"></i>Cambiar
                    </button>
                </div>

                <div id="retakeControls" class="hidden grid-cols-2 gap-2 mb-4">
                    <button id="retakePhoto" onclick="retakePhoto()" class="btn-camera bg-yellow-600 hover:bg-yellow-700 text-white">
                        <i class="fas fa-redo mr-2"></i>Repetir
                    </button>
                    <button id="processOCR" onclick="processWithOCR()" class="btn-camera bg-purple-600 hover:bg-purple-700 text-white">
                        <i class="fas fa-magic mr-2"></i>Analizar con IA
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <h2 class="text-lg font-semibold mb-3">2. ü§ñ IA Detect√≥:</h2>
                
                <!-- OCR Raw Results -->
                <div id="ocrResults" class="bg-gray-50 rounded-lg p-3 mb-4 hidden">
                    <div class="text-xs text-gray-600 mb-1">Texto detectado:</div>
                    <div id="ocrText" class="text-xs font-mono max-h-20 overflow-y-auto"></div>
                </div>

                <!-- Smart Amount Suggestions -->
                <div id="amountSuggestions" class="hidden mb-4 space-y-2">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-blue-800">ü§ñ IA Sugiere:</span>
                            <span id="aiConfidence" class="text-xs text-blue-600">95%</span>
                        </div>
                        <button type="button" id="suggestedAmount" 
                                class="w-full text-left p-2 bg-white border border-blue-300 rounded hover:bg-blue-50 transition-colors">
                            <span class="text-lg font-bold text-blue-900">$0.00</span>
                        </button>
                    </div>
                    
                    <!-- Alternativas -->
                    <div id="alternativeAmounts" class="hidden">
                        <div class="text-xs text-gray-600 mb-1">Otras opciones detectadas:</div>
                        <div id="alternatives" class="grid grid-cols-2 gap-1"></div>
                    </div>
                    
                    <button type="button" id="showAlternatives" 
                            class="text-xs text-blue-600 hover:text-blue-800 underline">
                        Ver m√°s opciones detectadas
                    </button>
                </div>
                
                <!-- Final Amount Input -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Monto Final:</label>
                    <input type="number" id="finalAmount" step="0.01" min="0" 
                           class="w-full px-3 py-2 border rounded-lg text-base" 
                           placeholder="0.00">
                    <div class="text-xs text-gray-500 mt-1">
                        üí° Editado autom√°ticamente por IA - puedes corregir
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-2">
                    <button id="resetDemo" onclick="resetDemo()" class="btn-camera bg-gray-500 hover:bg-gray-600 text-white">
                        <i class="fas fa-refresh mr-2"></i>Nuevo Ticket
                    </button>
                    <button id="saveAmount" onclick="saveAmount()" class="btn-camera bg-green-600 hover:bg-green-700 text-white">
                        <i class="fas fa-check mr-2"></i>Confirmar
                    </button>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage" class="hidden mt-4 p-3 rounded-lg"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <!-- Smart Amount Detection incluido directamente -->
    <script>
        // Fallback para debug si no est√° disponible
        if (typeof debug === 'undefined') {
            window.debug = {
                log: (...args) => console.log('[SmartAmountDetector]', ...args),
                error: (...args) => console.error('[SmartAmountDetector]', ...args),
                warn: (...args) => console.warn('[SmartAmountDetector]', ...args)
            };
        }

        class SmartAmountDetector {
            constructor() {
                this.patterns = {
                    contextKeywords: [
                        { words: ['total', 'suma', 'importe'], weight: 10, radius: 80 },
                        { words: ['subtotal', 'neto'], weight: 8, radius: 60 },
                        { words: ['pagar', 'cobrar', 'precio'], weight: 7, radius: 50 },
                        { words: ['cambio', 'devolucion'], weight: -5, radius: 40 },
                        { words: ['iva', 'impuesto', 'tax'], weight: 3, radius: 30 },
                        { words: ['descuento', 'ahorro'], weight: 2, radius: 40 }
                    ],
                    
                    amountPatterns: [
                        /\$\s*([0-9]{1,3}(?:[,]\d{3})*(?:\.\d{2})?)/g,
                        /([0-9]{1,3}(?:[,]\d{3})*(?:\.\d{2})?)\s*pesos/gi,
                        /([0-9]{1,3}(?:[,]\d{3})*(?:\.\d{2})?)\s*MXN/gi,
                        /total\s*:?\s*\$?\s*([0-9]{1,3}(?:[,]\d{3})*(?:\.\d{2})?)/gi,
                        /suma\s*:?\s*\$?\s*([0-9]{1,3}(?:[,]\d{3})*(?:\.\d{2})?)/gi,
                        /([0-9]{1,3}(?:[,]\d{3})*\.\d{2})/g
                    ]
                };
                
                debug.log('SmartAmountDetector initialized');
            }

            analyzeAmounts(ocrText, ocrConfidence = 0.8) {
                if (!ocrText || ocrText.trim().length === 0) {
                    return { suggested: null, alternatives: [], confidence: 0, analysis: 'No hay texto para analizar' };
                }

                debug.log('Starting smart amount analysis');

                try {
                    // 1. Extraer todos los montos
                    const rawAmounts = this.extractAllAmounts(ocrText);
                    
                    if (rawAmounts.length === 0) {
                        return { suggested: null, alternatives: [], confidence: 0, analysis: 'No se encontraron montos en el texto' };
                    }

                    // 2. Analizar contexto de cada monto
                    const analyzedAmounts = rawAmounts.map(amount => 
                        this.analyzeAmountContext(amount, ocrText)
                    );

                    // 3. Calcular scores y ordenar
                    const scoredAmounts = this.calculateScores(analyzedAmounts, ocrText);
                    
                    // 4. Seleccionar el mejor candidato
                    const suggested = scoredAmounts[0];
                    const alternatives = scoredAmounts.slice(1, 5);
                    
                    // 5. Calcular confianza final
                    const confidence = Math.min(0.95, ocrConfidence * 0.8 + (suggested.totalScore / 30) * 0.2);
                    
                    debug.log('Smart analysis complete', {
                        suggested: suggested.value,
                        confidence: confidence,
                        totalAmounts: scoredAmounts.length
                    });
                    
                    return {
                        suggested: suggested,
                        alternatives: alternatives,
                        confidence: confidence,
                        analysis: `Monto sugerido: $${suggested.value.toFixed(2)} (Score: ${suggested.totalScore.toFixed(1)})`
                    };

                } catch (error) {
                    debug.error('Error in smart amount analysis:', error);
                    return this.basicAmountFallback(ocrText);
                }
            }

            extractAllAmounts(text) {
                const amounts = [];
                const seen = new Set();
                
                this.patterns.amountPatterns.forEach((pattern, patternIndex) => {
                    const matches = [...text.matchAll(pattern)];
                    
                    matches.forEach(match => {
                        const cleanAmount = match[1] || match[0];
                        const numericValue = parseFloat(cleanAmount.replace(/[,$]/g, ''));
                        
                        if (numericValue > 0 && numericValue < 999999 && !seen.has(numericValue)) {
                            amounts.push({
                                value: numericValue,
                                originalText: match[0],
                                cleanText: cleanAmount,
                                position: match.index,
                                patternType: patternIndex,
                                context: this.extractContext(text, match.index, 100)
                            });
                            seen.add(numericValue);
                        }
                    });
                });
                
                return amounts;
            }

            analyzeAmountContext(amount, fullText) {
                let contextScore = 0;
                let reasoningFactors = [];
                
                const context = amount.context.toLowerCase();
                
                // Analizar palabras clave en contexto
                this.patterns.contextKeywords.forEach(keyword => {
                    keyword.words.forEach(word => {
                        if (context.includes(word)) {
                            contextScore += keyword.weight;
                            reasoningFactors.push(`Contexto "${word}" (${keyword.weight > 0 ? '+' : ''}${keyword.weight})`);
                        }
                    });
                });
                
                return {
                    ...amount,
                    contextScore,
                    reasoningFactors
                };
            }

            calculateScores(amounts, fullText) {
                return amounts.map(amount => {
                    let totalScore = amount.contextScore || 0;
                    
                    // Bonus por posici√≥n (montos al final suelen ser totales)
                    const textLength = fullText.length;
                    const relativePosition = amount.position / textLength;
                    if (relativePosition > 0.7) totalScore += 3;
                    else if (relativePosition > 0.5) totalScore += 1;
                    
                    // Bonus por formato t√≠pico mexicano
                    if (amount.originalText.includes('$') || amount.originalText.includes('.')) {
                        totalScore += 1;
                    }
                    
                    // Penalty por montos muy peque√±os o muy grandes  
                    if (amount.value < 10) totalScore -= 2;
                    if (amount.value > 10000) totalScore -= 1;
                    
                    return {
                        ...amount,
                        totalScore
                    };
                }).sort((a, b) => b.totalScore - a.totalScore);
            }

            extractContext(text, position, radius) {
                const start = Math.max(0, position - radius);
                const end = Math.min(text.length, position + radius);
                return text.substring(start, end);
            }

            basicAmountFallback(text) {
                const amounts = this.extractAllAmounts(text);
                if (amounts.length === 0) {
                    return { suggested: null, alternatives: [], confidence: 0, analysis: 'No se encontraron montos' };
                }
                
                const sorted = amounts.sort((a, b) => b.value - a.value);
                
                return {
                    suggested: {
                        ...sorted[0],
                        totalScore: 5,
                        confidence: 0.6,
                        reasoningFactors: ['Modo b√°sico: Mayor monto encontrado']
                    },
                    alternatives: sorted.slice(1, 4),
                    confidence: 0.6,
                    analysis: 'An√°lisis b√°sico: Se sugiere el monto m√°s grande encontrado'
                };
            }
        }
        
        console.log('‚úÖ SmartAmountDetector cargado directamente');
    </script>
    
    <script>
        // Test b√°sico
        alert('üß™ JavaScript est√° funcionando');
        
        // Global variables
        let videoStream = null;
        let currentFacingMode = 'environment';
        let smartAmountDetector = null;
        let capturedImageData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            alert('‚úÖ DOM cargado');
            console.log('Demo inicializado');
            console.log('Demo inicializado');
            
            // Debug camera support
            if (!navigator.mediaDevices) {
                alert('‚ùå Tu navegador no soporta acceso a c√°mara');
                return;
            }
            
            if (!navigator.mediaDevices.getUserMedia) {
                alert('‚ùå getUserMedia no disponible');
                return;
            }
            
            console.log('‚úÖ Soporte de c√°mara detectado');
            
            // Inicializar Smart Amount Detector
            try {
                if (typeof SmartAmountDetector === 'undefined') {
                    alert('‚ùå SmartAmountDetector no cargado');
                    return;
                }
                
                smartAmountDetector = new SmartAmountDetector();
                console.log('‚úÖ SmartAmountDetector inicializado');
            } catch (error) {
                console.error('Error inicializando SmartAmountDetector:', error);
                alert('Error cargando IA: ' + error.message);
                return;
            }
            
            setupEventListeners();
        });

        // Event Listeners
        // Funci√≥n directa para iOS
        function startCameraDirectly() {
            alert('üëÜ BOT√ìN TOCADO! (m√©todo directo)');
            startCamera();
        }

        function setupEventListeners() {
            console.log('üîß Configurando event listeners...');
            
            // Event listeners para otros botones (usando onclick directo para iOS)
            document.getElementById('capturePhoto').onclick = () => {
                alert('üì∑ Capturar tocado');
                capturePhoto();
            };
            document.getElementById('switchCamera').onclick = switchCamera;
            document.getElementById('retakePhoto').onclick = retakePhoto; 
            document.getElementById('processOCR').onclick = () => {
                alert('ü§ñ Procesando...');
                processWithOCR();
            };
            document.getElementById('resetDemo').onclick = resetDemo;
            document.getElementById('saveAmount').onclick = saveAmount;

            // Smart amount suggestions
            document.addEventListener('click', handleSmartAmountClicks);
        }

        // Camera Functions
        async function startCamera() {
            console.log('üéØ startCamera() llamado');
            
            try {
                console.log('üì± Intentando acceder a c√°mara...');
                showStatus('Solicitando permisos de c√°mara...', 'info');
                
                // Constraints optimizados para iOS
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1920, max: 1920 },
                        height: { ideal: 1080, max: 1080 }
                    }
                };

                console.log('üîê Solicitando permisos...');
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('‚úÖ Permisos concedidos');
                const video = document.getElementById('video');
                video.srcObject = videoStream;

                // Show video and controls
                document.getElementById('placeholder').classList.add('hidden');
                video.classList.remove('hidden');
                document.getElementById('cameraControls').classList.add('hidden');
                document.getElementById('activeControls').classList.remove('hidden');

                showStatus('C√°mara activa - Captura tu ticket', 'success');
                
            } catch (error) {
                console.error('‚ùå Error accessing camera:', error);
                
                let errorMessage = 'Error desconocido';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Permisos de c√°mara denegados. Ve a Configuraci√≥n ‚Üí Safari ‚Üí C√°mara';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No se encontr√≥ c√°mara en el dispositivo';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = 'C√°mara no soportada en este navegador';
                } else {
                    errorMessage = error.message;
                }
                
                showStatus('‚ùå ' + errorMessage, 'error');
            }
        }

        async function capturePhoto() {
            try {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');

                // Set canvas size to video dimensions
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // Draw video frame to canvas
                ctx.drawImage(video, 0, 0);

                // Stop video stream
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                }

                // Show canvas, hide video
                video.classList.add('hidden');
                canvas.classList.remove('hidden');

                // Update controls
                document.getElementById('activeControls').classList.add('hidden');
                document.getElementById('retakeControls').classList.remove('hidden');

                // Store image data
                capturedImageData = canvas.toDataURL('image/jpeg', 0.8);

                showStatus('Foto capturada - Presiona "Analizar con IA"', 'success');
                
            } catch (error) {
                console.error('Error capturing photo:', error);
                showStatus('Error al capturar foto: ' + error.message, 'error');
            }
        }

        async function switchCamera() {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                await startCamera();
            }
        }

        function retakePhoto() {
            // Hide results and canvas
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('canvas').classList.add('hidden');
            
            // Show controls to start camera again
            document.getElementById('retakeControls').classList.add('hidden');
            document.getElementById('cameraControls').classList.remove('hidden');
            document.getElementById('placeholder').classList.remove('hidden');

            capturedImageData = null;
            showStatus('Listo para nueva captura', 'info');
        }

        // OCR and AI Processing
        async function processWithOCR() {
            console.log('ü§ñ processWithOCR iniciado');
            
            if (!capturedImageData) {
                alert('‚ùå No hay imagen capturada');
                showStatus('No hay imagen para procesar', 'error');
                return;
            }

            try {
                console.log('üì∏ Imagen disponible, iniciando OCR...');
                showProcessing('üîç Leyendo texto con OCR...');

                // Verificar que Tesseract est√© disponible
                if (typeof Tesseract === 'undefined') {
                    throw new Error('Tesseract no est√° cargado');
                }

                console.log('‚úÖ Tesseract disponible');

                // Process with Tesseract - configuraci√≥n simplificada para iOS
                const { data: { text, confidence } } = await Tesseract.recognize(
                    capturedImageData,
                    'eng', // Solo ingl√©s para mayor compatibilidad iOS
                    {
                        logger: m => {
                            console.log('OCR Progress:', m);
                            if (m.status === 'recognizing text') {
                                const percent = Math.round(m.progress * 100);
                                showProcessing(`üîç Analizando texto... ${percent}%`);
                            }
                        },
                        // Configuraci√≥n espec√≠fica para m√≥viles
                        tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK
                    }
                );

                console.log('‚úÖ OCR completado:', { textLength: text.length, confidence });

                hideProcessing();

                console.log('OCR Result:', { text, confidence });

                if (!text.trim()) {
                    showStatus('No se detect√≥ texto en la imagen', 'error');
                    return;
                }

                // Show OCR results
                showOCRResults(text, confidence);

                // Verificar Smart Amount Detector
                if (!smartAmountDetector) {
                    console.error('‚ùå SmartAmountDetector no inicializado');
                    throw new Error('Sistema de IA no disponible');
                }

                // Process with Smart Amount Detection
                console.log('üß† Analizando montos con IA...');
                const amountAnalysis = smartAmountDetector.analyzeAmounts(text, confidence / 100);
                console.log('‚úÖ An√°lisis IA completado:', amountAnalysis);

                if (amountAnalysis.suggested) {
                    showAmountSuggestions(amountAnalysis);
                    document.getElementById('finalAmount').value = amountAnalysis.suggested.value.toFixed(2);
                    console.log('‚úÖ Sugerencias mostradas');
                } else {
                    showStatus('No se pudieron detectar montos v√°lidos', 'warning');
                    console.log('‚ö†Ô∏è No se detectaron montos');
                }

                // Show results section
                document.getElementById('resultsSection').classList.remove('hidden');
                console.log('‚úÖ Proceso completo exitoso');

            } catch (error) {
                console.error('‚ùå Error completo:', error);
                alert('Error: ' + error.message);
                hideProcessing();
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // UI Helper Functions
        function showProcessing(message) {
            document.getElementById('processingText').textContent = message;
            document.getElementById('processingOverlay').classList.remove('hidden');
        }

        function hideProcessing() {
            document.getElementById('processingOverlay').classList.add('hidden');
        }

        function showOCRResults(text, confidence) {
            document.getElementById('ocrText').textContent = text.substring(0, 300) + '...';
            document.getElementById('ocrResults').classList.remove('hidden');
        }

        function showAmountSuggestions(analysis) {
            const suggestionsDiv = document.getElementById('amountSuggestions');
            const suggestedButton = document.getElementById('suggestedAmount');
            const confidenceSpan = document.getElementById('aiConfidence');
            const alternativesDiv = document.getElementById('alternatives');
            const showAlternativesBtn = document.getElementById('showAlternatives');

            // Show main suggestion
            const suggested = analysis.suggested;
            suggestedButton.querySelector('span').textContent = `$${suggested.value.toFixed(2)}`;
            confidenceSpan.textContent = `${Math.round(analysis.confidence * 100)}%`;

            // Create alternatives
            if (analysis.alternatives && analysis.alternatives.length > 0) {
                alternativesDiv.innerHTML = '';
                
                analysis.alternatives.forEach((alt, index) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'alternative-amount text-xs p-1 bg-gray-100 border border-gray-300 rounded hover:bg-gray-200 transition-colors';
                    button.textContent = `$${alt.value.toFixed(2)}`;
                    button.title = `Confianza: ${Math.round(alt.totalScore || 0)}%`;
                    alternativesDiv.appendChild(button);
                });

                showAlternativesBtn.classList.remove('hidden');
            } else {
                showAlternativesBtn.classList.add('hidden');
            }

            suggestionsDiv.classList.remove('hidden');
        }

        function handleSmartAmountClicks(e) {
            // Main suggestion click
            if (e.target.id === 'suggestedAmount' || e.target.closest('#suggestedAmount')) {
                const button = e.target.closest('#suggestedAmount') || e.target;
                const amount = button.querySelector('span')?.textContent.replace('$', '') || '0';
                document.getElementById('finalAmount').value = amount;
                
                // Visual feedback
                button.classList.add('bg-green-100', 'border-green-400');
                setTimeout(() => {
                    button.classList.remove('bg-green-100', 'border-green-400');
                }, 500);
            }

            // Show alternatives toggle
            if (e.target.id === 'showAlternatives') {
                const alternatives = document.getElementById('alternativeAmounts');
                const button = e.target;
                
                if (alternatives.classList.contains('hidden')) {
                    alternatives.classList.remove('hidden');
                    button.textContent = 'Ocultar alternativas';
                } else {
                    alternatives.classList.add('hidden');
                    button.textContent = 'Ver m√°s opciones detectadas';
                }
            }

            // Alternative amount clicks
            if (e.target.classList.contains('alternative-amount')) {
                const amount = e.target.textContent.replace('$', '');
                document.getElementById('finalAmount').value = amount;
                
                // Visual feedback
                e.target.classList.add('bg-green-100', 'border-green-400');
                setTimeout(() => {
                    e.target.classList.remove('bg-green-100', 'border-green-400');
                }, 500);
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `mt-4 p-3 rounded-lg ${getStatusClass(type)}`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }

        function getStatusClass(type) {
            switch (type) {
                case 'success': return 'bg-green-100 text-green-800 border border-green-200';
                case 'error': return 'bg-red-100 text-red-800 border border-red-200';
                case 'warning': return 'bg-yellow-100 text-yellow-800 border border-yellow-200';
                default: return 'bg-blue-100 text-blue-800 border border-blue-200';
            }
        }

        function resetDemo() {
            // Stop any active streams
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }

            // Reset UI
            document.getElementById('video').classList.add('hidden');
            document.getElementById('canvas').classList.add('hidden');
            document.getElementById('placeholder').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('activeControls').classList.add('hidden');
            document.getElementById('retakeControls').classList.add('hidden');
            document.getElementById('cameraControls').classList.remove('hidden');
            document.getElementById('amountSuggestions').classList.add('hidden');
            document.getElementById('ocrResults').classList.add('hidden');

            // Clear data
            capturedImageData = null;
            document.getElementById('finalAmount').value = '';

            showStatus('Demo reiniciado - Listo para nuevo ticket', 'info');
        }

        function saveAmount() {
            const amount = document.getElementById('finalAmount').value;
            if (amount && parseFloat(amount) > 0) {
                showStatus(`üí∞ Monto confirmado: $${parseFloat(amount).toFixed(2)}`, 'success');
                setTimeout(() => {
                    resetDemo();
                }, 2000);
            } else {
                showStatus('Por favor ingresa un monto v√°lido', 'error');
            }
        }
    </script>
</body>
</html>
