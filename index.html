<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDACONN - Gestor de Gastos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.show { display: flex; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body class="bg-gray-100 m-0 p-0">

    <!-- Header -->
    <nav class="bg-blue-600 text-white p-3">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold">IDACONN - Gestor de Gastos</h1>
                <p class="text-sm opacity-90" id="userInfo">Usuario</p>
            </div>
            <div class="flex items-center gap-2">
                <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 text-sm rounded">
                    <i class="fas fa-download"></i>
                </button>
                <button id="logoutBtn" class="bg-blue-700 hover:bg-blue-800 text-white px-3 py-2 rounded">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Login Screen -->
    <div id="loginScreen" class="p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-auto">
            <div class="text-center mb-6">
                <img src="https://page.gensparksite.com/v1/base64_upload/b2869f30ba62ebf5b884d127f1705e49" 
                     alt="IDACONN Logo" 
                     class="mx-auto mb-4 h-16 w-auto object-contain">
                <h1 class="text-2xl font-bold text-gray-800">Iniciar SesiÃ³n</h1>
            </div>
            
            <form id="loginForm" class="space-y-3">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Email:</label>
                    <input type="email" id="loginEmail" value="ramon.rivas@me.com"
                           class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                           placeholder="usuario@email.com" required>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">ContraseÃ±a:</label>
                    <input type="password" id="loginPassword" value="admin123"
                           class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" 
                           placeholder="********" required>
                </div>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white w-full py-3 rounded-lg">
                    Iniciar SesiÃ³n
                </button>
            </form>
            
            <div class="mt-4 text-center">
                <button id="requestAccessBtn" class="text-sm text-blue-600 hover:text-blue-800 underline">
                    Â¿No tienes cuenta? Solicitar acceso
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="hidden">
        
        <!-- Project Selection - SIN ESPACIOS -->
        <div class="bg-white border-b p-3">
            <h2 class="text-lg font-bold text-gray-800 mb-2">Proyecto</h2>
            <select id="projectSelect" class="w-full px-4 py-3 border rounded-lg">
                <option value="">Seleccionar proyecto...</option>
            </select>
        </div>

        <!-- Quick Actions - SIN ESPACIOS -->
        <div id="actionsCard" class="hidden bg-white border-b p-3">
            <h2 class="text-lg font-bold text-gray-800 mb-2">Acciones</h2>
            <div class="grid grid-cols-2 gap-3">
                <button id="addExpenseBtn" class="bg-blue-500 hover:bg-blue-600 text-white p-3 text-center rounded-lg">
                    <i class="fas fa-receipt text-xl block mb-1"></i>
                    <span class="text-sm">Registrar Gasto</span>
                </button>
                <button id="viewReportsBtn" class="bg-purple-500 hover:bg-purple-600 text-white p-3 text-center rounded-lg">
                    <i class="fas fa-chart-bar text-xl block mb-1"></i>
                    <span class="text-sm">Ver Reportes</span>
                </button>
            </div>
        </div>

        <!-- Admin Actions - SIN ESPACIOS -->
        <div id="adminActionsCard" class="hidden bg-gradient-to-r from-orange-500 to-red-500 text-white border-b p-3">
            <h2 class="text-lg font-bold mb-2">ðŸ”‘ Funciones de Administrador</h2>
            <div class="grid grid-cols-3 gap-2">
                <button id="manageProjectsBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-2 text-center rounded-lg">
                    <i class="fas fa-project-diagram text-lg block mb-1"></i>
                    <span class="text-xs">Proyectos</span>
                </button>
                <button id="manageBudgetsBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-2 text-center rounded-lg">
                    <i class="fas fa-dollar-sign text-lg block mb-1"></i>
                    <span class="text-xs">Presupuestos</span>
                </button>
                <button id="manageUsersBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-2 text-center rounded-lg">
                    <i class="fas fa-users text-lg block mb-1"></i>
                    <span class="text-xs">Usuarios</span>
                </button>
            </div>
        </div>

        <!-- Balance - SIN ESPACIOS -->
        <div id="balanceCard" class="hidden bg-gradient-to-r from-green-500 to-blue-500 text-white border-b p-3">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold">Saldo Disponible</h3>
                <i class="fas fa-wallet text-2xl opacity-70"></i>
            </div>
            <div class="text-3xl font-bold" id="currentBalance">$0.00</div>
            <p class="text-sm opacity-90 mt-1">Presupuesto - Gastos</p>
        </div>

        <!-- Recent Expenses - SIN ESPACIOS -->
        <div id="expensesCard" class="hidden bg-white p-3">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Gastos Recientes</h3>
            <div id="recentExpenses" class="space-y-2">
                <p class="text-gray-500 text-center py-2">No hay gastos registrados</p>
            </div>
        </div>

    </div>

    <!-- Modales y JavaScript aquÃ­ -->
    <!-- [Se mantiene todo el JavaScript existente] -->

    <script>
        // ==================== DATA MANAGEMENT ====================
        class DataManager {
            constructor() {
                this.initializeData();
            }

            initializeData() {
                if (!localStorage.getItem('projects')) {
                    const demoProjects = [
                        { id: '1', name: 'Proyecto Alpha', budget: 50000, created_at: Date.now() },
                        { id: '2', name: 'Proyecto Beta', budget: 30000, created_at: Date.now() }
                    ];
                    localStorage.setItem('projects', JSON.stringify(demoProjects));
                }

                if (!localStorage.getItem('expenses')) {
                    localStorage.setItem('expenses', JSON.stringify([]));
                }

                if (!localStorage.getItem('currentUser')) {
                    const demoUser = { id: '1', email: 'maria@empresa.com', name: 'MarÃ­a GonzÃ¡lez' };
                    localStorage.setItem('currentUser', JSON.stringify(demoUser));
                }
            }

            getProjects() {
                return JSON.parse(localStorage.getItem('projects') || '[]');
            }

            getExpenses() {
                return JSON.parse(localStorage.getItem('expenses') || '[]');
            }

            addExpense(expense) {
                const expenses = this.getExpenses();
                expense.id = Date.now().toString();
                expense.user_id = this.getCurrentUser().id;
                expense.created_at = Date.now();
                expenses.push(expense);
                localStorage.setItem('expenses', JSON.stringify(expenses));
                return expense;
            }

            exportData() {
                const data = {
                    projects: this.getProjects(),
                    expenses: this.getExpenses(),
                    exported_at: new Date().toISOString(),
                    user: this.getCurrentUser()
                };
                return data;
            }

            resetData() {
                localStorage.removeItem('expenses');
                this.initializeData();
            }

            getCurrentUser() {
                return JSON.parse(localStorage.getItem('currentUser') || '{}');
            }

            getProjectBalance(projectId) {
                const project = this.getProjects().find(p => p.id === projectId);
                if (!project) return 0;

                const expenses = this.getExpenses()
                    .filter(e => e.project_id === projectId && e.user_id === this.getCurrentUser().id)
                    .reduce((sum, e) => sum + (e.amount || 0), 0);

                return project.budget - expenses;
            }

            getUserExpenses(projectId = null) {
                const userId = this.getCurrentUser().id;
                let expenses = this.getExpenses().filter(e => e.user_id === userId);
                
                if (projectId) {
                    expenses = expenses.filter(e => e.project_id === projectId);
                }

                return expenses.sort((a, b) => (b.created_at || 0) - (a.created_at || 0));
            }
        }

        // ==================== APP CONTROLLER ====================
        class ExpenseApp {
            constructor() {
                this.data = new DataManager();
                this.currentProject = null;
                this.currentExpenseType = null;
                this.currentXMLData = null;
                this.currentPDFData = null;
                this.currentUser = null;
                this.isAdmin = false;
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadProjects();
                this.showDashboard();
            }

            setupEventListeners() {
                // Login
                document.getElementById('loginForm').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportData());

                // Project selection
                document.getElementById('projectSelect').addEventListener('change', (e) => this.selectProject(e.target.value));

                // Actions
                document.getElementById('addExpenseBtn').addEventListener('click', () => alert('Funcionalidad en desarrollo'));
                document.getElementById('viewReportsBtn').addEventListener('click', () => alert('Funcionalidad en desarrollo'));

                // Request access
                document.getElementById('requestAccessBtn').addEventListener('click', () => alert('Funcionalidad en desarrollo'));
            }

            handleLogin(e) {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value.trim().toLowerCase();
                const password = document.getElementById('loginPassword').value;
                
                // Usuarios predefinidos
                const users = {
                    'ramon.rivas@me.com': { 
                        password: 'admin123', 
                        name: 'RamÃ³n Rivas', 
                        role: 'admin',
                        id: 'admin_001'
                    },
                    'maria@empresa.com': { 
                        password: 'user123', 
                        name: 'MarÃ­a GonzÃ¡lez', 
                        role: 'user',
                        id: 'user_001'
                    }
                };
                
                // Validar credenciales
                const user = users[email];
                if (!user || user.password !== password) {
                    alert('âŒ Credenciales incorrectas');
                    return;
                }
                
                // Guardar usuario actual
                this.currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                this.isAdmin = user.role === 'admin';
                
                // Mostrar dashboard
                this.showDashboard();
                
                // Mensaje de bienvenida
                const welcomeMessage = this.isAdmin ? 
                    `Â¡Bienvenido Administrador ${user.name}! ðŸ‘‘` : 
                    `Â¡Bienvenido ${user.name}! ðŸ‘‹`;
                
                setTimeout(() => alert(welcomeMessage), 500);
            }

            logout() {
                this.showLogin();
            }

            showLogin() {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('dashboardScreen').classList.add('hidden');
                document.querySelector('nav').classList.add('hidden');
            }

            showDashboard() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboardScreen').classList.remove('hidden');
                document.querySelector('nav').classList.remove('hidden');
                
                const user = this.currentUser || this.data.getCurrentUser();
                this.isAdmin = user.role === 'admin';
                
                document.getElementById('userInfo').textContent = `${user.name || user.email}${this.isAdmin ? ' (Admin)' : ''}`;
                
                // Mostrar funciones segÃºn el rol
                if (this.isAdmin) {
                    document.getElementById('adminActionsCard').classList.remove('hidden');
                }
                document.getElementById('actionsCard').classList.remove('hidden');
                
                this.loadProjects();
                this.updateBalance();
                this.loadRecentExpenses();
            }

            loadProjects() {
                const select = document.getElementById('projectSelect');
                const projects = this.data.getProjects();
                
                select.innerHTML = '<option value="">Seleccionar proyecto...</option>';
                projects.forEach(project => {
                    select.innerHTML += `<option value="${project.id}">${project.name}</option>`;
                });
            }

            selectProject(projectId) {
                if (!projectId) {
                    this.currentProject = null;
                    document.getElementById('balanceCard').classList.add('hidden');
                    document.getElementById('expensesCard').classList.add('hidden');
                    return;
                }

                const project = this.data.getProjects().find(p => p.id === projectId);
                this.currentProject = project;
                
                this.updateBalance();
                this.loadRecentExpenses();
                
                document.getElementById('balanceCard').classList.remove('hidden');
                document.getElementById('expensesCard').classList.remove('hidden');
            }

            updateBalance() {
                if (!this.currentProject) return;
                
                const balance = this.data.getProjectBalance(this.currentProject.id);
                document.getElementById('currentBalance').textContent = 
                    `$${balance.toLocaleString('es-MX', { minimumFractionDigits: 2 })}`;
            }

            loadRecentExpenses() {
                if (!this.currentProject) return;

                const expenses = this.data.getUserExpenses(this.currentProject.id).slice(0, 5);
                const container = document.getElementById('recentExpenses');

                if (expenses.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-2">No hay gastos registrados</p>';
                    return;
                }

                container.innerHTML = expenses.map(expense => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <p class="font-medium text-sm">${expense.description || 'Sin descripciÃ³n'}</p>
                            <p class="text-xs text-gray-600">${expense.category} â€¢ ${new Date(expense.expense_date || expense.created_at).toLocaleDateString('es-MX')}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-red-600 text-sm">-$${expense.amount.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                        </div>
                    </div>
                `).join('');
            }

            exportData() {
                try {
                    const data = this.data.exportData();
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `gastos_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    
                } catch (error) {
                    alert('Error al exportar datos: ' + error.message);
                }
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new ExpenseApp();
        });
    </script>

</body>
</html>